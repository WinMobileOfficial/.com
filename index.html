<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GM Agency | Elite POS A-to-Z</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; font-style: italic; transition: 0.3s; }
        .dark-mode { background-color: #0f172a !important; color: white !important; }
        .dark-mode .bg-white, .dark-mode .bg-slate-50 { background-color: #1e293b !important; color: white !important; }
        .dark-mode input { background-color: #0f172a !important; border-color: #334155 !important; color: white !important; }
        
        @media print { 
            body > *:not(#receipt) { display: none !important; } 
            #receipt { display: block !important; width: 80mm; padding: 2mm; color: black; } 
            .no-print { display: none !important; }
            .dashed { border-top: 1px dashed black; margin: 5px 0; }
        }

        #receipt { display: none; font-family: 'Courier New', monospace; line-height: 1.2; }
        .hidden-tab { display: none !important; }
        .tab-btn.active { background-color: #2563eb; color: white; border-radius: 1rem; }
    </style>
</head>
<body id="mainBody" class="bg-slate-100 flex h-screen overflow-hidden">

<div id="lockScreen" class="fixed inset-0 bg-[#0f172a] z-[9999] flex flex-col items-center justify-center text-white">
    <div class="bg-slate-800 p-10 rounded-[3rem] shadow-2xl text-center border-2 border-slate-700 w-80">
        <h1 class="text-2xl font-black mb-4 text-blue-400 italic">GM AGENCY LOCK</h1>
        <input id="accessCode" type="password" placeholder="PIN" class="w-full p-4 rounded-2xl text-black text-center text-3xl font-black mb-4 outline-none border-4 border-blue-500">
        <button onclick="checkAccess()" class="w-full bg-blue-600 py-4 rounded-2xl font-black uppercase shadow-lg hover:bg-blue-700">Unlock System</button>
    </div>
</div>

<div class="w-72 bg-[#0f172a] text-white flex flex-col no-print shadow-2xl">
    <div class="p-8 text-center border-b border-slate-800">
        <h2 id="sideName" class="text-2xl font-black text-blue-400 italic uppercase tracking-tighter">GM AGENCY</h2>
        <p class="text-[9px] text-slate-500 font-bold uppercase mt-1">Professional POS V17</p>
    </div>
    <nav class="p-4 flex-1 space-y-1 font-bold text-sm uppercase italic overflow-y-auto">
        <button onclick="switchTab('billing')" class="tab-btn w-full text-left p-4 hover:bg-slate-800 flex items-center gap-3"><i class="fas fa-file-invoice-dollar w-5"></i> POS Billing</button>
        <button onclick="switchTab('history')" class="tab-btn w-full text-left p-4 hover:bg-slate-800 flex items-center gap-3"><i class="fas fa-history w-5"></i> Bill History</button>
        <button onclick="switchTab('cust')" class="tab-btn w-full text-left p-4 hover:bg-slate-800 flex items-center gap-3"><i class="fas fa-users-cog w-5"></i> Ledger (Udhaar)</button>
        <button onclick="switchTab('products')" class="tab-btn w-full text-left p-4 hover:bg-slate-800 flex items-center gap-3"><i class="fas fa-boxes w-5"></i> Inventory</button>
        <button onclick="switchTab('expenses')" class="tab-btn w-full text-left p-4 hover:bg-slate-800 flex items-center gap-3"><i class="fas fa-wallet w-5"></i> Expenses</button>
        <button onclick="switchTab('reports')" class="tab-btn w-full text-left p-4 hover:bg-slate-800 flex items-center gap-3"><i class="fas fa-chart-line w-5"></i> Reports</button>
        <button onclick="switchTab('settings')" class="tab-btn w-full text-left p-4 hover:bg-slate-800 flex items-center gap-3"><i class="fas fa-cog w-5"></i> Settings</button>
    </nav>
    <div class="p-4"><button onclick="toggleDarkMode()" class="w-full bg-slate-800 py-3 rounded-xl text-[10px] font-black uppercase italic">Toggle Dark Mode</button></div>
</div>

<div class="flex-1 flex flex-col bg-white overflow-hidden relative no-print">
    
    <div id="billingTab" class="flex-1 p-6 flex flex-col gap-4 overflow-hidden">
        <div class="grid grid-cols-3 gap-4">
            <div class="bg-emerald-600 text-white p-5 rounded-[2rem] shadow-lg">
                <p class="text-[10px] font-black uppercase opacity-80">Today's Net Profit</p>
                <h3 class="text-2xl font-black">Rs <span id="dailyProfitVal">0</span></h3>
            </div>
            <div class="bg-indigo-600 text-white p-5 rounded-[2rem] shadow-lg">
                <p class="text-[10px] font-black uppercase opacity-80">Daily Zakat Fund</p>
                <h3 class="text-2xl font-black">Rs <span id="dailyZakatVal">0</span></h3>
            </div>
            <button onclick="receivePayment()" class="bg-slate-900 text-white p-5 rounded-[2rem] shadow-lg flex justify-between items-center border-b-4 border-blue-500 active:scale-95 transition">
                <span class="font-black uppercase italic text-sm text-blue-400">Cash Received Entry</span>
                <i class="fas fa-plus-circle text-2xl"></i>
            </button>
        </div>

        <div class="flex gap-6 flex-1 overflow-hidden">
            <div class="w-80 space-y-4 overflow-y-auto pr-2">
                <div class="bg-slate-50 p-6 rounded-[2.5rem] border shadow-xl">
                    <label class="text-[10px] font-black text-slate-400 ml-2">CUSTOMER INFO</label>
                    <input id="cSearchInput" oninput="searchCustomer(this.value)" placeholder="SEARCH CUSTOMER..." class="w-full border-2 p-4 rounded-2xl mb-2 font-black outline-none uppercase italic focus:border-blue-500">
                    <div id="custSearchList" class="hidden absolute w-64 bg-white border shadow-2xl z-50 max-h-48 overflow-y-auto rounded-xl"></div>
                    
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <input id="cName" readonly placeholder="NAME" class="w-full border p-3 rounded-xl bg-slate-100 font-bold uppercase text-[10px]">
                        <input id="cMob" readonly placeholder="PHONE" class="w-full border p-3 rounded-xl bg-slate-100 font-bold text-[10px]">
                    </div>

                    <div id="prevBalShow" class="bg-amber-50 text-amber-700 p-3 rounded-xl mb-4 hidden border border-amber-200">
                        <p class="text-[10px] font-black text-center italic">Old Balance: Rs <span id="prevBalVal">0</span></p>
                    </div>

                    <label class="text-[10px] font-black text-slate-400 ml-2 uppercase">Order Details</label>
                    <input id="bookerName" placeholder="ENTER BOOKER NAME" class="w-full border-2 p-3 rounded-xl mb-3 font-black uppercase text-xs bg-white outline-none focus:border-blue-500">
                    
                    <input id="pSearch" oninput="filterProducts(this.value)" placeholder="SEARCH PRODUCT..." class="w-full border-2 p-4 rounded-2xl font-black mb-2 outline-none uppercase italic focus:border-blue-500">
                    <div id="searchList" class="hidden absolute w-64 bg-white border shadow-2xl z-50 max-h-48 overflow-y-auto rounded-xl"></div>
                    
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <input id="pPrice" type="number" placeholder="PRICE" class="border-2 p-4 rounded-2xl font-black focus:border-blue-500">
                        <input id="pQty" type="number" value="1" class="border-2 p-4 rounded-2xl font-black bg-blue-50 focus:border-blue-500">
                    </div>
                    <button onclick="addToCart()" class="w-full bg-blue-600 text-white py-5 rounded-2xl font-black uppercase italic shadow-lg hover:bg-blue-700">Add Item</button>
                </div>
            </div>
            
            <div class="flex-1 bg-slate-900 rounded-[3.5rem] flex flex-col text-white shadow-2xl border-8 border-slate-800">
                <div id="cartBody" class="flex-1 p-8 overflow-y-auto space-y-3 font-bold italic uppercase"></div>
                
                <div class="p-8 bg-slate-800/50 backdrop-blur-md">
                    <div class="flex justify-between text-[11px] font-bold text-slate-400 mb-2 px-2 uppercase tracking-widest">
                        <span>Items Sum: <span id="itemsSumDisplay">0</span></span>
                        <span>Tax: 5 | Zakat: <span id="zakatCalcDisplay">0</span></span>
                    </div>

                    <div class="flex justify-between text-5xl font-black text-blue-400 mb-6 italic uppercase">
                        <span>TOTAL:</span><span>Rs <span id="totalDisplay">0</span></span>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <p class="text-[10px] text-slate-400 mb-1 ml-2 font-black">CASH PAID</p>
                            <input id="paidAmt" oninput="calcTotal()" type="number" placeholder="0" class="w-full bg-slate-700 p-5 rounded-2xl text-emerald-400 font-black text-3xl outline-none border-2 border-transparent focus:border-emerald-500">
                        </div>
                        <div>
                            <p class="text-[10px] text-slate-400 mb-1 ml-2 font-black">REMAINING</p>
                            <input id="balAmt" readonly value="0" class="w-full bg-slate-700 p-5 rounded-2xl text-rose-400 font-black text-3xl italic">
                        </div>
                    </div>
                    <button onclick="processBill()" class="w-full bg-emerald-500 hover:bg-emerald-600 py-6 rounded-3xl font-black text-2xl uppercase italic shadow-2xl transition-all flex items-center justify-center gap-3">
                        <i class="fas fa-print"></i> COMPLETE & PRINT
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="historyTab" class="flex-1 p-10 hidden-tab overflow-y-auto">
        <h2 class="text-4xl font-black italic uppercase mb-8 border-b-4 border-blue-500 inline-block">Sale History</h2>
        <div id="historyList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </div>

    <div id="productsTab" class="flex-1 p-10 hidden-tab overflow-y-auto">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-4xl font-black italic uppercase">Inventory Control</h2>
            <button onclick="exportToExcel('prodTable')" class="bg-emerald-600 text-white px-6 py-3 rounded-xl font-bold uppercase text-xs">Export Excel</button>
        </div>
        <div class="bg-white p-8 rounded-[3rem] border shadow-xl mb-8 grid grid-cols-4 gap-4">
            <input id="listPName" placeholder="ITEM NAME" class="p-4 rounded-2xl bg-slate-50 border-2 font-black uppercase italic">
            <input id="listPStock" type="number" placeholder="STOCK" class="p-4 rounded-2xl bg-slate-50 border-2 font-black italic">
            <input id="listPCost" type="number" placeholder="COST PRICE" class="p-4 rounded-2xl bg-slate-50 border-2 font-black text-rose-600 italic">
            <input id="listPPrice" type="number" placeholder="SALE PRICE" class="p-4 rounded-2xl bg-slate-50 border-2 font-black text-emerald-600 italic">
            <button onclick="saveProduct()" class="col-span-4 bg-slate-900 text-white p-5 rounded-2xl font-black uppercase text-xl italic hover:bg-black">Add / Update Product</button>
        </div>
        <div class="bg-white rounded-[2rem] overflow-hidden border shadow-xl">
            <table id="prodTable" class="w-full text-center">
                <thead class="bg-slate-900 text-white uppercase italic text-[11px]">
                    <tr><th class="p-5">Product Name</th><th>In Stock</th><th>Cost</th><th>Sale Price</th><th>Action</th></tr>
                </thead>
                <tbody id="prodListBody" class="font-bold divide-y italic uppercase text-sm"></tbody>
            </table>
        </div>
    </div>

    <div id="custTab" class="flex-1 p-10 hidden-tab overflow-y-auto bg-slate-50">
        <div class="bg-rose-600 text-white p-10 rounded-[3.5rem] shadow-xl mb-8 flex justify-between items-center border-b-8 border-rose-800">
            <div>
                <p class="text-sm font-black uppercase opacity-80 italic tracking-widest">Total Market Credit (Udhari)</p>
                <h2 class="text-6xl font-black italic tracking-tighter">Rs <span id="totalMarketCredit">0</span></h2>
            </div>
            <i class="fas fa-university text-7xl opacity-20"></i>
        </div>
        <div class="mb-6"><input id="ledgerSearch" oninput="renderCustLedger(this.value)" placeholder="Search Customer Ledger..." class="w-full p-5 rounded-2xl border-2 font-black uppercase italic shadow-sm"></div>
        <div id="custLedgerList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
    </div>

    <div id="reportsTab" class="flex-1 p-10 hidden-tab overflow-y-auto">
        <h2 class="text-4xl font-black uppercase mb-10 italic border-b-4 border-emerald-500 inline-block">Analytics</h2>
        <div id="repStats" class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-10 text-white italic font-black uppercase"></div>
        <div class="bg-white p-8 rounded-[3rem] border-2 shadow-2xl">
            <h3 class="text-xl font-black text-blue-600 mb-6 uppercase italic">Top Selling Products</h3>
            <div id="topProductsList" class="space-y-4"></div>
        </div>
    </div>

    <div id="expensesTab" class="flex-1 p-10 hidden-tab overflow-y-auto">
        <h2 class="text-4xl font-black mb-8 uppercase italic border-b-4 border-rose-500 inline-block">Shop Expenses</h2>
        <div class="bg-white p-8 rounded-[2.5rem] shadow-xl border-2 max-w-xl mb-8 flex flex-col gap-4">
            <input id="expNote" placeholder="WHAT WAS THE EXPENSE?" class="p-4 border-2 rounded-2xl font-black uppercase italic">
            <input id="expAmt" type="number" placeholder="AMOUNT" class="p-4 border-2 rounded-2xl font-black text-rose-600 italic">
            <button onclick="addExpense()" class="bg-rose-600 text-white py-5 rounded-2xl font-black uppercase italic shadow-lg hover:bg-rose-700">Record Expense</button>
        </div>
        <div id="expenseList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
    </div>

    <div id="settingsTab" class="flex-1 p-10 hidden-tab overflow-y-auto">
        <h2 class="text-4xl font-black mb-8 uppercase italic border-b-4 border-indigo-600 inline-block">System Settings</h2>
        <div class="max-w-2xl bg-white p-12 rounded-[4rem] shadow-2xl space-y-8 border">
            <div><label class="font-black text-[10px] ml-4 uppercase">Store Name</label><input id="setStoreName" class="w-full p-5 border-2 rounded-3xl font-black uppercase"></div>
            <div><label class="font-black text-[10px] ml-4 uppercase">Contact Info</label><input id="setStorePhone" class="w-full p-5 border-2 rounded-3xl font-black"></div>
            <div><label class="font-black text-[10px] ml-4 uppercase">System Security PIN</label><input id="setStorePIN" type="password" class="w-full p-5 border-2 rounded-3xl font-black"></div>
            <button onclick="saveSettings()" class="w-full bg-slate-900 text-white py-6 rounded-full font-black uppercase italic text-xl shadow-xl hover:bg-black transition">Save All Settings</button>
        </div>
    </div>
</div>

<div id="receipt">
    <center>
        <h1 id="rStoreName" style="font-size: 24px; font-weight: 900; margin-bottom: 2px; text-transform: uppercase;"></h1>
        <p id="rStorePhone" style="font-size: 14px; margin-bottom: 5px;"></p>
        <div class="dashed"></div>
        <p id="rDateTime" style="font-size: 12px; margin-bottom: 5px;"></p>
        <div style="text-align: left; font-size: 13px; font-weight: 900; margin-bottom: 5px;">
            CUSTOMER: <span id="rCustDetails"></span>
        </div>
        <div class="dashed"></div>
    </center>
    <div id="rItemsList" style="margin-bottom: 5px; font-size: 12px; font-weight: bold;"></div>
    <div class="dashed"></div>
    <table style="width: 100%; font-size: 14px; font-weight: bold; border-collapse: collapse;">
        <tr><td style="padding: 2px 0;">ITEMS TOTAL:</td><td style="text-align: right;">Rs <span id="rItemsTotal"></span></td></tr>
        <tr><td style="padding: 2px 0;">FIXED TAX:</td><td style="text-align: right;">Rs 5</td></tr>
        <tr><td style="padding: 2px 0;">ZAKAT (2.5%):</td><td style="text-align: right;">Rs <span id="rZakat"></span></td></tr>
        <tr><td style="padding: 2px 0;">OLD BALANCE:</td><td style="text-align: right;">Rs <span id="rPrevBal"></span></td></tr>
        <tr style="font-size: 18px; border-top: 1px solid black;"><td style="padding: 5px 0;">GRAND TOTAL:</td><td style="text-align: right;">Rs <span id="rGrandTotal"></span></td></tr>
        <tr><td style="padding: 2px 0;">CASH PAID:</td><td style="text-align: right;">Rs <span id="rPaid"></span></td></tr>
        <tr style="border-top: 2px solid black; font-size: 20px;"><td style="padding: 5px 0;">REMAINING:</td><td style="text-align: right;">Rs <span id="rNetBal"></span></td></tr>
    </table>
    <div class="dashed" style="margin-top: 10px;"></div>
    <center>
        <p style="font-size: 14px; font-weight: 900; margin-top: 5px;">BOOKER: <span id="rBooker"></span></p>
        <p style="font-size: 10px; margin-top: 10px;">Thank You For Your Business!</p>
    </center>
    </div>
    <script>
// Final Firebase Configuration
const firebaseConfig = { apiKey: "AIzaSyBP3VrLzUl5AIR2ca1v871cV-cJOMz-SX0", authDomain: "gm-agency-pos.firebaseapp.com", projectId: "gm-agency-pos", storageBucket: "gm-agency-pos.firebasestorage.app", messagingSenderId: "777771332628", appId: "1:777771332628:web:db60e19d9bdcee21f76301" };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let prods = [], customers = {}, sales = [], expenses = [], cart = [];
let settings = { name: "GM AGENCY", phone: "0302-3313131", pin: "0770" };

// Initialization
async function init() {
    const sDoc = await db.collection("settings").doc("main").get();
    if(sDoc.exists) { settings = sDoc.data(); document.getElementById('sideName').innerText = settings.name; }
    
    // Live Data Sync
    db.collection("products").onSnapshot(snap => { prods = snap.docs.map(doc => doc.data()); renderProductList(); updateStats(); });
    db.collection("customers").onSnapshot(snap => { customers = {}; snap.forEach(doc => { customers[doc.id] = doc.data(); }); renderCustLedger(); });
    db.collection("sales").orderBy("timestamp", "desc").onSnapshot(snap => { sales = snap.docs.map(doc => ({id: doc.id, ...doc.data()})); renderHistory(); updateStats(); });
    db.collection("expenses").orderBy("timestamp", "desc").onSnapshot(snap => { expenses = snap.docs.map(doc => ({id: doc.id, ...doc.data()})); renderExpenses(); updateStats(); });
}

// Logic for Calculation (A-Z)
function calcTotal() { 
    let itemsSum = cart.reduce((s, i) => s + i.subtotal, 0); 
    let zakat = Math.round(itemsSum * 0.025); // 2.5% Zakat
    let tax = 5; // Fixed Tax
    let prev = parseFloat(document.getElementById('prevBalVal').innerText) || 0; 
    let grand = itemsSum + tax + zakat + prev; 

    document.getElementById('itemsSumDisplay').innerText = itemsSum.toLocaleString();
    document.getElementById('zakatCalcDisplay').innerText = zakat.toLocaleString();
    document.getElementById('totalDisplay').innerText = Math.round(grand).toLocaleString(); 

    let paid = parseFloat(document.getElementById('paidAmt').value) || 0; 
    document.getElementById('balAmt').value = Math.round(grand - paid); 
}

// Process Bill & Update Firebase
async function processBill() {
    if(!cart.length) return alert("Cart is empty!");
    let mob = document.getElementById('cMob').value || "0000", cName = document.getElementById('cName').value || "WALKING";
    let booker = document.getElementById('bookerName').value || "WALK-IN";
    
    let itemsSum = cart.reduce((s,i)=>s+i.subtotal, 0);
    let tax = 5;
    let zakat = Math.round(itemsSum * 0.025);
    let prev = parseFloat(document.getElementById('prevBalVal').innerText) || 0;
    let grandTotal = itemsSum + tax + zakat + prev;
    let paid = parseFloat(document.getElementById('paidAmt').value) || 0;
    let finalBal = grandTotal - paid;

    let sale = { 
        id: Date.now().toString(), status: "COMPLETED", 
        date: new Date().toLocaleDateString(), time: new Date().toLocaleTimeString(), 
        timestamp: Date.now(), customer: cName, mob, booker, items: [...cart], 
        itemsSum, tax, zakat, prevBal: prev, grandTotal, paid, finalBal 
    };

    // Save Sale
    await db.collection("sales").doc(sale.id).set(sale);
    // Update Ledger
    await db.collection("customers").doc(mob).set({ name: cName, balance: finalBal }, { merge: true });
    // Update Stock
    for(let i of cart) { 
        let p = prods.find(x => x.name.toLowerCase() === i.name.toLowerCase()); 
        if(p) db.collection("products").doc(p.name.toLowerCase()).update({stock: p.stock - i.qty}); 
    }
    
    printReceipt(sale);
    resetBilling();
}

function resetBilling() {
    cart = []; renderCart();
    ['cName','cMob','pSearch','paidAmt','cSearchInput','bookerName','pPrice','pQty'].forEach(id => { 
        if(document.getElementById(id)) {
            document.getElementById(id).value = id === 'pQty' ? "1" : "";
        }
    });
    document.getElementById('prevBalVal').innerText = "0"; 
    document.getElementById('prevBalShow').classList.add('hidden');
}

function printReceipt(s) {
    document.getElementById('rStoreName').innerText = settings.name; 
    document.getElementById('rStorePhone').innerText = settings.phone;
    document.getElementById('rDateTime').innerText = s.date + " " + s.time; 
    document.getElementById('rCustDetails').innerText = `${s.customer} (${s.mob})`;
    document.getElementById('rBooker').innerText = s.booker;
    document.getElementById('rItemsList').innerHTML = (s.items || []).map(i => `<div style="display:flex; justify-content:space-between;"><span>${i.name} x${i.qty}</span><span>${i.subtotal}</span></div>`).join('');
    document.getElementById('rItemsTotal').innerText = s.itemsSum;
    document.getElementById('rZakat').innerText = s.zakat;
    document.getElementById('rPrevBal').innerText = s.prevBal; 
    document.getElementById('rGrandTotal').innerText = s.grandTotal;
    document.getElementById('rPaid').innerText = s.paid; 
    document.getElementById('rNetBal').innerText = s.finalBal;
    window.print();
}

// Stats & Analytics
function updateStats() {
    let today = new Date().toLocaleDateString(), profit = 0, zakatSum = 0;
    let todayExp = expenses.filter(e => e.date === today).reduce((a,b) => a + Number(b.amt), 0);
    
    sales.filter(s => s.status === "COMPLETED" && s.date === today).forEach(s => {
        zakatSum += (s.zakat || 0);
        if(s.items) s.items.forEach(i => {
            let p = prods.find(x => x.name.toLowerCase() === i.name.toLowerCase());
            profit += (Number(i.price) - (p ? Number(p.cost) : Number(i.price))) * i.qty;
        });
    });

    document.getElementById('dailyProfitVal').innerText = (profit - todayExp).toLocaleString();
    document.getElementById('dailyZakatVal').innerText = zakatSum.toLocaleString();
    
    if(!document.getElementById('reportsTab').classList.contains('hidden-tab')) {
        document.getElementById('repStats').innerHTML = `
            <div class="bg-blue-600 p-8 rounded-[2.5rem] shadow-xl"><span>Net Profit</span><h2 class="text-4xl">Rs ${profit - todayExp}</h2></div>
            <div class="bg-indigo-600 p-8 rounded-[2.5rem] shadow-xl"><span>Zakat Fund</span><h2 class="text-4xl">Rs ${zakatSum}</h2></div>
            <div class="bg-rose-600 p-8 rounded-[2.5rem] shadow-xl"><span>Total Expenses</span><h2 class="text-4xl">Rs ${todayExp}</h2></div>
        `;
    }
}
        // UI & Logic Utils
function switchTab(t) { 
    document.querySelectorAll('.flex-1.p-6, .flex-1.p-10').forEach(el => el.classList.add('hidden-tab')); 
    document.getElementById(t+'Tab').classList.remove('hidden-tab'); 
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    event.currentTarget.classList.add('active');
    if(t==='reports') updateStats();
}

function filterProducts(q) { 
    const list = document.getElementById('searchList'); 
    if(!q) { list.classList.add('hidden'); return; } 
    const filtered = prods.filter(p => p.name.toLowerCase().includes(q.toLowerCase())); 
    list.innerHTML = filtered.map(p => `<div class="p-3 border-b cursor-pointer hover:bg-blue-600 hover:text-white font-black flex justify-between uppercase italic" onclick="selectProduct('${p.name}', ${p.price})"><span>${p.name}</span><span class="text-[10px] bg-slate-900 text-white px-2 py-1 rounded">Qty: ${p.stock}</span></div>`).join(''); 
    list.classList.remove('hidden'); 
}

function selectProduct(n, p) { document.getElementById('pSearch').value = n; document.getElementById('pPrice').value = p; document.getElementById('searchList').classList.add('hidden'); document.getElementById('pQty').focus(); }

function addToCart() { 
    let n = document.getElementById('pSearch').value, p = parseFloat(document.getElementById('pPrice').value), q = parseInt(document.getElementById('pQty').value); 
    if(n && p) { cart.push({ name: n, price: p, qty: q, subtotal: p*q }); renderCart(); document.getElementById('pSearch').value = ""; document.getElementById('pSearch').focus(); } 
}

function renderCart() { 
    document.getElementById('cartBody').innerHTML = cart.map((i, idx) => `
        <div class="flex justify-between items-center p-5 bg-slate-800 rounded-2xl border-l-4 border-blue-500">
            <div><p class="text-blue-400 text-[10px] font-black">${i.name}</p><p class="text-lg">Rs ${i.price} x ${i.qty}</p></div>
            <button onclick="cart.splice(${idx}, 1); renderCart()" class="text-rose-500 text-xl"><i class="fas fa-trash"></i></button>
        </div>`).join(''); 
    calcTotal(); 
}

function searchCustomer(q) { 
    const list = document.getElementById('custSearchList'); 
    if(!q) { list.classList.add('hidden'); return; } 
    const ms = Object.keys(customers).filter(k => k.includes(q) || customers[k].name.toLowerCase().includes(q.toLowerCase())); 
    list.innerHTML = ms.map(k => `<div class="p-3 border-b cursor-pointer hover:bg-blue-600 hover:text-white uppercase font-black text-xs italic" onclick="selectCustomer('${k}')">${customers[k].name} (${k})</div>`).join(''); 
    list.classList.remove('hidden'); 
}

function selectCustomer(mob) { 
    document.getElementById('cMob').value = mob; 
    document.getElementById('cName').value = customers[mob].name; 
    document.getElementById('cSearchInput').value = customers[mob].name; 
    document.getElementById('prevBalVal').innerText = customers[mob].balance; 
    document.getElementById('prevBalShow').classList.remove('hidden'); 
    document.getElementById('custSearchList').classList.add('hidden'); 
    calcTotal(); 
}

async function receivePayment() {
    const mob = prompt("Enter Customer Mobile:");
    if(!mob || !customers[mob]) return alert("Customer not found!");
    const amt = Number(prompt(`Current Bal: Rs ${customers[mob].balance}\nEnter Amount Received:`));
    if(amt > 0) {
        const newBal = customers[mob].balance - amt;
        await db.collection("customers").doc(mob).update({balance: newBal});
        await db.collection("sales").add({
            customer: customers[mob].name, mob, itemsSum: 0, grandTotal: 0, paid: amt, finalBal: newBal,
            status: "CASH_RECEIVED", date: new Date().toLocaleDateString(), timestamp: Date.now(), items: [{name: "CASH PAYMENT", subtotal: 0, qty: 1}]
        });
        alert("Payment Recorded Successfully!");
    }
}

function renderProductList() { 
    document.getElementById('prodListBody').innerHTML = prods.map(p => `
        <tr class="border-b"><td class="p-5 font-black text-left">${p.name}</td><td>${p.stock}</td><td>${p.cost}</td><td>${p.price}</td>
        <td><button onclick="deleteProd('${p.name}')" class="text-rose-500"><i class="fas fa-trash"></i></button></td></tr>`).join(''); 
}

async function saveProduct() { 
    let n = document.getElementById('listPName').value.toLowerCase().trim(), s = parseInt(document.getElementById('listPStock').value), c = parseFloat(document.getElementById('listPCost').value), p = parseFloat(document.getElementById('listPPrice').value); 
    if(n) { await db.collection("products").doc(n).set({name:n, stock:s, cost:c, price:p}, {merge:true}); alert("Product Updated!"); } 
}

async function deleteProd(n) { if(confirm("Delete this product?")) await db.collection("products").doc(n.toLowerCase()).delete(); }

function renderHistory() { 
    const completed = sales.filter(s => s.status === "COMPLETED"); 
    document.getElementById('historyList').innerHTML = completed.map(s => `
        <div class="bg-white p-6 rounded-[2.5rem] border shadow-xl flex justify-between items-center">
            <div><b class="uppercase italic text-blue-600">${s.customer}</b><br><small class="font-bold">${s.date} - ${s.booker}</small></div>
            <div class="text-right"><div class="font-black text-xl">Rs ${s.grandTotal}</div>
            <button onclick='printReceipt(${JSON.stringify(s)})' class="text-slate-400 p-2 hover:text-blue-600"><i class="fas fa-print"></i></button></div>
        </div>`).join(''); 
}

function renderCustLedger(filter = "") { 
    const list = document.getElementById('custLedgerList'); list.innerHTML = ""; 
    let marketCredit = 0; 
    Object.keys(customers).forEach(k => { 
        let bal = Number(customers[k].balance) || 0; 
        marketCredit += bal; 
        if(k.includes(filter) || customers[k].name.toLowerCase().includes(filter.toLowerCase())) {
            list.innerHTML += `
                <div class="bg-white p-8 rounded-[3rem] border shadow-xl border-t-8 border-t-rose-500">
                    <b class="uppercase italic text-xl">${customers[k].name}</b><br><small class="text-slate-400 font-bold">${k}</small>
                    <div class="text-4xl font-black text-rose-600 my-4 italic">Rs ${bal.toLocaleString()}</div>
                    <button onclick="selectCustomer('${k}'); switchTab('billing');" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-black uppercase text-xs italic tracking-widest">New Bill</button>
                </div>`; 
        }
    }); 
    document.getElementById('totalMarketCredit').innerText = marketCredit.toLocaleString(); 
}

async function addExpense() { 
    let n = document.getElementById('expNote').value, a = document.getElementById('expAmt').value; 
    if(n && a) { await db.collection("expenses").add({note:n, amt:a, date: new Date().toLocaleDateString(), timestamp: Date.now()}); alert("Expense Saved!"); } 
}

function renderExpenses() { 
    document.getElementById('expenseList').innerHTML = expenses.map(e => `
        <div class="bg-white p-5 rounded-2xl border-l-8 border-rose-500 flex justify-between font-black uppercase italic shadow-sm">
            <span>${e.note}</span><span class="text-rose-600">Rs ${e.amt}</span>
        </div>`).join(''); 
}

function exportToExcel(tableID) {
    let table = document.getElementById(tableID);
    let wb = XLSX.utils.table_to_book(table, {sheet: "Sheet1"});
    XLSX.writeFile(wb, "GM_Agency_Report.xlsx");
}

function checkAccess() { if(document.getElementById('accessCode').value === settings.pin) document.getElementById('lockScreen').style.display='none'; }
async function saveSettings() { settings.name = document.getElementById('setStoreName').value; settings.phone = document.getElementById('setStorePhone').value; settings.pin = document.getElementById('setStorePIN').value; await db.collection("settings").doc("main").set(settings); alert("Settings Updated!"); location.reload(); }
function toggleDarkMode() { document.getElementById('mainBody').classList.toggle('dark-mode'); }

init();
</script>
</body>
</html>
        
