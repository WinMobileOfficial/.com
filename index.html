<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GM Distribution | Master ERP v14</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; font-style: italic; background-color: #f1f5f9; }
        
        #lockScreen { display: flex; align-items: center; justify-content: center; min-height: 100vh; width: 100%; position: fixed; top: 0; left: 0; background: #0f172a; z-index: 10000; }
        .login-card { width: 90%; max-width: 400px; padding: 2.5rem; border-radius: 3rem; background: white; text-align: center; border: 6px solid #2563eb; }

        @media print { 
            body * { visibility: hidden; } 
            #printArea, #printArea * { visibility: visible; } 
            #printArea { position: absolute; left: 0; top: 0; width: 80mm; display: block !important; padding: 2mm; color: black; font-family: 'Courier New', monospace; } 
        }

        .hidden-tab { display: none !important; }
        .nav-active { background: #2563eb !important; color: white !important; shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.4); }
        .main-container { height: 100vh; display: flex; }
        .content-area { flex: 1; overflow-y: auto; padding: 1.5rem; }

        @media (max-width: 768px) {
            .main-container { flex-direction: column; }
            #sidebar { width: 100% !important; height: auto !important; flex-direction: row !important; overflow-x: auto; }
            #sidebar .p-10 { display: none; } /* Hide logo area on mobile nav */
            #sidebar nav { display: flex; flex-direction: row; space-y-0; gap: 10px; padding: 10px; }
            .nav-btn { white-space: nowrap; padding: 10px 20px !important; }
        }
    </style>
</head>
<body>

    <div id="lockScreen">
        <div class="login-card shadow-2xl">
            <h1 class="text-3xl font-black mb-1 uppercase tracking-tighter">GM AGENCY</h1>
            <p class="text-[10px] font-bold text-blue-500 mb-8 uppercase tracking-widest italic">Distribution Master Control</p>
            <input id="accessCode" type="password" placeholder="PIN" class="w-full p-5 rounded-3xl text-center text-4xl font-black mb-6 bg-slate-100 border-b-8 border-blue-600 outline-none focus:bg-white transition-all">
            <button onclick="checkAccess()" class="w-full bg-blue-600 text-white py-5 rounded-3xl font-black uppercase shadow-xl hover:bg-slate-900 transition-all">Unlock System</button>
        </div>
    </div>

    <div class="main-container">
        <div id="sidebar" class="w-72 bg-slate-900 text-white flex flex-col hidden no-print shrink-0">
            <div class="p-8 text-center border-b border-slate-800">
                <img id="sideLogo" class="w-16 h-16 mx-auto mb-3 rounded-xl bg-white p-1 hidden">
                <h2 id="sideName" class="font-black text-blue-400 uppercase italic text-sm">GM AGENCY</h2>
            </div>
            <nav class="p-4 flex-1 space-y-2 font-bold text-[11px] uppercase">
                <button onclick="switchTab('booking')" class="nav-btn w-full text-left p-4 rounded-xl flex items-center gap-3 hover:bg-slate-800 transition-all"><i class="fas fa-plus-circle"></i> New Order</button>
                <button onclick="switchTab('dispatch')" class="nav-btn w-full text-left p-4 rounded-xl flex items-center gap-3 hover:bg-slate-800 transition-all"><i class="fas fa-truck-loading"></i> Dispatch</button>
                <button onclick="switchTab('commission')" class="nav-btn w-full text-left p-4 rounded-xl flex items-center gap-3 hover:bg-slate-800 transition-all"><i class="fas fa-percentage"></i> Commission</button>
                <button onclick="switchTab('inventory')" class="nav-btn w-full text-left p-4 rounded-xl flex items-center gap-3 hover:bg-slate-800 transition-all"><i class="fas fa-boxes"></i> Warehouse</button>
                <button onclick="switchTab('settings')" class="nav-btn w-full text-left p-4 rounded-xl flex items-center gap-3 hover:bg-slate-800 transition-all"><i class="fas fa-cog"></i> Settings</button>
                <button onclick="logout()" class="w-full text-left p-4 text-rose-500 mt-10"><i class="fas fa-lock"></i> Lock System</button>
            </nav>
        </div>

        <div id="mainContent" class="content-area hidden">
            
            <div id="bookingTab" class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                <div class="lg:col-span-4 space-y-4">
                    <div class="bg-white p-6 rounded-[2.5rem] shadow-xl border-2">
                        <h3 class="font-black text-blue-600 uppercase mb-4 italic">Party Details</h3>
                        <input id="cMob" oninput="checkCustomer(this.value)" placeholder="RETAILER PHONE" class="w-full p-4 rounded-2xl bg-slate-100 font-black mb-3 outline-none border-2 border-transparent focus:border-blue-500">
                        <input id="cName" placeholder="SHOP NAME" class="w-full p-4 rounded-2xl bg-slate-100 font-black mb-3 uppercase outline-none">
                        <select id="routeArea" class="w-full p-4 rounded-2xl bg-slate-100 font-black mb-3 outline-none uppercase">
                            <option value="">Select Route</option><option>Main Bazar</option><option>Saddar</option><option>Station</option>
                        </select>
                        <input id="bookerName" placeholder="BOOKER NAME" class="w-full p-4 rounded-2xl bg-slate-100 font-black mb-4 uppercase outline-none">
                        
                        <div id="prevBalBox" class="bg-amber-50 p-4 rounded-2xl mb-4 border border-amber-200 hidden">
                            <p class="text-[10px] font-black uppercase text-amber-600">Previous Balance</p>
                            <p class="text-2xl font-black">Rs <span id="prevBalVal">0</span></p>
                        </div>

                        <div class="relative mb-3">
                            <input id="pSearch" oninput="filterProds(this.value)" placeholder="SEARCH ITEM" class="w-full p-4 rounded-2xl bg-blue-600 text-white font-black uppercase placeholder-blue-300 outline-none">
                            <div id="searchList" class="hidden absolute w-full bg-white border shadow-2xl z-50 rounded-2xl max-h-40 overflow-auto"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-2 mb-4">
                            <input id="pPrice" type="number" placeholder="RATE" class="p-4 rounded-xl bg-slate-100 font-black text-center outline-none">
                            <input id="pQty" type="number" value="1" class="p-4 rounded-xl bg-emerald-50 font-black text-center outline-none">
                        </div>
                        <button onclick="addToCart()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-black uppercase hover:bg-blue-600 transition-all italic">Add Item</button>
                    </div>
                </div>

                <div class="lg:col-span-8">
                    <div class="bg-white rounded-[2.5rem] shadow-2xl flex flex-col overflow-hidden border-8 border-white min-h-[500px]">
                        <div class="bg-slate-800 p-6 text-white flex justify-between">
                            <h3 class="font-black uppercase italic">Current Order List</h3>
                            <span id="cartCount" class="bg-blue-600 px-4 py-1 rounded-full text-[10px] font-black">0 ITEMS</span>
                        </div>
                        <div id="cartBody" class="flex-1 p-6 overflow-y-auto space-y-3"></div>
                        <div class="p-8 bg-slate-50 border-t">
                            <div class="flex justify-between font-black text-3xl mb-6 italic uppercase"><span>Total:</span><span>Rs <span id="totalDisplay">5</span></span></div>
                            <div class="grid grid-cols-2 gap-4 mb-6">
                                <input id="paidAmt" oninput="calcTotal()" type="number" placeholder="RECOVERY" class="p-4 rounded-2xl border-4 border-emerald-500 font-black text-2xl outline-none">
                                <input id="balAmt" readonly placeholder="NEW BAL" class="p-4 rounded-2xl bg-slate-200 font-black text-2xl text-rose-600 outline-none italic">
                            </div>
                            <button onclick="saveOrder()" class="w-full bg-blue-600 text-white py-6 rounded-[2rem] font-black text-2xl uppercase shadow-xl hover:bg-emerald-600 transition-all">Save Pending Order</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="dispatchTab" class="hidden-tab space-y-6">
                <div class="flex justify-between items-center bg-white p-6 rounded-3xl shadow">
                    <h2 class="text-2xl font-black uppercase italic">Loading <span class="text-blue-600">Sheet</span></h2>
                    <button onclick="printLoadingSheet()" class="bg-slate-900 text-white px-6 py-3 rounded-xl font-black uppercase text-xs">Print Loading List</button>
                </div>
                <div id="pendingOrdersList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </div>

            <div id="commissionTab" class="hidden-tab">
                <h2 class="text-3xl font-black mb-8 uppercase italic">Booker Commission</h2>
                <div class="bg-white p-8 rounded-[2.5rem] shadow-xl border-2 mb-8 grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <input id="commBookerName" placeholder="BOOKER NAME" class="p-4 bg-slate-100 rounded-xl font-black uppercase outline-none">
                    <input id="commRate" type="number" value="2" class="p-4 bg-slate-100 rounded-xl font-black outline-none">
                    <button onclick="calculateCommission()" class="bg-emerald-600 text-white py-4 rounded-xl font-black uppercase">Report</button>
                </div>
                <div id="commReport" class="bg-white rounded-[2.5rem] shadow-2xl overflow-hidden hidden border-4 border-white p-10">
                    <div class="grid grid-cols-3 text-center divide-x">
                        <div><p class="text-[10px] font-black text-slate-400 uppercase">Sales</p><h4 id="repTotalSale" class="text-2xl font-black">0</h4></div>
                        <div><p class="text-[10px] font-black text-slate-400 uppercase">Recovery</p><h4 id="repTotalRec" class="text-2xl font-black text-emerald-600">0</h4></div>
                        <div><p class="text-[10px] font-black text-slate-400 uppercase">Earned</p><h4 id="repTotalComm" class="text-2xl font-black text-blue-600">0</h4></div>
                    </div>
                </div>
            </div>

            <div id="inventoryTab" class="hidden-tab">
                <h2 class="text-3xl font-black mb-8 uppercase">Warehouse</h2>
                <div class="bg-white p-8 rounded-[2.5rem] shadow-xl mb-8 grid grid-cols-1 md:grid-cols-4 gap-3">
                    <input id="invName" placeholder="ITEM NAME" class="p-4 bg-slate-100 rounded-xl font-black uppercase outline-none">
                    <input id="invStock" type="number" placeholder="STOCK" class="p-4 bg-slate-100 rounded-xl font-black outline-none">
                    <input id="invPrice" type="number" placeholder="RATE" class="p-4 bg-slate-100 rounded-xl font-black outline-none">
                    <button onclick="saveInventory()" class="bg-slate-900 text-white py-4 rounded-xl font-black uppercase">Update</button>
                </div>
                <div id="inventoryList" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
            </div>

            <div id="settingsTab" class="hidden-tab">
                <div class="max-w-xl bg-white p-10 rounded-[3rem] shadow-xl border-2 space-y-6 mx-auto">
                    <h2 class="text-2xl font-black uppercase text-center italic">ERP Setup</h2>
                    <input id="setDistName" placeholder="AGENCY NAME" class="w-full p-4 bg-slate-100 rounded-xl font-black uppercase">
                    <input id="setDistPhone" placeholder="CONTACT" class="w-full p-4 bg-slate-100 rounded-xl font-black">
                    <input id="setPIN" type="password" value="0770" class="w-full p-4 bg-slate-100 rounded-xl font-black">
                    <button onclick="saveSettings()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black uppercase">Save All</button>
                </div>
            </div>

        </div>
    </div>

    <div id="printArea" style="display:none;">
        <center>
            <h2 id="rName" style="margin: 0; font-size: 18px; font-weight: 900; text-transform: uppercase;"></h2>
            <p id="rPhone" style="font-size: 11px; margin: 2px 0;"></p>
            <div style="border-top:1px dashed #000; margin:5px 0;"></div>
            <p id="rType" style="font-weight: 900; margin: 5px 0; text-transform: uppercase; font-size: 14px;"></p>
        </center>
        <div id="rDetails" style="font-size: 11px; line-height: 1.4;"></div>
        <div style="border-top:1px dashed #000; margin:5px 0;"></div>
        <div id="rItems" style="font-size: 11px;"></div>
        <div style="border-top:1px dashed #000; margin:5px 0;"></div>
        <div id="rTotals" style="text-align: right; font-weight: 900; font-size: 13px;"></div>
        <center><p style="font-size: 9px; margin-top: 10px;">GM AGENCY POS ELITE</p></center>
    </div>

    <script>
        // CONFIG & INIT
        const firebaseConfig = { apiKey: "AIzaSyBP3VrLzUl5AIR2ca1v871cV-cJOMz-SX0", authDomain: "gm-agency-pos.firebaseapp.com", projectId: "gm-agency-pos", storageBucket: "gm-agency-pos.firebasestorage.app", messagingSenderId: "777771332628", appId: "1:777771332628:web:db60e19d9bdcee21f76301" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let prods = [], customers = {}, sales = [], cart = [], settings = { name: "GM DISTRIBUTION", phone: "0300-0000000", pin: "0770" };

        async function init() {
            const sDoc = await db.collection("settings").doc("main").get();
            if(sDoc.exists) settings = sDoc.data();
            applySettings();
            if(localStorage.getItem("gm_auth") === "true") {
                document.getElementById('lockScreen').style.display = 'none';
                document.getElementById('sidebar').classList.remove('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                switchTab('booking');
            }
            db.collection("products").onSnapshot(snap => { prods = snap.docs.map(doc => doc.data()); renderInventory(); });
            db.collection("customers").onSnapshot(snap => { snap.forEach(doc => { customers[doc.id] = doc.data(); }); });
            db.collection("sales").orderBy("timestamp", "desc").onSnapshot(snap => { sales = snap.docs.map(doc => ({id: doc.id, ...doc.data()})); renderPendingOrders(); });
        }

        // AUTH & TABS
        function checkAccess() { if(document.getElementById('accessCode').value === settings.pin) { localStorage.setItem("gm_auth", "true"); location.reload(); } else { alert("WRONG PIN!"); } }
        function logout() { localStorage.removeItem("gm_auth"); location.reload(); }
        function switchTab(t) {
            document.querySelectorAll('#mainContent > div').forEach(div => div.classList.add('hidden-tab'));
            document.getElementById(t + 'Tab').classList.remove('hidden-tab');
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('nav-active'));
            event.currentTarget.classList.add('nav-active');
        }

        // BOOKING LOGIC
        function checkCustomer(mob) {
            if(customers[mob]) {
                document.getElementById('cName').value = customers[mob].name;
                document.getElementById('prevBalVal').innerText = customers[mob].balance;
                document.getElementById('prevBalBox').classList.remove('hidden');
            } else { document.getElementById('prevBalBox').classList.add('hidden'); document.getElementById('prevBalVal').innerText = "0"; }
            calcTotal();
        }

        function filterProds(q) {
            const list = document.getElementById('searchList');
            if(!q) { list.classList.add('hidden'); return; }
            const f = prods.filter(p => p.name.toLowerCase().includes(q.toLowerCase()));
            list.innerHTML = f.map(p => `<div class="p-4 border-b hover:bg-blue-600 hover:text-white cursor-pointer font-black uppercase text-xs" onclick="selectProd('${p.name}', ${p.price})">${p.name} - Rs ${p.price}</div>`).join('');
            list.classList.remove('hidden');
        }

        function selectProd(n, p) { document.getElementById('pSearch').value = n; document.getElementById('pPrice').value = p; document.getElementById('searchList').classList.add('hidden'); }

        function addToCart() {
            const n = document.getElementById('pSearch').value, p = parseFloat(document.getElementById('pPrice').value), q = parseInt(document.getElementById('pQty').value);
            if(n && p) { cart.push({ name: n, price: p, qty: q, subtotal: p*q }); renderCart(); }
        }

        function renderCart() {
            document.getElementById('cartCount').innerText = `${cart.length} ITEMS`;
            document.getElementById('cartBody').innerHTML = cart.map((i, idx) => `
                <div class="flex justify-between items-center p-4 bg-slate-50 rounded-xl border-l-4 border-blue-600 font-black uppercase text-[10px]">
                    <span>${i.name} x${i.qty}</span>
                    <span>Rs ${i.subtotal} <button onclick="cart.splice(${idx},1);renderCart()" class="ml-2 text-rose-500 text-lg">Ã—</button></span>
                </div>`).join('');
            calcTotal();
        }

        function calcTotal() {
            const sum = cart.reduce((a,b) => a+b.subtotal, 0), prev = parseFloat(document.getElementById('prevBalVal').innerText) || 0;
            const grand = sum + prev + 5;
            document.getElementById('totalDisplay').innerText = grand;
            const paid = parseFloat(document.getElementById('paidAmt').value) || 0;
            document.getElementById('balAmt').value = grand - paid;
        }

        async function saveOrder() {
            if(!cart.length) return;
            const order = {
                customer: document.getElementById('cName').value || "Retailer",
                mob: document.getElementById('cMob').value || "0000",
                route: document.getElementById('routeArea').value,
                booker: document.getElementById('bookerName').value,
                items: [...cart], itemsSum: cart.reduce((a,b) => a+b.subtotal, 0),
                prevBal: parseFloat(document.getElementById('prevBalVal').innerText) || 0,
                fee: 5, grandTotal: parseFloat(document.getElementById('totalDisplay').innerText),
                paid: parseFloat(document.getElementById('paidAmt').value) || 0,
                finalBal: parseFloat(document.getElementById('balAmt').value),
                status: "Pending", timestamp: Date.now(), date: new Date().toLocaleDateString()
            };
            await db.collection("sales").add(order);
            alert("Order Saved (Pending)!"); location.reload();
        }

         // DISPATCH & PRINTING
        function renderPendingOrders() {
            const list = document.getElementById('pendingOrdersList');
            const pending = sales.filter(s => s.status === "Pending");
            list.innerHTML = pending.map(s => `
                <div class="bg-white p-5 rounded-2xl shadow border-l-8 border-amber-400 flex justify-between items-center">
                    <div class="text-xs font-black uppercase"><b>${s.customer}</b><br><span class="text-slate-400">${s.route}</span></div>
                    <div class="flex gap-2">
                        <button onclick="dispatchOrder('${s.id}')" class="bg-emerald-600 text-white px-4 py-2 rounded-lg text-[10px] font-black uppercase">Dispatch</button>
                        <button onclick="printBill('${s.id}')" class="bg-slate-100 px-4 py-2 rounded-lg text-[10px] font-black uppercase">Bill</button>
                    </div>
                </div>`).join('');
        }

        async function dispatchOrder(id) {
            const s = sales.find(x => x.id === id);
            for(let i of s.items) {
                const p = prods.find(x => x.name.toLowerCase() === i.name.toLowerCase());
                if(p) await db.collection("products").doc(p.name.toLowerCase()).update({ stock: p.stock - i.qty });
            }
            await db.collection("customers").doc(s.mob).set({ name: s.customer, balance: s.finalBal });
            await db.collection("sales").doc(id).update({ status: "Dispatched" });
            alert("Dispatched!");
        }

        function printBill(id) {
            const s = sales.find(x => x.id === id);
            document.getElementById('rName').innerText = settings.name;
            document.getElementById('rPhone').innerText = settings.phone;
            document.getElementById('rType').innerText = "SALE INVOICE";
            document.getElementById('rDetails').innerHTML = `PARTY: ${s.customer}<br>ROUTE: ${s.route}<br>BOOKER: ${s.booker}<br>DATE: ${s.date}`;
            document.getElementById('rItems').innerHTML = s.items.map(i => `<div style="display:flex;justify-content:space-between"><span>${i.name} x${i.qty}</span><span>${i.subtotal}</span></div>`).join('');
            document.getElementById('rTotals').innerText = `TOTAL: ${s.grandTotal}\nPAID: ${s.paid}\nBAL: ${s.finalBal}`;
            window.print();
        }

        function printLoadingSheet() {
            const pending = sales.filter(s => s.status === "Pending");
            let sum = {}; pending.forEach(o => o.items.forEach(i => sum[i.name] = (sum[i.name] || 0) + i.qty));
            document.getElementById('rName').innerText = settings.name;
            document.getElementById('rType').innerText = "LOADING SHEET";
            document.getElementById('rDetails').innerHTML = `DATE: ${new Date().toLocaleDateString()}<br>TOTAL ORDERS: ${pending.length}`;
            document.getElementById('rItems').innerHTML = Object.keys(sum).map(k => `<div style="display:flex;justify-content:space-between"><span>${k}</span><span>QTY: ${sum[k]}</span></div>`).join('');
            document.getElementById('rTotals').innerText = "";
            window.print();
        }

        // COMMISSION & INVENTORY
        function calculateCommission() {
            const b = document.getElementById('commBookerName').value.toUpperCase();
            const rate = parseFloat(document.getElementById('commRate').value) || 0;
            const bSales = sales.filter(s => s.booker && s.booker.toUpperCase() === b);
            const ts = bSales.reduce((a,c) => a+c.itemsSum, 0), tr = bSales.reduce((a,c) => a+c.paid, 0);
            document.getElementById('repTotalSale').innerText = ts;
            document.getElementById('repTotalRec').innerText = tr;
            document.getElementById('repTotalComm').innerText = ((ts * rate)/100).toFixed(0);
            document.getElementById('commReport').classList.remove('hidden');
        }

        function renderInventory() {
            document.getElementById('inventoryList').innerHTML = prods.map(p => `
                <div class="bg-white p-5 rounded-2xl shadow border uppercase font-black">
                    <p class="text-[10px] text-slate-400">Item</p><b>${p.name}</b>
                    <div class="flex justify-between mt-4"><span>Stock: ${p.stock}</span><span class="text-blue-600">Rs ${p.price}</span></div>
                </div>`).join('');
        }
        async function saveInventory() {
            const n = document.getElementById('invName').value.toLowerCase();
            await db.collection("products").doc(n).set({ name: n, stock: parseInt(document.getElementById('invStock').value), price: parseFloat(document.getElementById('invPrice').value) });
            alert("Warehouse Updated!");
        }

        // SETTINGS
        function applySettings() { document.getElementById('sideName').innerText = settings.name; document.getElementById('setDistName').value = settings.name; document.getElementById('setDistPhone').value = settings.phone; document.getElementById('setPIN').value = settings.pin; }
        async function saveSettings() { settings.name = document.getElementById('setDistName').value; settings.phone = document.getElementById('setDistPhone').value; settings.pin = document.getElementById('setPIN').value; await db.collection("settings").doc("main").set(settings); location.reload(); }

        init();
    </script>
</body>
</html>
