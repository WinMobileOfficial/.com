<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GM Distribution | Master ERP v12</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; font-style: italic; }
        @media print { 
            body * { visibility: hidden; } 
            #printArea, #printArea * { visibility: visible; } 
            #printArea { position: absolute; left: 0; top: 0; width: 80mm; display: block !important; padding: 2mm; color: black; } 
        }
        .hidden-tab { display: none !important; }
        .dashed-line { border-top: 2px dashed black; margin: 8px 0; }
        .tab-active { background: #2563eb !important; color: white !important; }
    </style>
</head>
<body class="bg-slate-100 h-screen flex overflow-hidden">

    <div id="lockScreen" class="fixed inset-0 bg-slate-950 z-[9999] flex items-center justify-center">
        <div class="bg-white p-12 rounded-[4rem] shadow-2xl w-96 text-center border-4 border-blue-600">
            <h1 class="text-3xl font-black mb-2 uppercase tracking-tighter">GM DISTRIBUTION</h1>
            <p class="text-[10px] font-bold text-blue-500 mb-8 uppercase tracking-[0.3em]">Master Access</p>
            <input id="accessCode" type="password" placeholder="ENTER PIN" class="w-full p-5 rounded-3xl text-center text-4xl font-black mb-6 bg-slate-100 outline-none border-b-8 border-blue-600 focus:bg-white transition-all">
            <button onclick="checkAccess()" class="w-full bg-blue-600 text-white py-5 rounded-3xl font-black uppercase shadow-xl hover:bg-slate-900 transition-all">Unlock System</button>
        </div>
    </div>

    <div id="sidebar" class="w-80 bg-slate-900 text-white flex flex-col hidden no-print">
        <div class="p-10 text-center border-b border-slate-800">
            <img id="sideLogo" class="w-20 h-20 mx-auto mb-4 rounded-2xl bg-white p-1 hidden border-2 border-blue-500">
            <h2 id="sideName" class="font-black text-xl text-blue-400 uppercase italic">GM AGENCY</h2>
            <div class="h-1 w-10 bg-blue-500 mx-auto mt-2 rounded-full"></div>
        </div>
        <nav id="navMenu" class="p-6 flex-1 space-y-3 font-bold text-sm uppercase">
            <button onclick="switchTab('booking')" class="nav-btn w-full text-left p-5 rounded-2xl flex items-center gap-4 hover:bg-slate-800 transition-all"><i class="fas fa-plus-circle text-blue-400"></i> New Order</button>
            <button onclick="switchTab('dispatch')" class="nav-btn w-full text-left p-5 rounded-2xl flex items-center gap-4 hover:bg-slate-800 transition-all"><i class="fas fa-truck-loading text-emerald-400"></i> Loading Sheet</button>
            <button onclick="switchTab('commission')" class="nav-btn w-full text-left p-5 rounded-2xl flex items-center gap-4 hover:bg-slate-800 transition-all"><i class="fas fa-percentage text-amber-400"></i> Commission</button>
            <button onclick="switchTab('inventory')" class="nav-btn w-full text-left p-5 rounded-2xl flex items-center gap-4 hover:bg-slate-800 transition-all"><i class="fas fa-boxes text-purple-400"></i> Warehouse</button>
            <button onclick="switchTab('customers')" class="nav-btn w-full text-left p-5 rounded-2xl flex items-center gap-4 hover:bg-slate-800 transition-all"><i class="fas fa-store text-rose-400"></i> Party Ledgers</button>
            <button onclick="switchTab('settings')" class="nav-btn w-full text-left p-5 rounded-2xl flex items-center gap-4 hover:bg-slate-800 transition-all"><i class="fas fa-cog text-slate-400"></i> Settings</button>
        </nav>
        <div class="p-8"><button onclick="logout()" class="w-full p-4 bg-red-950 text-red-500 rounded-2xl font-black uppercase text-[10px] border border-red-900">Lock Access</button></div>
    </div>

    <div id="mainContent" class="flex-1 flex flex-col overflow-hidden hidden">
        
        <div id="bookingTab" class="flex-1 p-8 flex gap-8 overflow-hidden">
            <div class="w-96 space-y-4 overflow-y-auto pr-2">
                <div class="bg-white p-8 rounded-[3.5rem] shadow-2xl border-2">
                    <h3 class="font-black mb-6 text-blue-600 uppercase italic">Entry Details</h3>
                    <input id="cMob" oninput="checkCustomer(this.value)" placeholder="RETAILER PHONE" class="w-full p-4 rounded-2xl bg-slate-100 font-black mb-3 outline-none border-2 border-transparent focus:border-blue-500">
                    <input id="cName" placeholder="SHOP NAME" class="w-full p-4 rounded-2xl bg-slate-100 font-black mb-3 uppercase outline-none">
                    <select id="routeArea" class="w-full p-4 rounded-2xl bg-slate-100 font-black mb-3 outline-none uppercase">
                        <option value="">Select Route</option>
                        <option>Main Bazar</option><option>Saddar Route</option><option>Railway Road</option>
                    </select>
                    <input id="bookerName" placeholder="BOOKER NAME" class="w-full p-4 rounded-2xl bg-slate-100 font-black mb-6 uppercase outline-none">
                    
                    <div id="prevBalBox" class="bg-amber-50 p-5 rounded-3xl mb-6 border-2 border-amber-200 hidden">
                        <p class="text-[10px] font-black uppercase text-amber-600 italic">Party Previous Balance</p>
                        <p class="text-3xl font-black text-amber-900">Rs <span id="prevBalVal">0</span></p>
                    </div>

                    <div class="relative mb-3">
                        <input id="pSearch" oninput="filterProds(this.value)" placeholder="SEARCH PRODUCT" class="w-full p-5 rounded-3xl bg-blue-600 text-white font-black uppercase placeholder-blue-300 outline-none shadow-lg">
                        <div id="searchList" class="hidden absolute w-full bg-white border-2 shadow-2xl z-50 rounded-3xl max-h-52 overflow-auto mt-2"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3 mb-6">
                        <input id="pPrice" type="number" placeholder="RATE" class="p-4 rounded-2xl bg-slate-100 font-black text-center outline-none">
                        <input id="pQty" type="number" value="1" class="p-4 rounded-2xl bg-emerald-50 font-black text-center text-emerald-700 outline-none border-2 border-emerald-200">
                    </div>
                    <button onclick="addToCart()" class="w-full bg-slate-900 text-white py-5 rounded-3xl font-black uppercase tracking-widest hover:bg-blue-600 transition-all">Add To List</button>
                </div>
            </div>

            <div class="flex-1 bg-white rounded-[4rem] shadow-2xl flex flex-col overflow-hidden border-8 border-white">
                <div class="bg-slate-900 p-8 text-white flex justify-between items-center">
                    <h3 class="font-black uppercase tracking-widest italic">Order Items</h3>
                    <span id="cartCount" class="bg-blue-600 px-5 py-2 rounded-full text-xs font-black italic">0 ITEMS</span>
                </div>
                <div id="cartBody" class="flex-1 p-8 overflow-y-auto space-y-4"></div>
                <div class="p-10 bg-slate-50 border-t-4 border-slate-100">
                    <div class="flex justify-between text-slate-500 font-black mb-2 uppercase text-xs"><span>Subtotal</span><span>Rs <span id="itemsSumDisplay">0</span></span></div>
                    <div class="flex justify-between text-rose-500 font-black mb-4 uppercase text-xs"><span>Delivery Fee</span><span>+ Rs 5</span></div>
                    <div class="flex justify-between text-5xl font-black text-slate-900 mb-10 uppercase italic tracking-tighter"><span>Total</span><span>Rs <span id="totalDisplay">5</span></span></div>
                    <div class="grid grid-cols-2 gap-6 mb-8">
                        <div>
                            <label class="text-[10px] font-black text-slate-400 uppercase ml-4">Recovery Cash</label>
                            <input id="paidAmt" oninput="calcTotal()" type="number" class="w-full bg-white border-4 border-slate-200 p-6 rounded-[2.5rem] text-emerald-600 font-black text-4xl outline-none focus:border-emerald-500 transition-all">
                        </div>
                        <div>
                            <label class="text-[10px] font-black text-slate-400 uppercase ml-4">Remaining</label>
                            <input id="balAmt" readonly class="w-full bg-slate-100 p-6 rounded-[2.5rem] text-rose-600 font-black text-4xl outline-none italic">
                        </div>
                    </div>
                    <button onclick="saveOrder()" class="w-full bg-blue-600 text-white py-8 rounded-[3rem] font-black text-3xl uppercase shadow-2xl hover:bg-emerald-600 transition-all italic">Save Order (Pending)</button>
                </div>
            </div>
        </div>

        <div id="commissionTab" class="flex-1 p-10 hidden-tab overflow-y-auto">
            <h2 class="text-4xl font-black mb-10 text-slate-900 uppercase">Booker <span class="text-amber-500">Commission</span></h2>
            <div class="bg-white p-10 rounded-[4rem] shadow-xl border-2 mb-10 grid grid-cols-3 gap-8 items-end">
                <div>
                    <label class="text-[10px] font-black ml-4 uppercase text-slate-400 italic">Salesman Name</label>
                    <input id="commBookerName" placeholder="BOOKER NAME" class="w-full p-5 bg-slate-100 rounded-2xl font-black uppercase outline-none focus:bg-white transition-all">
                </div>
                <div>
                    <label class="text-[10px] font-black ml-4 uppercase text-slate-400 italic">Commission Rate %</label>
                    <input id="commRate" type="number" value="2" class="w-full p-5 bg-slate-100 rounded-2xl font-black outline-none focus:bg-white transition-all">
                </div>
                <button onclick="calculateCommission()" class="bg-slate-900 text-white py-6 rounded-3xl font-black uppercase tracking-widest shadow-xl hover:bg-amber-500 transition-all italic">Run Report</button>
            </div>
            <div id="commReport" class="bg-white rounded-[4rem] shadow-2xl overflow-hidden hidden border-8 border-white">
                <div class="bg-amber-500 p-10 text-white flex justify-between items-center">
                    <div><h3 id="repBookerName" class="text-3xl font-black uppercase italic tracking-tighter">NAME</h3><p class="text-xs font-bold opacity-80 uppercase tracking-widest">Monthly Earnings Summary</p></div>
                    <i class="fas fa-award text-5xl opacity-30"></i>
                </div>
                <div class="grid grid-cols-3 divide-x-2 divide-slate-100">
                    <div class="p-12 text-center"><p class="text-xs font-black text-slate-400 uppercase mb-2 italic">Total Booked Sale</p><h4 class="text-4xl font-black italic" id="repTotalSale">0</h4></div>
                    <div class="p-12 text-center"><p class="text-xs font-black text-slate-400 uppercase mb-2 italic">Total Recovery</p><h4 class="text-4xl font-black text-emerald-600 italic" id="repTotalRec">0</h4></div>
                    <div class="p-12 text-center bg-slate-50"><p class="text-xs font-black text-slate-400 uppercase mb-2 italic">Calculated Commission</p><h4 class="text-4xl font-black text-blue-600 italic" id="repTotalComm">0</h4></div>
                </div>
            </div>
        </div>

        <div id="dispatchTab" class="flex-1 p-10 hidden-tab overflow-y-auto">
            <div class="flex justify-between items-center mb-10">
                <h2 class="text-4xl font-black text-slate-900 uppercase italic">Loading <span class="text-emerald-600">& Dispatch</span></h2>
                <button onclick="printLoadingSheet()" class="bg-slate-900 text-white px-10 py-4 rounded-2xl font-black uppercase text-xs shadow-xl italic tracking-widest"><i class="fas fa-print mr-2"></i> Print Loading Sheet</button>
            </div>
            <div id="pendingOrdersList" class="grid grid-cols-1 gap-6"></div>
        </div>

        <div id="inventoryTab" class="flex-1 p-10 hidden-tab overflow-y-auto">
            <h2 class="text-4xl font-black mb-10 text-slate-900 uppercase">Warehouse <span class="text-purple-600">Stock</span></h2>
            <div class="bg-white p-10 rounded-[4rem] shadow-xl border-2 mb-10 grid grid-cols-4 gap-4">
                <input id="invName" placeholder="ITEM NAME" class="p-5 bg-slate-100 rounded-2xl font-black uppercase outline-none">
                <input id="invStock" type="number" placeholder="STOCK QTY" class="p-5 bg-slate-100 rounded-2xl font-black outline-none">
                <input id="invCost" type="number" placeholder="COST RATE" class="p-5 bg-slate-100 rounded-2xl font-black text-rose-600 outline-none">
                <input id="invPrice" type="number" placeholder="SALE RATE" class="p-5 bg-slate-100 rounded-2xl font-black text-emerald-600 outline-none">
                <button onclick="saveInventory()" class="col-span-4 bg-slate-900 text-white py-6 rounded-3xl font-black uppercase italic tracking-widest hover:bg-purple-600 transition-all">Sync To Warehouse</button>
            </div>
            <div id="inventoryList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"></div>
        </div>

        <div id="settingsTab" class="flex-1 p-10 hidden-tab overflow-y-auto">
            <h2 class="text-4xl font-black mb-10 text-slate-900 uppercase italic tracking-tighter">ERP <span class="text-indigo-600">Configuration</span></h2>
            <div class="max-w-2xl bg-white p-12 rounded-[4rem] shadow-2xl border-4 border-white space-y-8">
                <div class="flex items-center gap-10 bg-slate-50 p-8 rounded-[3rem]">
                    <img id="logoPrev" class="w-28 h-28 rounded-3xl shadow-lg bg-white p-2 object-contain hidden border-2 border-slate-200">
                    <div class="flex-1 space-y-3">
                        <p class="font-black uppercase text-[10px] text-slate-400 italic">Agency Branding Logo</p>
                        <input type="file" id="logoFile" class="hidden" onchange="handleLogo(this)">
                        <label for="logoFile" class="inline-block bg-slate-900 text-white px-8 py-3 rounded-xl text-[10px] font-black cursor-pointer uppercase italic">Upload Logo</label>
                    </div>
                </div>
                <input id="setDistName" placeholder="DISTRIBUTOR FULL NAME" class="w-full p-5 bg-slate-100 rounded-2xl font-black uppercase outline-none">
                <input id="setDistPhone" placeholder="WHATSAPP / CONTACT" class="w-full p-5 bg-slate-100 rounded-2xl font-black outline-none">
                <input id="setPIN" type="password" placeholder="SYSTEM ACCESS PIN" class="w-full p-5 bg-slate-100 rounded-2xl font-black outline-none">
                <button onclick="saveSettings()" class="w-full bg-indigo-600 text-white py-6 rounded-[2.5rem] font-black uppercase text-xl shadow-xl hover:bg-slate-900 transition-all italic tracking-widest">Deploy Settings</button>
            </div>
        </div>
    </div>

    <div id="printArea" style="display:none; line-height: 1.2;">
        <center>
            <img id="rLogo" style="width: 60px; height: 60px; object-fit: contain; margin-bottom: 5px; display: none;">
            <h1 id="rName" style="font-size: 18px; margin: 0; font-weight: 900; letter-spacing: -1px; text-transform: uppercase;"></h1>
            <p id="rPhone" style="font-size: 11px; margin: 2px 0;"></p>
            <div class="dashed-line"></div>
            <p id="rType" style="font-weight: 900; margin: 5px 0; text-transform: uppercase; font-size: 14px;"></p>
        </center>
        <div id="rDetails" style="font-size: 11px; line-height: 1.5; font-weight: bold;"></div>
        <div class="dashed-line"></div>
        <div id="rItems" style="font-size: 11px;"></div>
        <div class="dashed-line"></div>
        <div id="rTotals" style="text-align: right; font-weight: 900; font-size: 13px; line-height: 1.6;"></div>
        <center>
            <div class="dashed-line" style="margin-top:10px;"></div>
            <p style="font-size: 9px; margin-top: 5px; font-weight: bold;">THANK YOU - GM AGENCY ELITE POS</p>
        </center>
    </div>

    <script>
        // --- FIREBASE & CONFIG ---
        const firebaseConfig = { apiKey: "AIzaSyBP3VrLzUl5AIR2ca1v871cV-cJOMz-SX0", authDomain: "gm-agency-pos.firebaseapp.com", projectId: "gm-agency-pos", storageBucket: "gm-agency-pos.firebasestorage.app", messagingSenderId: "777771332628", appId: "1:777771332628:web:db60e19d9bdcee21f76301" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let prods = [], customers = {}, sales = [], cart = [], settings = { name: "GM DISTRIBUTION", phone: "0300-0000000", pin: "0770", logo: "" };

        async function init() {
            const sDoc = await db.collection("settings").doc("main").get();
            if(sDoc.exists) settings = sDoc.data();
            applySettings();
            
            if(localStorage.getItem("gm_auth") === "true") {
                document.getElementById('lockScreen').classList.add('hidden');
                document.getElementById('sidebar').classList.remove('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                switchTab('booking');
            }

            db.collection("products").onSnapshot(snap => { prods = snap.docs.map(doc => doc.data()); renderInventory(); });
            db.collection("customers").onSnapshot(snap => { snap.forEach(doc => { customers[doc.id] = doc.data(); }); });
            db.collection("sales").orderBy("timestamp", "desc").onSnapshot(snap => { sales = snap.docs.map(doc => ({id: doc.id, ...doc.data()})); renderPendingOrders(); });
        }

        // --- AUTH & NAV ---
        function checkAccess() { if(document.getElementById('accessCode').value === settings.pin) { localStorage.setItem("gm_auth", "true"); location.reload(); } else { alert("ACCESS DENIED!"); } }
        function logout() { localStorage.removeItem("gm_auth"); location.reload(); }
        function switchTab(t) { 
            document.querySelectorAll('.flex-1, .hidden-tab').forEach(el => el.classList.add('hidden-tab')); 
            document.getElementById(t+'Tab').classList.remove('hidden-tab');
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('tab-active'));
        }

        // --- BILLING ENGINE ---
        function checkCustomer(mob) {
            if(customers[mob]) {
                document.getElementById('cName').value = customers[mob].name;
                document.getElementById('prevBalVal').innerText = customers[mob].balance;
                document.getElementById('prevBalBox').classList.remove('hidden');
            } else {
                document.getElementById('cName').value = ""; document.getElementById('prevBalVal').innerText = "0";
                document.getElementById('prevBalBox').classList.add('hidden');
            }
            calcTotal();
        }

        function filterProds(q) {
            const list = document.getElementById('searchList');
            if(!q) { list.classList.add('hidden'); return; }
            const f = prods.filter(p => p.name.toLowerCase().includes(q.toLowerCase()));
            list.innerHTML = f.map(p => `<div class="p-5 border-b hover:bg-blue-600 hover:text-white cursor-pointer font-black uppercase italic text-sm flex justify-between" onclick="selectProd('${p.name}', ${p.price})"><span>${p.name}</span><span>Rs ${p.price}</span></div>`).join('');
            list.classList.remove('hidden');
        }

        function selectProd(n, p) { document.getElementById('pSearch').value = n; document.getElementById('pPrice').value = p; document.getElementById('searchList').classList.add('hidden'); document.getElementById('pQty').focus(); }

        function addToCart() {
            const n = document.getElementById('pSearch').value, p = parseFloat(document.getElementById('pPrice').value), q = parseInt(document.getElementById('pQty').value);
            if(n && p) { cart.push({ name: n, price: p, qty: q, subtotal: p*q }); renderCart(); document.getElementById('pSearch').value = ""; }
        }

        function renderCart() {
            document.getElementById('cartCount').innerText = `${cart.length} ITEMS`;
            document.getElementById('cartBody').innerHTML = cart.map((i, idx) => `
                <div class="flex justify-between items-center p-6 bg-slate-50 rounded-[2rem] border-l-8 border-blue-600 font-black uppercase text-xs">
                    <div><p>${i.name}</p><p class="text-blue-500 font-bold">RATE: ${i.price} x QTY: ${i.qty}</p></div>
                    <div class="flex items-center gap-6"><span class="text-lg italic">Rs ${i.subtotal}</span><button onclick="cart.splice(${idx},1);renderCart()" class="text-rose-500"><i class="fas fa-times-circle text-2xl"></i></button></div>
                </div>`).join('');
            calcTotal();
        }

        function calcTotal() {
            const sum = cart.reduce((a,b) => a+b.subtotal, 0), prev = parseFloat(document.getElementById('prevBalVal').innerText) || 0;
            const grand = sum + prev + 5;
            document.getElementById('itemsSumDisplay').innerText = sum;
            document.getElementById('totalDisplay').innerText = grand;
            const paid = parseFloat(document.getElementById('paidAmt').value) || 0;
            document.getElementById('balAmt').value = (grand - paid).toFixed(0);
        }

        async function saveOrder() {
            if(!cart.length) return;
            const order = {
                customer: document.getElementById('cName').value || "General Party",
                mob: document.getElementById('cMob').value || "0000",
                route: document.getElementById('routeArea').value,
                booker: document.getElementById('bookerName').value,
                items: [...cart],
                itemsSum: cart.reduce((a,b) => a+b.subtotal, 0),
                prevBal: parseFloat(document.getElementById('prevBalVal').innerText) || 0,
                fee: 5,
                grandTotal: parseFloat(document.getElementById('totalDisplay').innerText),
                paid: parseFloat(document.getElementById('paidAmt').value) || 0,
                finalBal: parseFloat(document.getElementById('balAmt').value),
                status: "Pending", timestamp: Date.now(), date: new Date().toLocaleDateString()
            };
            await db.collection("sales").add(order);
            alert("✅ ORDER BOOKED AS PENDING!"); location.reload();
        }

        // --- DISPATCH & LOADING ---
        function renderPendingOrders() {
            const container = document.getElementById('pendingOrdersList');
            const pending = sales.filter(s => s.status === "Pending");
            container.innerHTML = pending.map(s => `
                <div class="bg-white p-8 rounded-[2.5rem] shadow-xl flex justify-between items-center border-l-[12px] border-amber-400">
                    <div><b class="uppercase font-black text-xl italic">${s.customer}</b><br><small class="uppercase font-bold text-slate-400 italic">${s.route} | Booker: ${s.booker}</small></div>
                    <div class="flex gap-4">
                        <button onclick="dispatchOrder('${s.id}')" class="bg-emerald-600 text-white px-8 py-3 rounded-2xl font-black uppercase text-xs shadow-lg hover:bg-slate-900 transition-all italic">Dispatch Now</button>
                        <button onclick="printBill('${s.id}')" class="bg-slate-100 px-6 py-3 rounded-2xl font-black uppercase text-xs italic hover:bg-blue-600 hover:text-white transition-all">Invoice</button>
                    </div>
                </div>`).join('');
        }

        async function dispatchOrder(id) {
            const order = sales.find(s => s.id === id);
            for(let item of order.items) {
                const p = prods.find(x => x.name.toLowerCase() === item.name.toLowerCase());
                if(p) await db.collection("products").doc(p.name.toLowerCase()).update({ stock: p.stock - item.qty });
            }
            await db.collection("customers").doc(order.mob).set({ name: order.customer, balance: order.finalBal });
            await db.collection("sales").doc(id).update({ status: "Dispatched" });
            alert("✅ DISPATCHED & STOCK UPDATED!");
        }

        function printLoadingSheet() {
            const pending = sales.filter(s => s.status === "Pending");
            let summary = {};
            pending.forEach(s => { s.items.forEach(i => { summary[i.name] = (summary[i.name] || 0) + i.qty; }); });
            document.getElementById('rName').innerText = settings.name;
            document.getElementById('rType').innerText = "LOADING SHEET";
            document.getElementById('rDetails').innerHTML = `DATE: ${new Date().toLocaleDateString()}<br>TOTAL ORDERS: ${pending.length}`;
            document.getElementById('rItems').innerHTML = Object.keys(summary).map(k => `<div style="display:flex;justify-content:space-between"><span>${k}</span><span>QTY: ${summary[k]}</span></div>`).join('');
            document.getElementById('rTotals').innerText = "";
            window.print();
        }

        function printBill(id) {
            const s = sales.find(x => x.id === id);
            document.getElementById('rName').innerText = settings.name;
            document.getElementById('rPhone').innerText = settings.phone;
            document.getElementById('rType').innerText = "SALE INVOICE";
            document.getElementById('rDetails').innerHTML = `PARTY: ${s.customer}<br>ROUTE: ${s.route}<br>BOOKER: ${s.booker}<br>DATE: ${s.date}`;
            document.getElementById('rItems').innerHTML = s.items.map(i => `<div style="display:flex;justify-content:space-between"><span>${i.name} x${i.qty}</span><span>${i.subtotal}</span></div>`).join('');
            document.getElementById('rTotals').innerText = `ITEMS: RS ${s.itemsSum}\nFEE: RS 5\nOLD BAL: RS ${s.prevBal}\nGRAND: RS ${s.grandTotal}\nPAID: RS ${s.paid}\nBALANCE: RS ${s.finalBal}`;
            if(settings.logo) { document.getElementById('rLogo').src = settings.logo; document.getElementById('rLogo').style.display = "block"; }
            window.print();
        }

        // --- COMMISSION ---
        function calculateCommission() {
            const booker = document.getElementById('commBookerName').value.toUpperCase();
            const rate = parseFloat(document.getElementById('commRate').value) || 0;
            if(!booker) return;
            const bSales = sales.filter(s => s.booker && s.booker.toUpperCase() === booker);
            const totalS = bSales.reduce((a, b) => a + (b.itemsSum || 0), 0);
            const totalR = bSales.reduce((a, b) => a + (b.paid || 0), 0);
            document.getElementById('repBookerName').innerText = booker;
            document.getElementById('repTotalSale').innerText = "Rs " + totalS;
            document.getElementById('repTotalRec').innerText = "Rs " + totalR;
            document.getElementById('repTotalComm').innerText = "Rs " + ((totalS * rate) / 100).toFixed(0);
            document.getElementById('commReport').classList.remove('hidden');
        }

        // --- INVENTORY ---
        function renderInventory() {
            document.getElementById('inventoryList').innerHTML = prods.map(p => `
                <div class="bg-white p-8 rounded-[2.5rem] shadow-xl border-4 border-white italic">
                    <b class="uppercase text-slate-900 text-lg">${p.name}</b>
                    <div class="flex justify-between mt-6 items-end">
                        <div><p class="text-[10px] font-black text-slate-400 uppercase">Stock</p><p class="text-2xl font-black">${p.stock}</p></div>
                        <div class="text-right"><p class="text-[10px] font-black text-slate-400 uppercase">Rate</p><p class="text-xl font-black text-blue-600">Rs ${p.price}</p></div>
                    </div>
                </div>`).join('');
        }
        async function saveInventory() {
            const n = document.getElementById('invName').value.toLowerCase().trim(), s = parseInt(document.getElementById('invStock').value), c = parseFloat(document.getElementById('invCost').value), p = parseFloat(document.getElementById('invPrice').value);
            if(n) await db.collection("products").doc(n).set({name:n, stock:s, cost:c, price:p});
            alert("STOCK SYNCED!");
        }

        // --- SETTINGS & LOGO ---
        function handleLogo(input) { if (input.files && input.files[0]) { const r = new FileReader(); r.onload = e => { settings.logo = e.target.result; document.getElementById('logoPrev').src = e.target.result; document.getElementById('logoPrev').classList.remove('hidden'); }; r.readAsDataURL(input.files[0]); } }
        function applySettings() { document.getElementById('sideName').innerText = settings.name; document.getElementById('setDistName').value = settings.name; document.getElementById('setDistPhone').value = settings.phone; document.getElementById('setPIN').value = settings.pin; if(settings.logo) { document.getElementById('logoPrev').src = settings.logo; document.getElementById('logoPrev').classList.remove('hidden'); } }
        async function saveSettings() { settings.name = document.getElementById('setDistName').value; settings.phone = document.getElementById('setDistPhone').value; settings.pin = document.getElementById('setPIN').value; await db.collection("settings").doc("main").set(settings); alert("ERP SETTINGS UPDATED!"); location.reload(); }

        init();
    </script>
</body>
</html>
