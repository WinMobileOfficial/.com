<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AL-HAFIZ TRADERS | V4.0</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&display=swap');
        body { font-family: 'Outfit', sans-serif; background: #f8fafc; }
        .tab-content { display: none; padding-bottom: 100px; }
        .active { display: block; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #lockScreen { position: fixed; inset: 0; background: #0f172a; z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .pin-dot { width: 14px; height: 14px; border: 2px solid #3b82f6; border-radius: 50%; transition: 0.2s; }
        .pin-dot.filled { background: #3b82f6; }
        .numpad { display: grid; grid-cols: 3; gap: 20px; margin-top: 40px; }
        .num-btn { width: 70px; height: 70px; background: rgba(255,255,255,0.05); color: white; border-radius: 50%; display: flex; items-center; justify-content: center; font-size: 1.5rem; font-weight: 700; cursor: pointer; transition: 0.2s; }
        .num-btn:active { background: #3b82f6; transform: scale(0.9); }
    </style>
</head>
<body>

<div id="lockScreen">
    <div class="text-center">
        <div class="bg-blue-500/10 p-5 rounded-full mb-6 inline-block">
            <i class="fa-solid fa-shield-halved text-blue-500 text-4xl"></i>
        </div>
        <h2 class="text-white font-black tracking-widest uppercase text-sm mb-8">Enter Access PIN</h2>
        <div class="flex gap-5 justify-center" id="pinDisplay">
            <div class="pin-dot"></div>
            <div class="pin-dot"></div>
            <div class="pin-dot"></div>
            <div class="pin-dot"></div>
        </div>
    </div>
    
    <div class="grid grid-cols-3 gap-6 mt-12">
        <div class="num-btn" onclick="addDigit('1')">1</div>
        <div class="num-btn" onclick="addDigit('2')">2</div>
        <div class="num-btn" onclick="addDigit('3')">3</div>
        <div class="num-btn" onclick="addDigit('4')">4</div>
        <div class="num-btn" onclick="addDigit('5')">5</div>
        <div class="num-btn" onclick="addDigit('6')">6</div>
        <div class="num-btn" onclick="addDigit('7')">7</div>
        <div class="num-btn" onclick="addDigit('8')">8</div>
        <div class="num-btn" onclick="addDigit('9')">9</div>
        <div></div>
        <div class="num-btn" onclick="addDigit('0')">0</div>
        <div class="num-btn text-rose-500" onclick="resetPin()"><i class="fa-solid fa-rotate-right"></i></div>
    </div>
</div>

<div id="mainApp" class="max-w-md mx-auto min-h-screen hidden relative">
    <div class="bg-[#0f172a] p-6 text-white rounded-b-[3.5rem] shadow-2xl">
        <div class="flex justify-between items-center mb-6 px-2">
            <div>
                <h1 class="text-xl font-black italic tracking-tighter">AL-HAFIZ <span class="text-blue-500">TRADERS</span></h1>
                <p id="liveDate" class="text-[9px] text-slate-400 font-bold uppercase mt-1"></p>
            </div>
            <div class="text-right">
                <div class="flex items-center gap-2 bg-white/5 px-3 py-1 rounded-full">
                    <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
                    <span class="text-[9px] font-black text-slate-300">LIVE GPS</span>
                </div>
            </div>
        </div>

        <div class="bg-white/5 backdrop-blur-xl rounded-[2.5rem] p-5 border border-white/10">
            <div class="grid grid-cols-2 gap-4 mb-4 border-b border-white/5 pb-4">
                <div>
                    <p class="text-[8px] text-blue-400 font-black uppercase mb-1">Stock Assets</p>
                    <p class="text-lg font-black" id="totalAsset">Rs 0</p>
                </div>
                <div class="text-right">
                    <p class="text-[8px] text-yellow-500 font-black uppercase mb-1">Zakat (2.5%)</p>
                    <p class="text-lg font-black text-yellow-500" id="zakatVal">Rs 0</p>
                </div>
            </div>
            <div class="flex justify-between items-center">
                <p class="text-[8px] text-emerald-400 font-black uppercase">Today's Total</p>
                <p class="text-xl font-black text-emerald-400" id="todaySale">Rs 0</p>
            </div>
        </div>
    </div>

    <div class="p-5 mt-4">
        
        <div id="homeTab" class="tab-content active">
            <div class="grid grid-cols-3 gap-6">
                <div onclick="showTab('orderTab')" class="flex flex-col items-center">
                    <div class="w-16 h-16 bg-white rounded-3xl flex items-center justify-center text-blue-600 shadow-xl border border-slate-50"><i class="fa-solid fa-cart-plus text-xl"></i></div>
                    <span class="text-[9px] font-black text-slate-500 mt-3 uppercase">New Order</span>
                </div>
                <div onclick="showTab('returnTab')" class="flex flex-col items-center">
                    <div class="w-16 h-16 bg-white rounded-3xl flex items-center justify-center text-rose-500 shadow-xl border border-slate-50"><i class="fa-solid fa-box-open text-xl"></i></div>
                    <span class="text-[9px] font-black text-slate-500 mt-3 uppercase">Returns</span>
                </div>
                <div onclick="showTab('recoveryTab')" class="flex flex-col items-center">
                    <div class="w-16 h-16 bg-white rounded-3xl flex items-center justify-center text-emerald-600 shadow-xl border border-slate-50"><i class="fa-solid fa-hand-holding-dollar text-xl"></i></div>
                    <span class="text-[9px] font-black text-slate-500 mt-3 uppercase">Recovery</span>
                </div>
            </div>
        </div>

        <div id="orderTab" class="tab-content space-y-4">
            <div class="bg-white p-5 rounded-[2.5rem] shadow-sm border">
                <div class="flex justify-between mb-4">
                    <button onclick="toggleNewShop(false)" id="oldBtn" class="bg-blue-600 text-white px-4 py-2 rounded-2xl text-[10px] font-black uppercase">Old Shop</button>
                    <button onclick="toggleNewShop(true)" id="newBtn" class="bg-slate-100 text-slate-400 px-4 py-2 rounded-2xl text-[10px] font-black uppercase">+ New Shop</button>
                </div>

                <div id="shopSearchDiv">
                    <input id="shopSearch" oninput="searchShop(this.value)" placeholder="SEARCH SHOP..." class="w-full p-4 bg-slate-50 rounded-2xl font-black text-xs outline-none border focus:border-blue-500 uppercase italic">
                    <div id="shopResults" class="hidden mt-2 bg-white shadow-2xl rounded-2xl max-h-40 overflow-y-auto border-2 border-blue-50"></div>
                </div>

                <div id="newShopDiv" class="hidden space-y-2">
                    <input id="nSName" placeholder="SHOP NAME" class="w-full p-4 bg-blue-50 rounded-2xl font-black text-xs outline-none uppercase">
                    <input id="nSPhone" placeholder="PHONE NUMBER" class="w-full p-4 bg-blue-50 rounded-2xl font-black text-xs outline-none">
                </div>
            </div>

            <div class="bg-white p-5 rounded-[2.5rem] shadow-sm border">
                <input id="pSearch" oninput="filterProds(this.value)" placeholder="SELECT ITEM..." class="w-full p-4 bg-slate-50 rounded-2xl font-black text-xs outline-none border focus:border-emerald-500 uppercase italic">
                <div id="pResults" class="hidden mt-2 bg-white shadow-2xl rounded-2xl max-h-40 overflow-y-auto border-2 border-emerald-50"></div>
                
                <div class="flex gap-3 mt-4">
                    <input id="pQty" type="number" value="1" class="flex-1 p-4 bg-slate-100 rounded-2xl font-black text-center outline-none">
                    <button onclick="addToCart()" class="bg-slate-900 text-white px-8 rounded-2xl font-black text-[10px] uppercase">ADD</button>
                </div>
                <div id="cartBox" class="mt-4 space-y-2"></div>
            </div>

            <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border text-center">
                <div onclick="triggerCam()" id="photoBox" class="w-full h-32 bg-slate-50 border-4 border-dashed border-slate-100 rounded-[2rem] flex flex-col items-center justify-center mb-6 overflow-hidden">
                    <img id="prevImg" class="hidden w-full h-full object-cover">
                    <div id="camText"><i class="fa-solid fa-camera text-2xl text-slate-300"></i><p class="text-[8px] font-black text-slate-400 mt-2 uppercase">Take Shop Photo</p></div>
                </div>
                <input type="file" id="camInp" accept="image/*" capture="camera" class="hidden" onchange="previewImg(this)">
                
                <div class="flex justify-between items-center mb-6">
                    <p class="text-[10px] font-black text-slate-400 uppercase italic">Payable Total</p>
                    <p class="text-3xl font-black text-blue-600 italic">Rs <span id="billTotal">0</span></p>
                </div>
                <button onclick="submitOrder()" id="subBtn" class="w-full bg-emerald-500 text-white py-5 rounded-[2rem] font-black uppercase italic shadow-lg shadow-emerald-100 flex items-center justify-center gap-3">
                    <i class="fab fa-whatsapp text-xl"></i> Confirm Order
                </button>
            </div>
        </div>

        <div id="returnTab" class="tab-content space-y-4">
            <div class="bg-white p-6 rounded-[3rem] shadow-sm border">
                <h3 class="text-xs font-black uppercase text-rose-500 italic mb-4">Returns Management</h3>
                <input id="retShop" placeholder="SELECT SHOP NAME" class="w-full p-4 bg-slate-50 rounded-2xl mb-3 font-black text-xs outline-none">
                <input id="retItem" placeholder="PRODUCT NAME" class="w-full p-4 bg-slate-50 rounded-2xl mb-3 font-black text-xs outline-none">
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <input id="retQty" type="number" placeholder="QTY" class="p-4 bg-slate-50 rounded-2xl font-black text-xs outline-none">
                    <select id="retType" class="p-4 bg-slate-100 rounded-2xl font-black text-[10px] outline-none uppercase">
                        <option>EXPIRY</option>
                        <option>DAMAGE</option>
                    </select>
                </div>
                <button onclick="submitReturn()" class="w-full bg-rose-500 text-white py-4 rounded-[2rem] font-black uppercase text-[10px] shadow-lg shadow-rose-100">Send Return Request</button>
            </div>
        </div>

        <div id="recoveryTab" class="tab-content space-y-4">
            <h3 class="text-xs font-black uppercase italic mb-4">Market Recovery</h3>
            <div id="recoveryList" class="space-y-4"></div>
        </div>

    </div>

    <nav class="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-md border-t p-4 flex justify-around items-center shadow-2xl z-[100]">
        <button onclick="showTab('homeTab', this)" class="nav-item nav-active p-3 px-6 flex flex-col items-center gap-1 text-slate-400">
            <i class="fa-solid fa-house"></i><span class="text-[8px] font-black uppercase">Home</span>
        </button>
        <button onclick="showTab('orderTab', this)" class="nav-item p-3 px-6 flex flex-col items-center gap-1 text-slate-400">
            <i class="fa-solid fa-plus-circle"></i><span class="text-[8px] font-black uppercase">Order</span>
        </button>
        <button onclick="showTab('recoveryTab', this)" class="nav-item p-3 px-6 flex flex-col items-center gap-1 text-slate-400">
            <i class="fa-solid fa-sack-dollar"></i><span class="text-[8px] font-black uppercase">Dues</span>
        </button>
    </nav>
</div>

<script>
// CONFIG
const firebaseConfig = { apiKey: "AIzaSyBP3VrLzUl5AIR2ca1v871cV-cJOMz-SX0", authDomain: "gm-agency-pos.firebaseapp.com", projectId: "gm-agency-pos", storageBucket: "gm-agency-pos.firebasestorage.app", messagingSenderId: "777771332628", appId: "1:777771332628:web:db60e19d9bdcee21f76301" };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const BOSS_WA = "923066442004", IMGBB = "ac9e20cc7634087a31f0cc92096c23f4";

let pin = "", shops = [], items = [], cart = [], lat = "", lon = "", isNew = false;

// 0101 LOCK
function addDigit(n) {
    if(pin.length < 4) {
        pin += n;
        const dots = document.querySelectorAll('.pin-dot');
        dots[pin.length-1].classList.add('filled');
        if(pin === "0101") {
            document.getElementById('lockScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
        } else if(pin.length === 4) {
            setTimeout(resetPin, 300);
        }
    }
}
function resetPin() { pin = ""; document.querySelectorAll('.pin-dot').forEach(d => d.classList.remove('filled')); }

// GPS
if(navigator.geolocation) {
    navigator.geolocation.watchPosition(p => { lat = p.coords.latitude; lon = p.coords.longitude; });
}

// DASHBOARD SYNC
db.collection("products").onSnapshot(s => {
    items = s.docs.map(d => d.data());
    let asset = items.reduce((a, i) => a + (Number(i.stock || 0) * Number(i.price || 0)), 0);
    document.getElementById('totalAsset').innerText = "Rs " + asset.toLocaleString();
    document.getElementById('zakatVal').innerText = "Rs " + Math.floor(asset * 0.025).toLocaleString();
});
db.collection("customers").onSnapshot(s => { shops = s.docs.map(d => ({id: d.id, ...d.data()})); renderRecovery(); });

// TABS & UI
function showTab(id, el) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    if(el) {
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('text-blue-600'));
        el.classList.add('text-blue-600');
    }
}

function toggleNewShop(val) {
    isNew = val;
    document.getElementById('newShopDiv').classList.toggle('hidden', !val);
    document.getElementById('shopSearchDiv').classList.toggle('hidden', val);
    document.getElementById('newBtn').className = val ? "bg-blue-600 text-white px-4 py-2 rounded-2xl text-[10px] font-black uppercase" : "bg-slate-100 text-slate-400 px-4 py-2 rounded-2xl text-[10px] font-black uppercase";
    document.getElementById('oldBtn').className = !val ? "bg-blue-600 text-white px-4 py-2 rounded-2xl text-[10px] font-black uppercase" : "bg-slate-100 text-slate-400 px-4 py-2 rounded-2xl text-[10px] font-black uppercase";
}

// SEARCH & CART
function searchShop(q) {
    const res = document.getElementById('shopResults'); if(!q) return res.classList.add('hidden');
    const f = shops.filter(s => s.name.toLowerCase().includes(q.toLowerCase()));
    res.innerHTML = f.map(s => `<div class="p-4 border-b font-black text-[11px] uppercase" onclick="pickShop('${s.name}')">${s.name}</div>`).join('');
    res.classList.remove('hidden');
}
function pickShop(n) { document.getElementById('shopSearch').value = n; document.getElementById('shopResults').classList.add('hidden'); }

function filterProds(q) {
    const res = document.getElementById('pResults'); if(!q) return res.classList.add('hidden');
    const f = items.filter(i => i.name.toLowerCase().includes(q.toLowerCase()));
    res.innerHTML = f.map(i => `<div class="p-4 border-b flex justify-between font-black text-[10px] uppercase" onclick="pickProd('${i.name}',${i.price})"><span>${i.name}</span><span class="text-blue-600">Rs ${i.price}</span></div>`).join('');
    res.classList.remove('hidden');
}
let selP = { name: '', price: 0 };
function pickProd(n, p) { selP = { name: n, price: p }; document.getElementById('pSearch').value = n; document.getElementById('pResults').classList.add('hidden'); }

function addToCart() {
    const q = Number(document.getElementById('pQty').value);
    if(selP.name && q > 0) {
        cart.push({ name: selP.name, price: selP.price, qty: q, sub: selP.price * q });
        renderCart();
        document.getElementById('pSearch').value = "";
    }
}
function renderCart() {
    document.getElementById('cartBox').innerHTML = cart.map((i,x) => `<div class="flex justify-between p-3 bg-slate-50 rounded-2xl border-l-4 border-blue-500 font-black text-[10px] uppercase"><span>${i.name} (x${i.qty})</span><span>Rs ${i.sub}</span></div>`).join('');
    document.getElementById('billTotal').innerText = cart.reduce((s,i) => s + i.sub, 0).toLocaleString();
}

// PHOTO
function triggerCam() { document.getElementById('camInp').click(); }
function previewImg(i) {
    if (i.files && i.files[0]) {
        const r = new FileReader();
        r.onload = e => { 
            document.getElementById('prevImg').src = e.target.result;
            document.getElementById('prevImg').classList.remove('hidden');
            document.getElementById('camText').classList.add('hidden');
        };
        r.readAsDataURL(i.files[0]);
    }
}

// FINAL ORDER
async function submitOrder() {
    const btn = document.getElementById('subBtn');
    let sName = isNew ? document.getElementById('nSName').value : document.getElementById('shopSearch').value;
    if(!sName || cart.length === 0) return alert("Select Shop/Items!");

    btn.disabled = true; btn.innerText = "Processing...";
    let imgLink = "NO_IMG", oid = "ALH-" + Date.now().toString().slice(-5);

    try {
        const photo = document.getElementById('camInp').files[0];
        if(photo) {
            let fd = new FormData(); fd.append("image", photo);
            const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB}`, { method: "POST", body: fd });
            const d = await res.json(); if(d.success) imgLink = d.data.url;
        }

        const data = {
            id: oid, customer: sName, items: cart, grandTotal: cart.reduce((s,i) => s+i.sub, 0),
            img: imgLink, gps: `https://www.google.com/maps?q=${lat},${lon}`,
            date: new Date().toLocaleDateString(), status: "PENDING"
        };
        await db.collection("sales").doc(oid).set(data);
        if(isNew) await db.collection("customers").add({ name: sName, phone: document.getElementById('nSPhone').value, balance: 0 });

        window.location.href = `https://api.whatsapp.com/send?phone=${BOSS_WA}&text=ðŸ¢ *ORDER: ${oid}*%0AðŸª *Shop:* ${sName}%0AðŸ“¸ *Photo:* ${imgLink}%0AðŸ“ *Location:* ${data.gps}`;
    } catch(e) { btn.disabled = false; alert("Error!"); }
}

function renderRecovery() {
    document.getElementById('recoveryList').innerHTML = shops.map(s => `
        <div class="bg-white p-5 rounded-[2.5rem] flex justify-between items-center shadow-sm border">
            <div><p class="font-black text-xs uppercase">${s.name}</p><p class="text-[9px] text-rose-500 font-bold">Udhari: Rs ${s.balance || 0}</p></div>
            <div class="flex gap-2"><input id="rec-${s.id}" type="number" placeholder="Rs" class="w-16 p-2 bg-slate-50 rounded-xl text-xs font-bold border"><button onclick="reqRec('${s.id}','${s.name}')" class="bg-blue-600 text-white p-2 px-3 rounded-xl text-[8px] font-black uppercase italic">Send</button></div>
        </div>`).join('');
    } 
    async function reqRec(id, name) {
    const a = document.getElementById(`rec-${id}`).value; if(!a) return;
    await db.collection("cash_requests").add({ customerName: name, amount: Number(a), status: "PENDING", date: new Date().toLocaleDateString() });
    alert("Recovery Request Sent!");
}

async function submitReturn() {
    const s = document.getElementById('retShop').value, i = document.getElementById('retItem').value, q = document.getElementById('retQty').value, t = document.getElementById('retType').value;
    if(!s || !i || !q) return alert("Fill all fields!");
    await db.collection("returns").add({ shop: s, item: i, qty: q, type: t, status: "PENDING", date: new Date().toLocaleDateString() });
    alert("Return Request Sent!"); location.reload();
}

document.getElementById('liveDate').innerText = new Date().toDateString();
</script>
</body>
</html>
