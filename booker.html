<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AL-HAFIZ TRADERS | ERP BOOKER</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap');
        body { font-family: 'Outfit', sans-serif; background-color: #f3f4f6; }
        .tab-content { display: none; padding-bottom: 120px; }
        .tab-content.active { display: block; animation: slideUp 0.4s ease; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .nav-active { color: #1d4ed8 !important; border-top: 4px solid #1d4ed8; background: #eff6ff; }
        .card-shadow { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05); }
    </style>
</head>
<body>

<div id="mainApp" class="max-w-md mx-auto min-h-screen bg-slate-50 relative">
    
    <div class="bg-[#0f172a] p-7 text-white rounded-b-[3.5rem] shadow-2xl">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-2xl font-extrabold italic tracking-tighter">AL-HAFIZ <span class="text-blue-500">TRADERS</span></h1>
                <p id="currentDate" class="text-[10px] text-slate-400 font-bold mt-1 uppercase tracking-widest"></p>
            </div>
            <div class="text-right">
                <span id="gpsDot" class="inline-block w-2 h-2 bg-rose-500 rounded-full animate-ping mr-1"></span>
                <span class="text-[9px] font-black text-slate-300">GPS TRACKING</span>
            </div>
        </div>

        <div class="bg-white/5 backdrop-blur-md rounded-[2.5rem] p-5 border border-white/10">
            <div class="grid grid-cols-2 gap-4 border-b border-white/10 pb-4 mb-4">
                <div>
                    <p class="text-[9px] text-blue-400 font-bold uppercase">Inventory Asset</p>
                    <p class="text-xl font-black">Rs <span id="assetVal">0</span></p>
                </div>
                <div class="text-right">
                    <p class="text-[9px] text-yellow-500 font-bold uppercase">Zakat Payable</p>
                    <p class="text-xl font-black text-yellow-500">Rs <span id="zakatVal">0</span></p>
                </div>
            </div>
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-[9px] text-emerald-400 font-bold uppercase">Today's Booking</p>
                    <p class="text-xl font-black text-emerald-400">Rs <span id="dayTotal">0</span></p>
                </div>
                <button onclick="window.print()" class="bg-blue-600 p-2 px-4 rounded-2xl text-[10px] font-bold shadow-lg shadow-blue-900/40">GENERATE REPORT</button>
            </div>
        </div>
    </div>

    <div class="px-5 pt-6">
        
        <div id="homeTab" class="tab-content active">
            <h2 class="text-[11px] font-black text-slate-400 uppercase tracking-[0.3em] mb-6">Operations Center</h2>
            <div class="grid grid-cols-3 gap-6">
                <div onclick="markAttendance()" class="flex flex-col items-center">
                    <div class="w-16 h-16 bg-white rounded-[1.5rem] flex items-center justify-center text-blue-600 shadow-xl card-shadow border border-slate-100"><i class="fa-solid fa-user-check text-xl"></i></div>
                    <span class="text-[10px] font-black text-slate-600 mt-3 uppercase">Attendance</span>
                </div>
                <div onclick="openModal('expenseModal')" class="flex flex-col items-center">
                    <div class="w-16 h-16 bg-white rounded-[1.5rem] flex items-center justify-center text-orange-600 shadow-xl card-shadow border border-slate-100"><i class="fa-solid fa-file-invoice-dollar text-xl"></i></div>
                    <span class="text-[10px] font-black text-slate-600 mt-3 uppercase">Expense</span>
                </div>
                <div onclick="showTab('stockTab')" class="flex flex-col items-center">
                    <div class="w-16 h-16 bg-white rounded-[1.5rem] flex items-center justify-center text-purple-600 shadow-xl card-shadow border border-slate-100"><i class="fa-solid fa-cubes-stacked text-xl"></i></div>
                    <span class="text-[10px] font-black text-slate-600 mt-3 uppercase">Stock</span>
                </div>
                <div onclick="showTab('recoveryTab')" class="flex flex-col items-center">
                    <div class="w-16 h-16 bg-white rounded-[1.5rem] flex items-center justify-center text-emerald-600 shadow-xl card-shadow border border-slate-100"><i class="fa-solid fa-hand-holding-dollar text-xl"></i></div>
                    <span class="text-[10px] font-black text-slate-600 mt-3 uppercase">Recovery</span>
                </div>
                <div onclick="openModal('broadcastModal')" class="flex flex-col items-center">
                    <div class="w-16 h-16 bg-white rounded-[1.5rem] flex items-center justify-center text-pink-600 shadow-xl card-shadow border border-slate-100"><i class="fa-solid fa-bullhorn text-xl"></i></div>
                    <span class="text-[10px] font-black text-slate-600 mt-3 uppercase">Broadcast</span>
                </div>
                <div onclick="alert('Wapsi Form Opening...')" class="flex flex-col items-center">
                    <div class="w-16 h-16 bg-white rounded-[1.5rem] flex items-center justify-center text-red-600 shadow-xl card-shadow border border-slate-100"><i class="fa-solid fa-rotate-left text-xl"></i></div>
                    <span class="text-[10px] font-black text-slate-600 mt-3 uppercase">Returns</span>
                </div>
            </div>
        </div>

        <div id="bookingTab" class="tab-content space-y-6">
            <div class="bg-white p-6 rounded-[2.5rem] card-shadow border border-slate-100">
                <input id="shopSearch" oninput="searchShop(this.value)" placeholder="SEARCH CUSTOMER..." class="w-full p-4 bg-slate-50 rounded-2xl font-black text-xs outline-none border-2 border-transparent focus:border-blue-500 uppercase italic">
                <div id="shopResults" class="hidden mt-2 bg-white shadow-2xl rounded-2xl max-h-48 overflow-y-auto border-2 border-blue-50 z-50 relative"></div>
            </div>

            <div class="bg-white p-6 rounded-[2.5rem] card-shadow border border-slate-100">
                <input id="pSearch" oninput="filterProds(this.value)" placeholder="SELECT PRODUCT..." class="w-full p-4 bg-slate-50 rounded-2xl font-black text-xs outline-none border-2 border-transparent focus:border-emerald-500 uppercase italic">
                <div id="pResults" class="hidden mt-2 bg-white shadow-2xl rounded-2xl max-h-48 overflow-y-auto border-2 border-emerald-50 z-50 relative"></div>
                
                <div class="flex gap-3 mt-4">
                    <select id="unitType" class="bg-slate-100 rounded-xl p-3 font-black text-[10px] outline-none">
                        <option value="PCS">PCS</option>
                        <option value="CTN">CTN (12)</option>
                    </select>
                    <input id="pQty" type="number" value="1" class="flex-1 bg-slate-100 rounded-xl p-3 text-center font-black outline-none">
                    <button onclick="addToCart()" class="bg-slate-900 text-white px-6 rounded-xl font-black text-[10px] uppercase">ADD</button>
                </div>
                
                <div id="cartBox" class="mt-6 space-y-3"></div>
            </div>

            <div class="bg-emerald-500 p-7 rounded-[3rem] text-white shadow-xl shadow-emerald-200">
                <div class="flex justify-between items-end mb-6">
                    <div><p class="text-[10px] font-black uppercase opacity-80">Total Payable</p><p class="text-3xl font-black">Rs <span id="billTotal">0</span></p></div>
                    <div class="text-right text-[11px] font-black uppercase"><p>CTN: <span id="ctnTotal">0</span></p><p>PCS: <span id="pcsTotal">0</span></p></div>
                </div>
                <button id="subBtn" onclick="submitOrder()" class="w-full bg-white text-emerald-600 py-5 rounded-[2rem] font-black uppercase italic shadow-xl flex items-center justify-center gap-3 active:scale-95 transition-all">
                    <i class="fab fa-whatsapp text-xl"></i> CONFIRM ORDER
                </button>
            </div>
        </div>

        <div id="stockTab" class="tab-content">
            <h2 class="text-[11px] font-black text-slate-400 uppercase tracking-[0.3em] mb-6">Live Inventory</h2>
            <div id="stockList" class="space-y-3"></div>
        </div>

        <div id="recoveryTab" class="tab-content space-y-4">
            <h2 class="text-[11px] font-black text-slate-400 uppercase tracking-[0.3em] mb-6">Market Dues</h2>
            <div id="recoveryList" class="space-y-4"></div>
        </div>

    </div>

    <div id="expenseModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-[200] hidden flex items-center justify-center p-6">
        <div class="bg-white w-full rounded-[3rem] p-8 shadow-2xl">
            <h3 class="font-black text-xl mb-6 italic">ADD EXPENSE</h3>
            <input id="expType" placeholder="PURPOSE (PETROL...)" class="w-full p-4 bg-slate-100 rounded-2xl mb-3 font-bold uppercase text-xs">
            <input id="expAmt" type="number" placeholder="AMOUNT" class="w-full p-4 bg-slate-100 rounded-2xl mb-6 font-bold text-xs">
            <div class="flex gap-4">
                <button onclick="closeModal('expenseModal')" class="flex-1 py-4 font-black uppercase text-xs text-slate-400">Back</button>
                <button onclick="saveExpense()" class="flex-1 bg-orange-500 text-white py-4 rounded-2xl font-black text-xs uppercase">Save</button>
            </div>
        </div>
    </div>

    <div id="broadcastModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-[200] hidden flex items-center justify-center p-6">
        <div class="bg-white w-full rounded-[3rem] p-8">
            <h3 class="font-black text-xl mb-6 italic">BROADCAST</h3>
            <textarea id="bcMsg" placeholder="TYPE MESSAGE TO TEAM..." class="w-full p-4 bg-slate-100 rounded-2xl mb-6 font-bold text-xs h-32 outline-none"></textarea>
            <div class="flex gap-4">
                <button onclick="closeModal('broadcastModal')" class="flex-1 py-4 font-black text-xs text-slate-400 uppercase">Back</button>
                <button onclick="sendBC()" class="flex-1 bg-pink-500 text-white py-4 rounded-2xl font-black text-xs uppercase">Send Now</button>
            </div>
        </div>
    </div>

    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t p-4 flex justify-around items-center shadow-[0_-10px_40px_rgba(0,0,0,0.08)] z-[100]">
        <button onclick="showTab('homeTab', this)" class="nav-item nav-active flex flex-col items-center gap-1 text-slate-400 w-16 py-2 rounded-2xl transition-all">
            <i class="fa-solid fa-house-chimney text-lg"></i><span class="text-[8px] font-black uppercase">Home</span>
        </button>
        <button onclick="showTab('bookingTab', this)" class="nav-item flex flex-col items-center gap-1 text-slate-400 w-16 py-2 rounded-2xl transition-all">
            <i class="fa-solid fa-receipt text-lg"></i><span class="text-[8px] font-black uppercase">Booking</span>
        </button>
        <button onclick="showTab('recoveryTab', this)" class="nav-item flex flex-col items-center gap-1 text-slate-400 w-16 py-2 rounded-2xl transition-all">
            <i class="fa-solid fa-wallet text-lg"></i><span class="text-[8px] font-black uppercase">Wasuli</span>
        </button>
        <button onclick="showTab('stockTab', this)" class="nav-item flex flex-col items-center gap-1 text-slate-400 w-16 py-2 rounded-2xl transition-all">
            <i class="fa-solid fa-box-open text-lg"></i><span class="text-[8px] font-black uppercase">Stock</span>
        </button>
    </nav>
</div>

<script>
// CONFIG
const firebaseConfig = { apiKey: "AIzaSyBP3VrLzUl5AIR2ca1v871cV-cJOMz-SX0", authDomain: "gm-agency-pos.firebaseapp.com", projectId: "gm-agency-pos", storageBucket: "gm-agency-pos.firebasestorage.app", messagingSenderId: "777771332628", appId: "1:777771332628:web:db60e19d9bdcee21f76301" };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const BOSS_WA = "923353131530";
let shops = [], items = [], cart = [], uLat = "", uLong = "";

document.getElementById('currentDate').innerText = new Date().toLocaleDateString('en-GB', {weekday: 'long', day: 'numeric', month: 'short'});

// GPS
if(navigator.geolocation) {
    navigator.geolocation.watchPosition(p => { 
        uLat = p.coords.latitude; uLong = p.coords.longitude;
        document.getElementById('gpsDot').classList.replace('bg-rose-500', 'bg-emerald-500');
    });
}

// LIVE DATA
db.collection("products").onSnapshot(s => { 
    items = s.docs.map(d => ({id: d.id, ...d.data()})); 
    let asset = items.reduce((a, i) => a + (Number(i.stock || 0) * Number(i.price || 0)), 0);
    document.getElementById('assetVal').innerText = asset.toLocaleString();
    document.getElementById('zakatVal').innerText = Math.floor(asset * 0.025).toLocaleString();
    renderStock(); 
});
db.collection("customers").onSnapshot(s => { shops = s.docs.map(d => ({id: d.id, ...d.data()})); renderRecovery(); });
db.collection("sales").where("date", "==", new Date().toLocaleDateString()).onSnapshot(s => {
    let t = 0; s.forEach(d => t += Number(d.data().grandTotal || 0));
    document.getElementById('dayTotal').innerText = t.toLocaleString();
});

// FUNCTIONS
function showTab(id, el) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    if(el) {
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('nav-active'));
        el.classList.add('nav-active');
    }
}

function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

// ATTENDANCE & EXPENSE
async function markAttendance() {
    await db.collection("attendance").add({ booker: "Waqar Ahmed", time: new Date().toLocaleTimeString(), date: new Date().toLocaleDateString(), loc: uLat ? `${uLat},${uLong}` : "OFF" });
    alert("ATTENDANCE MARKED âœ“");
}

async function saveExpense() {
    const t = document.getElementById('expType').value, a = document.getElementById('expAmt').value;
    if(!t || !a) return;
    await db.collection("expenses").add({ type: t, amount: Number(a), date: new Date().toLocaleDateString(), booker: "Waqar Ahmed" });
    alert("EXPENSE SAVED âœ“"); closeModal('expenseModal');
}

async function sendBC() {
    const m = document.getElementById('bcMsg').value;
    if(!m) return;
    await db.collection("broadcasts").add({ msg: m, time: new Date().toLocaleTimeString(), sender: "Waqar Ahmed" });
    alert("MESSAGE BROADCASTED âœ“"); closeModal('broadcastModal');
}

// BOOKING LOGIC
function searchShop(q) {
    const res = document.getElementById('shopResults'); if(!q) return res.classList.add('hidden');
    const f = shops.filter(s => s.name.toLowerCase().includes(q.toLowerCase()));
    res.innerHTML = f.map(s => `<div class="p-4 border-b font-black text-xs uppercase" onclick="pickShop('${s.name}','${s.id}')">${s.name}</div>`).join('');
    res.classList.remove('hidden');
}
function pickShop(n, id) { 
    document.getElementById('shopSearch').value = n; 
    document.getElementById('shopResults').classList.add('hidden'); 
    document.getElementById('bookingTab').dataset.shop = n;
    document.getElementById('bookingTab').dataset.sid = id;
}

function filterProds(q) {
    const res = document.getElementById('pResults'); if(!q) return res.classList.add('hidden');
    const f = items.filter(i => i.name.toLowerCase().includes(q.toLowerCase()));
    res.innerHTML = f.map(i => `<div class="p-4 border-b flex justify-between font-black text-[10px] uppercase" onclick="pickProd('${i.name}',${i.price})"><span>${i.name}</span><span class="text-blue-600">Rs ${i.price}</span></div>`).join('');
    res.classList.remove('hidden');
}
let selP = { name: '', price: 0 };
function pickProd(n, p) { selP = { name: n, price: p }; document.getElementById('pSearch').value = n; document.getElementById('pResults').classList.add('hidden'); }

function addToCart() {
    const qty = Number(document.getElementById('pQty').value);
    const unit = document.getElementById('unitType').value;
    const finalQty = unit === "CTN" ? qty * 12 : qty;
    if(selP.name && qty > 0) {
        cart.push({ name: selP.name, price: selP.price, qty: finalQty, unit: unit, sub: selP.price * finalQty });
        renderCart();
        document.getElementById('pSearch').value = ""; document.getElementById('pQty').value = 1;
    }
}

function renderCart() {
    const box = document.getElementById('cartBox');
    box.innerHTML = cart.map((i, x) => `<div class="flex justify-between p-4 bg-slate-50 rounded-2xl border-l-4 border-blue-600 font-black text-[10px] uppercase"><span>${i.name} (${i.qty} Pcs)</span><span>Rs ${i.sub} <i onclick="cart.splice(${x},1);renderCart()" class="fa-solid fa-trash text-red-400 ml-2"></i></span></div>`).join('');
    let total = cart.reduce((s, i) => s + i.sub, 0);
    let pcs = cart.reduce((s, i) => s + i.qty, 0);
    document.getElementById('billTotal').innerText = total.toLocaleString();
    document.getElementById('pcsTotal').innerText = pcs;
    document.getElementById('ctnTotal').innerText = (pcs / 12).toFixed(1);
}

async function submitOrder() {
    const shop = document.getElementById('bookingTab').dataset.shop;
    if(!shop || cart.length === 0) return alert("SELECT SHOP & ITEMS!");
    const orderId = "ALH-" + Date.now().toString().slice(-5);
    const total = cart.reduce((s, i) => s + i.sub, 0);
    
    await db.collection("sales").doc(orderId).set({
        id: orderId, customer: shop, date: new Date().toLocaleDateString(), items: cart, grandTotal: total, status: "PENDING", timestamp: Date.now()
    });

    let list = cart.map(i => `â€¢ ${i.name} (x${i.qty})`).join('%0A');
    window.location.href = `https://api.whatsapp.com/send?phone=${BOSS_WA}&text=ðŸ¢ *NEW ORDER: ${orderId}*%0AðŸª *Shop:* ${shop}%0AðŸ’° *Total:* Rs ${total}%0Aâ”â”â”â”â”â”â”â”â”â”â”â”%0AðŸ›’ *ITEMS:*%0A${list}`;
}

function renderStock() {
    document.getElementById('stockList').innerHTML = items.map(i => `
        <div class="p-4 bg-white rounded-2xl flex justify-between items-center shadow-sm">
            <span class="font-black text-[11px] uppercase text-slate-600">${i.name}</span>
            <span class="bg-blue-50 text-blue-600 px-3 py-1 rounded-full font-black text-[10px]">${i.stock || 0} PCS</span>
        </div>`).join('');
}

function renderRecovery() {
    document.getElementById('recoveryList').innerHTML = shops.map(s => `
        <div class="bg-white p-5 rounded-[2rem] flex justify-between items-center card-shadow border">
            <div><p class="font-black text-xs uppercase">${s.name}</p><p class="text-[10px] text-rose-500 font-black">DUES: Rs ${s.balance || 0}</p></div>
            <button onclick="alert('Recovery Request Sent!')" class="bg-emerald-500 text-white p-3 px-5 rounded-2xl text-[10px] font-black uppercase shadow-lg shadow-emerald-100">REC</button>
        </div>`).join('');
}
</script>
</body>
    </html>
    
