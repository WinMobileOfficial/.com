<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GM Booker Pro | Al-Hafiz Traders</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; }
        .tab-content { display: none; }
        .active-tab { display: block; animation: slideUp 0.3s ease; }
        .nav-active { color: #3b82f6 !important; border-top: 4px solid #3b82f6; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .search-results { position: absolute; width: 100%; background: white; z-index: 100; border-radius: 1rem; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.5); max-height: 200px; overflow-y: auto; color: #1e293b; }
    </style>
</head>
<body class="pb-28">

<div id="lockScreen" class="fixed inset-0 bg-[#0f172a] z-[9999] flex flex-col items-center justify-center p-6">
    <div class="bg-slate-800 p-8 rounded-[3rem] border-2 border-slate-700 w-full max-w-xs text-center shadow-2xl">
        <div class="w-16 h-16 bg-blue-600 rounded-2xl mx-auto mb-6 flex items-center justify-center"><i class="fas fa-user-shield text-2xl text-white"></i></div>
        <h1 class="text-white font-black mb-6 uppercase tracking-widest italic">Booker Login</h1>
        <input id="bookerPin" type="password" inputmode="numeric" placeholder="â€¢â€¢â€¢â€¢" class="w-full p-4 rounded-2xl text-center text-3xl font-black mb-4 outline-none border-4 border-blue-500 shadow-lg">
        <button onclick="checkPin()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black uppercase active:scale-95 transition-all">Unlock App</button>
    </div>
</div>

<div id="mainApp" class="hidden">
    <div class="p-6 bg-slate-800 text-white rounded-b-[2.5rem] shadow-2xl border-b border-blue-500/30">
        <div class="flex justify-between items-start mb-4">
            <div>
                <h1 class="text-xl font-black text-blue-400 italic">AL-HAFIZ TRADERS</h1>
                <p id="gpsStatus" class="text-[9px] font-bold text-rose-400 uppercase tracking-widest animate-pulse">GPS: SEARCHING...</p>
            </div>
            <button onclick="sendDaySummary()" class="bg-slate-700 p-2 px-3 rounded-xl border border-white/10 active:scale-90 shadow-lg">
                <i class="fas fa-file-invoice text-emerald-400"></i>
            </button>
        </div>
        <div class="grid grid-cols-2 gap-3">
            <div class="bg-slate-900/50 p-3 rounded-2xl border border-white/5">
                <p class="text-[8px] opacity-50 font-black uppercase italic">Today Booking</p>
                <p class="text-lg font-black text-emerald-400">Rs <span id="dayTotal">0</span></p>
            </div>
            <div class="bg-slate-900/50 p-3 rounded-2xl border border-white/5">
                <p class="text-[8px] opacity-50 font-black uppercase italic">Pending Cash</p>
                <p class="text-lg font-black text-orange-400">Rs <span id="cashTotal">0</span></p>
            </div>
        </div>
    </div>

    <div class="p-4 max-w-md mx-auto space-y-4">
        
        <div id="orderTab" class="tab-content active-tab space-y-4">
            <div class="bg-white rounded-[2.5rem] p-5 shadow-xl border-b-8 border-blue-500">
                <div class="flex justify-between items-center mb-3 px-1">
                    <p class="text-[10px] font-black uppercase text-slate-400 italic">Select or Add Shop</p>
                    <button onclick="toggleNewCustomer()" id="newCustBtn" class="bg-blue-600 text-white text-[9px] font-black px-3 py-1 rounded-full uppercase shadow-md">+ New Shop</button>
                </div>
                
                <div id="searchBoxContainer" class="relative mb-3">
                    <input id="shopSearch" oninput="searchLedger(this.value)" placeholder="SEARCH SHOP..." class="w-full p-4 border-2 border-slate-100 rounded-2xl font-black outline-none uppercase text-xs italic">
                    <div id="ledgerResults" class="search-results hidden"></div>
                </div>

                <div id="newCustFields" class="hidden space-y-2 mb-3 bg-blue-50 p-4 rounded-2xl border-2 border-dashed border-blue-200">
    <input id="newShopName" placeholder="NEW SHOP NAME" class="w-full p-3 bg-white rounded-xl font-bold text-xs uppercase outline-none">
    <input id="newShopPhone" type="tel" placeholder="PHONE NO" class="w-full p-3 bg-white rounded-xl font-bold text-xs outline-none">
    
    <select id="newShopDay" class="w-full p-3 bg-white rounded-xl font-bold text-[10px] uppercase outline-none border-2 border-blue-100">
        <option value="">SELECT ROUTE DAY</option>
        <option value="Monday">Monday</option>
        <option value="Tuesday">Tuesday</option>
        <option value="Wednesday">Wednesday</option>
        <option value="Thursday">Thursday</option>
        <option value="Friday">Friday</option>
        <option value="Saturday">Saturday</option>
    </select>

    <button onclick="saveAndSelectCustomer()" class="w-full bg-blue-600 text-white py-2 rounded-xl text-[10px] font-black uppercase italic">Register & Select</button>
</div>


                <div class="grid grid-cols-2 gap-2">
                    <input id="shopName" readonly placeholder="SHOP NAME" class="w-full p-3 bg-slate-50 rounded-xl font-bold text-[10px] uppercase border">
                    <input id="shopPhone" readonly placeholder="PHONE NO" class="w-full p-3 bg-slate-50 rounded-xl font-bold text-[10px] border">
                </div>
            </div>

            <div class="bg-white rounded-[2.5rem] p-5 shadow-xl border-b-8 border-slate-200">
                <div class="relative mb-3">
                    <input id="pSearch" oninput="filterProducts(this.value)" placeholder="FIND PRODUCT..." class="w-full p-4 border-2 border-slate-100 rounded-2xl font-black outline-none uppercase text-xs italic">
                    <div id="searchList" class="search-results hidden"></div>
                </div>
                <div class="grid grid-cols-2 gap-2 mb-3">
                    <input id="pPrice" type="number" readonly class="p-3 bg-slate-100 rounded-xl text-center font-black" placeholder="Rate">
                    <input id="pQty" type="number" value="1" min="1" class="p-3 border-2 border-emerald-500 rounded-xl text-center font-black outline-none">
                </div>
                <button onclick="addToCart()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-black uppercase text-[10px] tracking-widest active:scale-95 transition-all">Add to Cart</button>
                <div id="cartItems" class="mt-4 space-y-2"></div>
            </div>

            <div class="bg-white p-5 rounded-[2.5rem] shadow-xl border-b-8 border-slate-400">
                <input type="file" id="shopPhoto" accept="image/*" capture="camera" class="hidden" onchange="previewPhoto(this)">
                <div onclick="document.getElementById('shopPhoto').click()" class="w-full h-32 border-2 border-dashed border-slate-200 rounded-3xl flex flex-col items-center justify-center bg-slate-50 relative overflow-hidden cursor-pointer active:scale-95 transition-all">
                    <img id="pImg" class="hidden h-full w-full object-cover">
                    <div id="camIcon" class="text-center">
                        <i class="fas fa-camera text-3xl text-slate-300 mb-1"></i>
                        <p class="text-[9px] font-black text-slate-400 uppercase italic">Snap Shop Front</p>
                    </div>
                </div>
                <div class="flex justify-between items-center mt-6 mb-4 px-2">
                    <span class="text-xs font-black uppercase text-slate-400">Total Bill:</span>
                    <span class="text-2xl font-black text-blue-600 italic">Rs <span id="billTotal">0</span></span>
                </div>
                <button id="submitBtn" onclick="finalSubmit()" class="w-full bg-emerald-500 text-slate-900 py-5 rounded-3xl font-black uppercase italic shadow-lg flex items-center justify-center gap-3 active:scale-95 transition-all">
                    <i class="fab fa-whatsapp text-xl"></i> Confirm Order
                </button>
            </div>
        </div>

        <div id="ledgerTab" class="tab-content">
            <div class="bg-white p-6 rounded-[2.5rem] shadow-xl border-b-8 border-indigo-500">
                <h2 class="font-black text-center mb-2 uppercase italic text-slate-700">Cash Recovery</h2>
                <p class="text-[9px] text-center text-slate-400 mb-6 font-bold uppercase italic">Admin Approval Required</p>
                <input type="text" onkeyup="renderLedger(this.value)" placeholder="SEARCH CUSTOMER..." class="w-full p-4 rounded-2xl bg-slate-100 mb-6 font-black outline-none text-xs">
                <div id="ledgerScreenList" class="space-y-4"></div>
            </div>
        </div>

        <div id="stockTab" class="tab-content">
            <div class="bg-white p-6 rounded-[2.5rem] shadow-xl border-b-8 border-blue-500">
                <h2 class="font-black text-center mb-6 uppercase italic text-slate-700 border-b pb-3">Available Stock</h2>
                <div id="stockList" class="space-y-3"></div>
            </div>
        </div>
    </div>
   <div id="trackingTab" class="tab-content">
    <div class="bg-slate-800 p-6 rounded-[2.5rem] shadow-xl border-b-8 border-indigo-600 mb-6">
        <div class="bg-gradient-to-r from-indigo-600 to-blue-700 p-6 rounded-[2rem] text-white text-center mb-6">
            <p class="text-[10px] uppercase font-black tracking-widest opacity-80">Today's Shop Visits</p>
            <h1 id="totalVisits" class="text-5xl font-black mt-2 text-white">0</h1>
        </div>
        
        <h2 class="font-black text-center mb-4 uppercase italic text-white border-b border-slate-700 pb-2">Visit History</h2>
        
        <div id="visitList" class="space-y-3">
            <p class="text-center text-slate-400 text-[10px] py-10 italic">Waiting for visits data...</p>
        </div>
    </div>
   </div>
    
    

    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around p-3 pb-8 z-[100] shadow-2xl">
    <button onclick="showTab('orderTab', this)" class="flex flex-col items-center gap-1 text-slate-400 font-black uppercase text-[9px] px-2 nav-active">
        <i class="fas fa-shopping-bag text-xl"></i> Order
    </button>
    <button onclick="showTab('ledgerTab', this)" class="flex flex-col items-center gap-1 text-slate-400 font-black uppercase text-[9px] px-2">
        <i class="fas fa-wallet text-xl"></i> Recovery
    </button>
    <button onclick="showTab('stockTab', this)" class="flex flex-col items-center gap-1 text-slate-400 font-black uppercase text-[9px] px-2">
        <i class="fas fa-boxes text-xl"></i> Stock
    </button>
    <button onclick="showTab('trackingTab', this)" class="flex flex-col items-center gap-1 text-slate-400 font-black uppercase text-[9px] px-2">
        <i class="fas fa-map-marker-alt text-xl"></i> Tracking
    </button>
</nav>

</div>

<script>

    // CONFIG & INITIALIZATION
const firebaseConfig = { apiKey: "AIzaSyBP3VrLzUl5AIR2ca1v871cV-cJOMz-SX0", authDomain: "gm-agency-pos.firebaseapp.com", projectId: "gm-agency-pos", storageBucket: "gm-agency-pos.firebasestorage.app", messagingSenderId: "777771332628", appId: "1:777771332628:web:db60e19d9bdcee21f76301" };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const BOSS_WA = "923353131530", IMGBB_KEY = "ac9e20cc7634087a31f0cc92096c23f4";
let prods = [], ledger = [], cart = [], userLat = "", userLong = "";
const getToday = () => {
    const d = new Date();
    const format1 = d.toLocaleDateString('en-GB'); // 08/02/2026
    const format2 = (d.getMonth() + 1) + '/' + d.getDate() + '/' + d.getFullYear(); // 2/8/2026
    return { format1, format2 };
};
    
    
function checkPin() {
    if(document.getElementById('bookerPin').value === "0001") {
        document.getElementById('lockScreen').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        init();
    } else { alert("âŒ INVALID PIN!"); }
}

function init() {
    getLocation();
    db.collection("products").onSnapshot(snap => { prods = snap.docs.map(doc => doc.data()); renderStock(); });
    db.collection("customers").onSnapshot(snap => { ledger = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderLedger(); });
    
    // SALES STATS
    const dates = getToday();
db.collection("sales").where("date", "in", [dates.format1, dates.format2]).onSnapshot(snap => {

    let tSales = 0;
    let tProfit = 0;
    snap.forEach(doc => {
        const d = doc.data();
        tSales += Number(d.grandTotal || 0);
        // Profit Calculation
        if(d.items) {
            d.items.forEach(i => {
                let sale = Number(i.price || 0);
                let cost = Number(i.purchasePrice || 0); 
                tProfit += (sale - cost) * Number(i.qty || 0);
            });
        }
    });
    document.getElementById('dayTotal').innerText = tSales.toLocaleString();
    if(document.getElementById('dayProfit')) {
        document.getElementById('dayProfit').innerText = tProfit.toLocaleString();
    }
});
    // PENDING CASH STATS (Status: PENDING)
    db.collection("cash_requests").where("date", "==", getToday()).where("status", "==", "PENDING").onSnapshot(snap => {
        let c = 0; snap.forEach(d => c += Number(d.data().amount || 0));
        document.getElementById('cashTotal').innerText = c.toLocaleString();
    });
}




function getLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
            userLat = pos.coords.latitude; userLong = pos.coords.longitude;
            const status = document.getElementById('gpsStatus');
            status.innerText = "GPS: ACTIVE âœ“"; status.classList.replace('text-rose-400', 'text-emerald-400'); status.classList.remove('animate-pulse');
        }, null, {enableHighAccuracy: true});
    }
}

// NEW CUSTOMER LOGIC
function toggleNewCustomer() {
    const f = document.getElementById('newCustFields'), s = document.getElementById('searchBoxContainer'), b = document.getElementById('newCustBtn');
    if(f.classList.contains('hidden')) { f.classList.remove('hidden'); s.classList.add('hidden'); b.innerText = "Cancel"; b.classList.replace('bg-blue-600', 'bg-rose-600'); }
    else { f.classList.add('hidden'); s.classList.remove('hidden'); b.innerText = "+ New Shop"; b.classList.replace('bg-rose-600', 'bg-blue-600'); }
}

async function saveAndSelectCustomer() {
    const n = document.getElementById('newShopName').value.trim().toUpperCase();
    const p = document.getElementById('newShopPhone').value.trim();
    const d = document.getElementById('newShopDay').value; // Naya Field: Din uthao

    if (!n || !p || !d) return alert("Haji Sahab, Name, Phone aur Day teeno lazmi hain!");

    try {
        await db.collection("customers").doc(p).set({ 
            name: n, 
            balance: 0, 
            visitDay: d, // Firebase mein Day save ho raha hai
            created: Date.now() 
        });
        selectLedger(n, p); 
        toggleNewCustomer();
        alert("âœ… Shop Registered for " + d);
    } catch (e) { 
        alert("Error: " + e.message); 
    }
}



// ORDER & WA LOGIC (UPDATED FOR DASHBOARD SYNC)
async function finalSubmit() {
    const shop = document.getElementById('shopName').value, 
          phone = document.getElementById('shopPhone').value, 
          photoFile = document.getElementById('shopPhoto').files[0], 
          btn = document.getElementById('submitBtn');
          
    if(!shop || cart.length === 0) return alert("Select Shop & Add Items!");
    
    btn.disabled = true; 
    btn.innerHTML = "UPLOADING...";

    let photoUrl = "No Photo", 
        orderId = "ALH-" + Date.now().toString().slice(-5), 
        total = cart.reduce((s, i) => s + i.subtotal, 0);

    // --- DASHBOARD DATE FIX (MM/DD/YYYY) ---
    const dashboardDate = new Date().toLocaleDateString('en-US');
    
    const mapLink = userLat ? `https://www.google.com/maps?q=${userLat},${userLong}` : "GPS: OFF";

    try {
        let oldBalance = 0;
        const custDoc = await db.collection("customers").doc(phone).get();
        if(custDoc.exists) {
            oldBalance = Number(custDoc.data().balance) || 0;
        }

        if(photoFile) {
            let fd = new FormData(); fd.append("image", photoFile);
            const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: "POST", body: fd });
            const d = await res.json(); if(d.success) photoUrl = d.data.url;
        }

        // --- PROFIT CALCULATION FOR DASHBOARD ---
        // Hum items ko format kar rahe hain taake Admin index.html isay samajh sakay
        const formattedItems = cart.map(i => ({
            name: i.name,
            price: Number(i.price),
            qty: Number(i.qty),
            total: Number(i.subtotal)
        }));
// Line 282 ke baad ye add karein:
        // 1. Distance check karein (Sirf aik dafa)
        let distText = "New Shop Location";
        if (typeof custDoc !== 'undefined' && custDoc.exists && custDoc.data().lat) {
            let d = getDistance(userLat, userLong, custDoc.data().lat, custDoc.data().lng);
            distText = d + " Meters Away";
        }

        // 2. Sale Data ka naya structure
        const saleData = { 
            id: orderId, 
            customer: shop, 
            mob: phone, 
            date: dashboardDate, 
            time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
            items: formattedItems, 
            itemsSum: total,        
            grandTotal: total,      
            prevBal: oldBalance,    
            paid: 0, 
            profit: 0, 
            finalBal: oldBalance + total, 
            img: photoUrl, 
            gps: mapLink, 
            locationStatus: distText, 
            lat: userLat,
            lng: userLong,
            status: "PENDING", 
            role: "booker", 
            timestamp: Date.now() 
        };

        // 3. Database mein save karein
        await db.collection("sales").doc(orderId).set(saleData);
        

        // WhatsApp Message
        let itemsMsg = cart.map(i => `â€¢ ${i.name} (x${i.qty})`).join('%0A');
        let waMsg = `ðŸ¢ *ORDER RECEIVED*%0Aâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”%0AðŸ†” *ID:* ${orderId}%0AðŸª *Shop:* ${shop}%0AðŸ’° *Total:* Rs ${total.toLocaleString()}%0AðŸ“¸ *Photo:* ${photoUrl}%0AðŸ“ *Location:* ${mapLink}%0Aâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”%0AðŸ›’ *ITEMS:*%0A${itemsMsg}`;

        window.location.href = `https://api.whatsapp.com/send?phone=${BOSS_WA}&text=${waMsg}`;
        
        setTimeout(() => {
            cart = [];
            location.reload();
        }, 2000);

    } catch(e) { 
        console.error(e);
        btn.disabled = false; 
        btn.innerHTML = "SUBMIT ORDER";
        alert("Upload Error!"); 
    }
}
    
    
    
// SECURE CASH REQUEST
async function requestCashApproval(id, name, inputId) {
    const amt = Number(document.getElementById(inputId).value);
    if(!amt || amt <= 0) return alert("Enter Valid Amount!");
    if(confirm(`Send Cash Approval Request of Rs ${amt} for ${name}?`)) {
        try {
            const reqId = "CASH-" + Date.now().toString().slice(-6);
            await db.collection("cash_requests").doc(reqId).set({ reqId, customerId: id, customerName: name, amount: amt, date: getToday(), status: "PENDING", timestamp: Date.now() });
            let waMsg = `ðŸ’° *CASH APPROVAL REQUEST*%0Aâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”%0AðŸª *Shop:* ${name}%0AðŸ’µ *Amount:* Rs ${amt.toLocaleString()}%0AðŸ†” *Req ID:* ${reqId}%0Aâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”%0A_Status: Waiting for Admin Approval_`;
            window.location.href = `https://api.whatsapp.com/send?phone=${BOSS_WA}&text=${waMsg}`;
            document.getElementById(inputId).value = "";
        } catch(e) { alert("Request Failed!"); }
    }
}

// UTILITIES
function searchLedger(q) {
    const res = document.getElementById('ledgerResults'); if(!q) { res.classList.add('hidden'); return; }
    const m = ledger.filter(c => c.name.toLowerCase().includes(q.toLowerCase()));
    res.innerHTML = m.map(c => `<div class="p-4 border-b font-black text-xs uppercase italic" onclick="selectLedger('${c.name}', '${c.id}')">${c.name}</div>`).join('');
    res.classList.remove('hidden');
}

function selectLedger(n, p) {
    document.getElementById('shopName').value = n; document.getElementById('shopPhone').value = p; document.getElementById('shopSearch').value = n;
    document.getElementById('ledgerResults').classList.add('hidden');
}

function filterProducts(q) {
    const l = document.getElementById('searchList'); if(!q) { l.classList.add('hidden'); return; }
    const f = prods.filter(p => p.name.toLowerCase().includes(q.toLowerCase()));
    l.innerHTML = f.map(p => `<div class="p-4 border-b font-black text-[10px] flex justify-between uppercase" onclick="selectProduct('${p.name}', ${p.price})"><span>${p.name}</span><span class="text-blue-500">Rs ${p.price}</span></div>`).join('');
    l.classList.remove('hidden');
}

function selectProduct(n, p) {
    document.getElementById('pSearch').value = n; document.getElementById('pPrice').value = p; document.getElementById('searchList').classList.add('hidden');
}

function addToCart() {
    let n = document.getElementById('pSearch').value, p = Number(document.getElementById('pPrice').value), q = Number(document.getElementById('pQty').value);
    if(n && q > 0) { cart.push({ name: n, price: p, qty: q, subtotal: p*q }); renderCart(); document.getElementById('pSearch').value = ""; }
}

function renderCart() {
    document.getElementById('cartItems').innerHTML = cart.map((i, idx) => `<div class="flex justify-between items-center p-3 bg-slate-50 rounded-2xl border-l-4 border-blue-500 font-black text-[10px] italic"><span>${i.name} (x${i.qty})</span><span>Rs ${i.subtotal}</span></div>`).join('');
    document.getElementById('billTotal').innerText = cart.reduce((s, i) => s + i.subtotal, 0).toLocaleString();
}

function renderLedger(f = "") {
    const list = document.getElementById('ledgerScreenList'); list.innerHTML = "";
    ledger.filter(c => c.name.toLowerCase().includes(f.toLowerCase())).forEach(c => {
        const uId = `pay-${c.id.replace(/\s+/g, '')}`;
        list.innerHTML += `<div class="bg-slate-50 p-5 rounded-[2rem] border border-slate-100"><div class="flex justify-between mb-3"><div><p class="font-black text-xs uppercase">${c.name}</p></div><p class="text-rose-600 font-black italic text-xs">Bal: Rs ${Number(c.balance || 0).toLocaleString()}</p></div><div class="flex gap-2"><input id="${uId}" type="number" placeholder="Amt" class="flex-1 p-3 bg-white border rounded-xl text-xs font-black outline-none"><button onclick="requestCashApproval('${c.id}', '${c.name}', '${uId}')" class="bg-indigo-600 text-white px-4 py-2 rounded-xl text-[9px] font-black uppercase">Request</button></div></div>`;
    });
}

function renderStock() {
    document.getElementById('stockList').innerHTML = prods.map(p => `<div class="flex justify-between p-4 bg-slate-50 rounded-2xl border font-black text-[10px] uppercase italic"><span>${p.name}</span><span class="text-emerald-600">Stock: ${p.stock}</span></div>`).join('');
}

function showTab(id, btn) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active-tab'));
    document.getElementById(id).classList.add('active-tab');
    document.querySelectorAll('nav button').forEach(b => b.classList.remove('nav-active'));
    btn.classList.add('nav-active');
}

function previewPhoto(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = e => { document.getElementById('pImg').src = e.target.result; document.getElementById('pImg').classList.remove('hidden'); document.getElementById('camIcon').classList.add('hidden'); };
        reader.readAsDataURL(input.files[0]);
    }
}

function sendDaySummary() {
    const oTotal = document.getElementById('dayTotal').innerText;
    const cTotal = document.getElementById('cashTotal').innerText;
        let msg = `ðŸ“Š *DAILY SUMMARY*%0AðŸ“… *Date:* ${getToday().format1}%0Aâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”%0AðŸ“¦ *Total Booking:* Rs ${oTotal}%0AðŸ’¸ *Pending Recovery:* Rs ${cTotal}%0Aâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”%0A_Generated by GM Booker Pro_`;
    window.location.href = `https://api.whatsapp.com/send?phone=${BOSS_WA}&text=${msg}`;
}

   // 1. Distance Calculation Formula
function getDistance(lat1, lon1, lat2, lon2) {
    if (!lat1 || !lon1 || !lat2 || !lon2) return "N/A";
    const R = 6371e3; // Meters
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return Math.round(R * c);
}



// 2. Tracking List Update Logic
// 2. Tracking List Update Logic (Step 3: Route-Wise Filter)
function updateTrackingList() {
    const visitList = document.getElementById('visitList');
    const totalVisits = document.getElementById('totalVisits');
    const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    const todayName = days[new Date().getDay()]; 

    if (!visitList || !totalVisits) return;

    // 1. Sales se aaj ke orders ka data lo
    db.collection("sales").onSnapshot(salesSnap => {
        let visitedShops = new Set();
        salesSnap.forEach(doc => {
            const sd = doc.data();
            const dts = getToday();
            if(sd.date === dts.format1 || sd.date === dts.format2) {
                visitedShops.add(sd.customer);
            }
        });

        // 2. Customers se aaj ke Route (visitDay) wali dukanain lo
        db.collection("customers").where("visitDay", "==", todayName).onSnapshot(custSnap => {
            let html = '';
            let count = 0;

            custSnap.forEach(doc => {
                const c = doc.data();
                const isDone = visitedShops.has(c.name);
                count++;

                html += `
                <div class="flex items-center justify-between ${isDone ? 'bg-emerald-900/30' : 'bg-slate-800/60'} p-4 rounded-2xl mb-3 border ${isDone ? 'border-emerald-500/50' : 'border-slate-700'}">
                    <div class="flex items-center gap-3">
                        <div class="${isDone ? 'text-emerald-400' : 'text-slate-500'}">
                            <i class="fa-solid ${isDone ? 'fa-circle-check' : 'fa-clock'} text-lg"></i>
                        </div>
                        <div>
                            <p class="font-bold ${isDone ? 'text-emerald-100' : 'text-white'} text-[12px] uppercase">${c.name}</p>
                            <p class="text-[10px] text-slate-400 font-bold italic">${todayName} Route</p>
                        </div>
                    </div>
                    <div class="text-right">
                        ${isDone ? 
                            '<span class="bg-emerald-500/20 text-emerald-400 text-[8px] font-black px-3 py-1 rounded-full uppercase">DONE</span>' : 
                            '<span class="bg-rose-500/20 text-rose-400 text-[8px] font-black px-3 py-1 rounded-full uppercase animate-pulse">PENDING</span>'
                        }
                    </div>
                </div>`;
            });

            visitList.innerHTML = html || `<div class="text-center py-10 text-slate-500 text-[10px] italic">No shops scheduled for ${todayName}</div>`;
            totalVisits.innerText = visitedShops.size + " / " + count;
        });
    });
}

// System ko start karein
updateTrackingList();
    
    
</script>
</body>
</html>

    
