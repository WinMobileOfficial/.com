<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GM Booker | Official App</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; font-style: italic; overflow-x: hidden; }
        .tab-content { display: none; }
        .active-tab { display: block; }
        .nav-active { color: #3b82f6 !important; transform: scale(1.1); }
        .search-results { position: absolute; width: 100%; background: white; z-index: 100; border-radius: 1rem; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2); max-height: 200px; overflow-y: auto; }
        input::placeholder { font-style: italic; opacity: 0.6; }
    </style>
</head>
<body class="bg-slate-900 pb-28">

<div id="lockScreen" class="fixed inset-0 bg-[#0f172a] z-[9999] flex flex-col items-center justify-center text-white p-6">
    <div class="bg-slate-800 p-8 rounded-[3rem] shadow-2xl text-center border-2 border-slate-700 w-full max-w-xs">
        <div class="w-20 h-20 bg-blue-600 rounded-3xl mx-auto mb-6 flex items-center justify-center shadow-lg shadow-blue-500/20">
            <i class="fas fa-user-tie text-4xl"></i>
        </div>
        <h1 class="text-xl font-black mb-6 text-blue-400 italic uppercase tracking-widest">GM BOOKER LOGIN</h1>
        <input id="bookerPin" type="password" inputmode="numeric" placeholder="ENTER PIN" class="w-full p-4 rounded-2xl text-black text-center text-3xl font-black mb-4 outline-none border-4 border-blue-500 shadow-inner">
        <button onclick="checkPin()" class="w-full bg-blue-600 hover:bg-blue-500 py-4 rounded-2xl font-black uppercase italic transition-all active:scale-95 shadow-lg">Unlock App</button>
    </div>
</div>

<div id="mainApp" class="hidden">
    <div class="p-6 text-white border-b border-white/10 flex justify-between items-center bg-slate-800 rounded-b-[2.5rem] shadow-2xl">
        <div>
            <h1 class="text-lg font-black italic text-blue-400 uppercase leading-none">GM AGENCY</h1>
            <p id="gpsStatus" class="text-[9px] font-black text-rose-400 uppercase mt-1 animate-pulse italic">GPS: OFF</p>
        </div>
        <div class="text-right">
            <p class="text-[9px] opacity-60 uppercase font-black italic">Today's Sales</p>
            <p class="text-2xl font-black italic text-emerald-400">Rs <span id="dayTotal">0</span></p>
        </div>
    </div>

    <div class="p-4 max-w-md mx-auto">
        <div id="orderTab" class="tab-content active-tab space-y-4">
            
            <div class="bg-white p-5 rounded-[2.2rem] shadow-xl relative border-b-8 border-blue-500">
                <p class="text-[10px] font-black text-slate-400 mb-2 uppercase italic tracking-tighter"><i class="fas fa-store mr-1"></i> Customer Information</p>
                <div class="relative">
                    <input id="shopSearch" oninput="searchLedger(this.value)" placeholder="SEARCH SHOP OR TYPE NAME..." class="w-full p-4 border-2 rounded-2xl mb-2 font-black uppercase outline-none bg-slate-50 text-sm italic border-slate-100 focus:border-blue-400 transition-all">
                    <div id="ledgerResults" class="search-results hidden border"></div>
                </div>
                
                <div class="grid grid-cols-2 gap-2">
                    <input id="shopName" placeholder="SHOP NAME" class="w-full p-3 bg-blue-50 rounded-xl font-bold text-[11px] uppercase italic outline-none border border-blue-100">
                    <input id="shopPhone" type="tel" placeholder="PHONE NO" class="w-full p-3 bg-blue-50 rounded-xl font-bold text-[11px] outline-none border border-blue-100">
                </div>
                <p id="newCustNotice" class="hidden text-[9px] text-blue-600 font-black mt-2 animate-bounce italic uppercase text-center">‚ú® New Customer Detected!</p>
            </div>

            <div class="bg-white p-5 rounded-[2.2rem] shadow-xl border-b-8 border-slate-300">
                <p class="text-[10px] font-black text-slate-400 mb-2 uppercase italic tracking-tighter"><i class="fas fa-box-open mr-1"></i> Add Items to Cart</p>
                <div class="relative mb-2">
                    <input id="pSearch" oninput="filterProducts(this.value)" placeholder="SEARCH PRODUCT..." class="w-full p-4 border-2 rounded-2xl font-black uppercase outline-none bg-emerald-50 italic text-sm border-emerald-100">
                    <div id="searchList" class="search-results hidden border"></div>
                </div>
                <div class="grid grid-cols-2 gap-2 mb-3">
                    <div class="bg-slate-100 rounded-2xl p-3 text-center border">
                        <p class="text-[8px] font-black text-slate-400 uppercase">Rate</p>
                        <input id="pPrice" type="number" readonly value="0" class="w-full bg-transparent font-black text-center outline-none">
                    </div>
                    <div class="bg-white rounded-2xl p-3 text-center border-2 border-emerald-400">
                        <p class="text-[8px] font-black text-emerald-600 uppercase">Quantity</p>
                        <input id="pQty" type="number" value="1" min="1" class="w-full font-black text-center outline-none">
                    </div>
                </div>
                <button onclick="addToCart()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-black uppercase italic text-xs hover:bg-blue-600 transition-all active:scale-95 shadow-lg">
                    <i class="fas fa-plus-circle mr-2"></i> Add Item
                </button>

                <div id="cartItems" class="mt-4 space-y-2 max-h-48 overflow-y-auto pr-1"></div>
            </div>

            <div class="bg-white p-5 rounded-[2.2rem] shadow-xl text-center border-b-8 border-slate-400">
                <input type="file" id="shopPhoto" accept="image/*" capture="camera" class="hidden" onchange="previewPhoto(this)">
                <div onclick="document.getElementById('shopPhoto').click()" class="w-full h-28 border-2 border-dashed border-slate-300 rounded-3xl flex items-center justify-center text-slate-400 bg-slate-50 overflow-hidden relative cursor-pointer active:scale-95 transition-all">
                    <img id="pImg" class="hidden h-full w-full object-cover">
                    <div id="camIcon" class="text-center">
                        <i class="fas fa-camera text-3xl mb-1 text-slate-300"></i>
                        <p class="text-[9px] font-black uppercase italic">Snap Shop Front</p>
                    </div>
                </div>
            </div>

            <div class="bg-slate-800 p-6 rounded-[2.5rem] shadow-2xl border-2 border-white/5">
                <div class="flex justify-between items-center mb-5 px-2">
                    <span class="text-white font-black text-xs italic uppercase tracking-widest">Grand Total:</span>
                    <span class="text-blue-400 font-black text-3xl italic">Rs <span id="billTotal">0</span></span>
                </div>
                <button id="submitBtn" onclick="finalSubmit()" class="w-full bg-emerald-500 hover:bg-emerald-400 text-slate-900 py-5 rounded-[1.8rem] font-black uppercase italic shadow-[0_10px_30px_-10px_rgba(16,185,129,0.5)] active:scale-95 transition-all flex items-center justify-center gap-3">
                    <i class="fab fa-whatsapp text-xl"></i> Confirm & Send WA
                </button>
            </div>
        </div>

        <div id="stockTab" class="tab-content">
            <div class="bg-white p-6 rounded-[2.5rem] shadow-xl border-b-8 border-blue-500">
                <h2 class="font-black text-center mb-6 border-b-2 pb-3 italic text-slate-800 uppercase tracking-widest">
                    <i class="fas fa-warehouse mr-2"></i>Live Stock
                </h2>
                <div id="stockList" class="space-y-3"></div>
            </div>
        </div>
    </div>

    <nav class="fixed bottom-6 left-6 right-6 bg-white/90 backdrop-blur-md shadow-2xl rounded-[2.5rem] flex justify-around p-4 z-[100] border-t border-white">
        <button onclick="showTab('orderTab', this)" class="flex flex-col items-center font-black uppercase italic text-[10px] nav-active transition-all">
            <i class="fas fa-shopping-bag text-xl mb-1"></i> Order
        </button>
        <button onclick="showTab('stockTab', this)" class="flex flex-col items-center text-slate-400 font-black uppercase italic text-[10px] transition-all">
            <i class="fas fa-layer-group text-xl mb-1"></i> Stock
        </button>
    </nav>
</div>

<script>
// Firebase Config
const firebaseConfig = { apiKey: "AIzaSyBP3VrLzUl5AIR2ca1v871cV-cJOMz-SX0", authDomain: "gm-agency-pos.firebaseapp.com", projectId: "gm-agency-pos", storageBucket: "gm-agency-pos.firebasestorage.app", messagingSenderId: "777771332628", appId: "1:777771332628:web:db60e19d9bdcee21f76301" };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Fixed Config
const BOSS_WA = "923066442004";
const IMGBB_KEY = "ac9e20cc7634087a31f0cc92096c23f4";
let prods = [], ledger = [], cart = [], userLat = "", userLong = "";

function checkPin() {
    if(document.getElementById('bookerPin').value === "0001") {
        document.getElementById('lockScreen').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        getLocation();
        init();
    } else { alert("‚ùå WRONG PIN!"); }
}

function getLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
            userLat = pos.coords.latitude; userLong = pos.coords.longitude;
            const status = document.getElementById('gpsStatus');
            status.innerText = "GPS: ACTIVE ‚úì";
            status.classList.replace('text-rose-400', 'text-emerald-400');
            status.classList.remove('animate-pulse');
        }, () => { alert("Please enable GPS for Order Pinning."); });
    }
}

function init() {
    // Sync Stock
    db.collection("products").onSnapshot(snap => { 
        prods = snap.docs.map(doc => doc.data());
        renderStock();
    });
    // Sync Ledger
    db.collection("customers").onSnapshot(snap => {
        ledger = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    });
    // Sync Daily Target (Only Pending & Today)
    db.collection("sales")
      .where("status", "==", "PENDING")
      .where("date", "==", new Date().toLocaleDateString())
      .onSnapshot(snap => {
        let t = 0;
        snap.forEach(d => { t += Number(d.data().grandTotal); });
        document.getElementById('dayTotal').innerText = t.toLocaleString();
    });
}

function searchLedger(q) {
    const res = document.getElementById('ledgerResults');
    const nameBox = document.getElementById('shopName');
    const phoneBox = document.getElementById('shopPhone');
    const notice = document.getElementById('newCustNotice');
    if(!q) { res.classList.add('hidden'); nameBox.value = ""; notice.classList.add('hidden'); return; }
    
    nameBox.value = q.toUpperCase();
    const matches = ledger.filter(c => c.name.toLowerCase().includes(q.toLowerCase()) || c.id.includes(q));
    
    if(matches.length > 0) {
        notice.classList.add('hidden');
        res.innerHTML = matches.map(c => `
            <div class="p-4 border-b font-black text-[11px] uppercase italic bg-white active:bg-blue-50" onclick="selectLedger('${c.name}', '${c.id}')">
                <div class="text-slate-800">${c.name}</div>
                <div class="text-blue-500 text-[9px]">${c.id}</div>
            </div>`).join('');
        res.classList.remove('hidden');
    } else {
        notice.classList.remove('hidden');
        res.innerHTML = `<div class="p-4 text-[10px] font-black text-rose-500 bg-white italic uppercase"><i class="fas fa-plus mr-1"></i> Add As New Shop</div>`;
        res.classList.remove('hidden');
    }
}

function selectLedger(n, p) {
    document.getElementById('shopName').value = n;
    document.getElementById('shopPhone').value = p;
    document.getElementById('shopSearch').value = n;
    document.getElementById('ledgerResults').classList.add('hidden');
    document.getElementById('newCustNotice').classList.add('hidden');
}

function filterProducts(q) {
    const list = document.getElementById('searchList');
    if(!q) { list.classList.add('hidden'); return; }
    const filtered = prods.filter(p => p.name.toLowerCase().includes(q.toLowerCase()));
    list.innerHTML = filtered.map(p => `
        <div class="p-4 border-b flex justify-between font-black text-[11px] italic bg-white active:bg-emerald-50" onclick="selectProduct('${p.name}', ${p.price})">
            <span>${p.name}</span>
            <span class="text-emerald-600 font-black">Rs ${p.price}</span>
        </div>`).join('');
    list.classList.remove('hidden');
}

function selectProduct(n, p) {
    document.getElementById('pSearch').value = n;
    document.getElementById('pPrice').value = p;
    document.getElementById('searchList').classList.add('hidden');
    document.getElementById('pQty').focus();
}

function addToCart() {
    let n = document.getElementById('pSearch').value, 
        p = Number(document.getElementById('pPrice').value), 
        q = Number(document.getElementById('pQty').value);
    
    if(n && q > 0) {
        cart.push({ name: n, price: p, qty: q, subtotal: p*q });
        renderCart();
        // Reset Inputs
        document.getElementById('pSearch').value = "";
        document.getElementById('pPrice').value = "0";
        document.getElementById('pQty').value = "1";
    }
}

function renderCart() {
    document.getElementById('cartItems').innerHTML = cart.map((i, idx) => `
        <div class="flex justify-between items-center p-4 bg-slate-50 rounded-2xl border-l-4 border-blue-500 shadow-sm font-black uppercase text-[10px] italic">
            <div class="flex flex-col">
                <span>${i.name}</span>
                <span class="text-[8px] text-slate-400">Qty: ${i.qty} x ${i.price}</span>
            </div>
            <div class="flex items-center gap-4">
                <span class="text-blue-600">Rs ${i.subtotal}</span>
                <i onclick="cart.splice(${idx},1); renderCart()" class="fas fa-times-circle text-red-500 text-lg active:scale-125 transition-all"></i>
            </div>
        </div>`).join('');
    document.getElementById('billTotal').innerText = cart.reduce((s, i) => s + i.subtotal, 0).toLocaleString();
}

function renderStock() {
    document.getElementById('stockList').innerHTML = prods.map(p => `
        <div class="flex justify-between p-5 bg-slate-50 rounded-2xl border-2 font-black text-xs italic uppercase">
            <span class="text-slate-700">${p.name}</span>
            <span class="${p.stock < 10 ? 'text-red-600 animate-pulse' : 'text-emerald-600'} bg-white px-3 py-1 rounded-lg shadow-inner">
                STK: ${p.stock}
            </span>
        </div>`).join('');
}

function previewPhoto(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = e => {
            document.getElementById('pImg').src = e.target.result;
            document.getElementById('pImg').classList.remove('hidden');
            document.getElementById('camIcon').classList.add('hidden');
        };
        reader.readAsDataURL(input.files[0]);
    }
}

function showTab(id, btn) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active-tab'));
    document.getElementById(id).classList.add('active-tab');
    document.querySelectorAll('nav button').forEach(b => b.classList.remove('nav-active'));
    btn.classList.add('nav-active');
}

// FINAL SUBMIT (Order + Upload + Ledger + WhatsApp)
async function finalSubmit() {
    const shop = document.getElementById('shopName').value;
    const phone = document.getElementById('shopPhone').value;
    const photoFile = document.getElementById('shopPhoto').files[0];
    const btn = document.getElementById('submitBtn');

    if(!shop || !phone || cart.length === 0) return alert("‚ùå Name, Phone and Cart empty!");

    btn.disabled = true;
    btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> PROCESSING...`;

    let isNew = !ledger.some(l => l.id === phone);
    let orderId = "GM-" + Date.now().toString().slice(-6);
    let total = cart.reduce((s, i) => s + i.subtotal, 0);
    let mapsLink = userLat ? `https://www.google.com/maps?q=${userLat},${userLong}` : "GPS: OFF";
    let photoUrl = "No Photo";

    try {
        // 1. Upload to ImgBB
        if(photoFile) {
            let fd = new FormData();
            fd.append("image", photoFile);
            const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: "POST", body: fd });
            const data = await res.json();
            if(data.success) photoUrl = data.data.url;
        }

        // 2. Save Order to Database
        await db.collection("sales").doc(orderId).set({
            id: orderId, status: "PENDING", 
            customer: shop + (isNew ? " (NEW)" : ""), mob: phone,
            date: new Date().toLocaleDateString(), timestamp: Date.now(),
            items: [...cart], grandTotal: total, gps: mapsLink, img: photoUrl
        });

        // 3. Update Ledger if New
        if(isNew) {
            await db.collection("customers").doc(phone).set({
                name: shop.toUpperCase(), id: phone, balance: 0, dateAdded: new Date().toLocaleDateString()
            });
        }

        // 4. WhatsApp Message Logic
        let itemsT = cart.map(i => `‚Ä¢ ${i.name} (x${i.qty}) = ${i.subtotal}`).join('%0A');
        let waMsg = `üì¶ *GM AGENCY ORDER*%0A‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ%0AüÜî *Order ID:* ${orderId}%0Aüè™ *Shop:* ${shop.toUpperCase()}%0Aüìû *Phone:* ${phone}%0Aüí∞ *Bill Total:* Rs ${total.toLocaleString()}%0Aüì∏ *Photo:* ${photoUrl}%0A‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ%0A*ITEMS:*%0A${itemsT}%0A‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ%0Aüìç *Map:* ${mapsLink}`;

        // Redirect to WhatsApp Official API
        window.location.href = `https://api.whatsapp.com/send?phone=${BOSS_WA}&text=${waMsg}`;

        // Reset App after delay
        setTimeout(() => { location.reload(); }, 2000);

    } catch(e) { 
        console.error(e);
        alert("‚ùå System Error! Check Connection."); 
        btn.disabled = false; 
        btn.innerHTML = `<i class="fab fa-whatsapp text-xl"></i> Confirm & Send WA`; 
    }
}
</script>
</body>
</html>
