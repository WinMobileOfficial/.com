<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AL-HAFIZ ERP | SECURE VERSION</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&display=swap');
        body { font-family: 'Outfit', sans-serif; background: #f1f5f9; overflow-x: hidden; }
        .tab-content { display: none; padding-bottom: 100px; }
        .active { display: block; animation: zoomIn 0.3s ease; }
        @keyframes zoomIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        #lockScreen { position: fixed; inset: 0; background: #0f172a; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .pin-btn { width: 70px; height: 70px; border-radius: 50%; background: rgba(255,255,255,0.1); color: white; font-size: 1.5rem; font-weight: 900; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .pin-btn:active { background: #3b82f6; }
    </style>
</head>
<body>

<div id="lockScreen">
    <div class="mb-10 text-center">
        <i class="fa-solid fa-shield-halved text-blue-500 text-5xl mb-4"></i>
        <h2 class="text-white font-black tracking-widest uppercase">Enter Access PIN</h2>
        <div id="pinDots" class="flex gap-4 mt-6">
            <div class="w-4 h-4 rounded-full border-2 border-blue-500"></div>
            <div class="w-4 h-4 rounded-full border-2 border-blue-500"></div>
            <div class="w-4 h-4 rounded-full border-2 border-blue-500"></div>
            <div class="w-4 h-4 rounded-full border-2 border-blue-500"></div>
        </div>
    </div>
    <div class="grid grid-cols-3 gap-6">
        <div class="pin-btn" onclick="pressPin('1')">1</div>
        <div class="pin-btn" onclick="pressPin('2')">2</div>
        <div class="pin-btn" onclick="pressPin('3')">3</div>
        <div class="pin-btn" onclick="pressPin('4')">4</div>
        <div class="pin-btn" onclick="pressPin('5')">5</div>
        <div class="pin-btn" onclick="pressPin('6')">6</div>
        <div class="pin-btn" onclick="pressPin('7')">7</div>
        <div class="pin-btn" onclick="pressPin('8')">8</div>
        <div class="pin-btn" onclick="pressPin('9')">9</div>
        <div></div>
        <div class="pin-btn" onclick="pressPin('0')">0</div>
        <div class="pin-btn text-rose-500" onclick="clearPin()"><i class="fa-solid fa-rotate-left"></i></div>
    </div>
</div>

<div id="app" class="max-w-md mx-auto min-h-screen hidden">
    <div class="bg-[#0f172a] p-6 text-white rounded-b-[3rem] shadow-xl">
        <div class="flex justify-between items-center mb-6">
            <p class="text-[10px] font-black text-blue-400 tracking-[0.3em]">ERP VERSION 4.0</p>
            <div id="gpsBox" class="text-[9px] bg-white/10 px-3 py-1 rounded-full text-slate-300">GPS: <span id="gpsText" class="text-rose-500">OFF</span></div>
        </div>
        <div class="grid grid-cols-2 gap-4">
            <div class="bg-white/5 p-4 rounded-3xl border border-white/10">
                <p class="text-[8px] opacity-60">NET ASSET</p>
                <p class="text-lg font-black text-yellow-400" id="assetVal">Rs 0</p>
            </div>
            <div class="bg-white/5 p-4 rounded-3xl border border-white/10 text-right">
                <p class="text-[8px] opacity-60">ZAKAT (2.5%)</p>
                <p class="text-lg font-black text-emerald-400" id="zakatVal">Rs 0</p>
            </div>
        </div>
    </div>

    <div class="p-4">
        <div id="homeTab" class="tab-content active space-y-6">
            <div class="grid grid-cols-3 gap-4 mt-4">
                <div onclick="markAttendance()" class="flex flex-col items-center bg-white p-4 rounded-3xl shadow-sm border border-slate-100">
                    <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-2xl flex items-center justify-center mb-2"><i class="fa-solid fa-fingerprint text-xl"></i></div>
                    <span class="text-[9px] font-black uppercase">Attendance</span>
                </div>
                <div onclick="showTab('returnTab')" class="flex flex-col items-center bg-white p-4 rounded-3xl shadow-sm border border-slate-100">
                    <div class="w-12 h-12 bg-red-100 text-red-600 rounded-2xl flex items-center justify-center mb-2"><i class="fa-solid fa-box-open text-xl"></i></div>
                    <span class="text-[9px] font-black uppercase">Returns</span>
                </div>
                <div onclick="showTab('orderTab')" class="flex flex-col items-center bg-white p-4 rounded-3xl shadow-sm border border-slate-100">
                    <div class="w-12 h-12 bg-emerald-100 text-emerald-600 rounded-2xl flex items-center justify-center mb-2"><i class="fa-solid fa-plus-circle text-xl"></i></div>
                    <span class="text-[9px] font-black uppercase">New Order</span>
                </div>
                <div onclick="showTab('stockTab')" class="flex flex-col items-center bg-white p-4 rounded-3xl shadow-sm border border-slate-100">
                    <div class="w-12 h-12 bg-purple-100 text-purple-600 rounded-2xl flex items-center justify-center mb-2"><i class="fa-solid fa-boxes-stacked text-xl"></i></div>
                    <span class="text-[9px] font-black uppercase">Stock</span>
                </div>
                <div onclick="showTab('recoveryTab')" class="flex flex-col items-center bg-white p-4 rounded-3xl shadow-sm border border-slate-100">
                    <div class="w-12 h-12 bg-orange-100 text-orange-600 rounded-2xl flex items-center justify-center mb-2"><i class="fa-solid fa-hand-holding-dollar text-xl"></i></div>
                    <span class="text-[9px] font-black uppercase">Recovery</span>
                </div>
                <div onclick="alert('Broadcasting...')" class="flex flex-col items-center bg-white p-4 rounded-3xl shadow-sm border border-slate-100">
                    <div class="w-12 h-12 bg-pink-100 text-pink-600 rounded-2xl flex items-center justify-center mb-2"><i class="fa-solid fa-tower-broadcast text-xl"></i></div>
                    <span class="text-[9px] font-black uppercase">Message</span>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-slate-100">
                <h3 class="text-[10px] font-black uppercase text-slate-400 mb-4 tracking-widest">Recent Broadcasts</h3>
                <div id="bcList" class="space-y-3"></div>
            </div>
        </div>

        <div id="orderTab" class="tab-content space-y-4">
            <div class="bg-white p-5 rounded-[2.5rem] shadow-sm border border-slate-100">
                <div class="flex justify-between items-center mb-4">
                    <h4 class="text-[10px] font-black text-slate-400 uppercase">Customer Info</h4>
                    <button onclick="toggleNewShop()" id="newShopBtn" class="bg-blue-600 text-white px-3 py-1 rounded-full text-[9px] font-black">+ New Customer</button>
                </div>
                
                <div id="newShopInputs" class="hidden mb-4 p-4 bg-blue-50 rounded-2xl border-2 border-dashed border-blue-200">
                    <input id="nSName" placeholder="SHOP NAME" class="w-full p-3 rounded-xl mb-2 text-xs font-black uppercase outline-none">
                    <input id="nSPhone" placeholder="PHONE" class="w-full p-3 rounded-xl text-xs font-black outline-none">
                </div>

                <div id="searchShopBox">
                    <input id="shopSearch" oninput="searchShop(this.value)" placeholder="SEARCH SHOP..." class="w-full p-4 bg-slate-50 rounded-2xl font-black text-xs outline-none border focus:border-blue-500 uppercase italic">
                    <div id="shopResults" class="hidden mt-2 bg-white shadow-xl rounded-xl max-h-40 overflow-y-auto border border-blue-50 z-50 relative"></div>
                </div>
            </div>

            <div class="bg-white p-5 rounded-[2.5rem] shadow-sm border border-slate-100">
                <input id="pSearch" oninput="filterProds(this.value)" placeholder="SELECT ITEM..." class="w-full p-4 bg-slate-50 rounded-2xl font-black text-xs outline-none border focus:border-emerald-500 uppercase italic">
                <div id="pResults" class="hidden mt-2 bg-white shadow-xl rounded-xl max-h-40 overflow-y-auto border border-emerald-50 z-50 relative"></div>
                
                <div class="grid grid-cols-2 gap-4 mt-4">
                    <div class="flex items-center bg-slate-100 rounded-2xl p-1">
                        <input id="pQty" type="number" value="1" class="w-full bg-transparent text-center font-black text-xs outline-none" placeholder="QTY">
                    </div>
                    <button onclick="addToCart()" class="bg-slate-900 text-white rounded-2xl font-black text-[10px] uppercase">Add to List</button>
                </div>
                <div id="cartBox" class="mt-4 space-y-2"></div>
            </div>

            <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-slate-100">
                <div onclick="takePhoto()" id="photoZone" class="w-full h-32 border-4 border-dashed border-slate-100 rounded-[2rem] flex flex-col items-center justify-center bg-slate-50 mb-6 relative overflow-hidden">
                    <img id="prevImg" class="hidden w-full h-full object-cover">
                    <div id="camText"><i class="fa-solid fa-camera text-2xl text-slate-300"></i><p class="text-[8px] font-black text-slate-400 mt-2 uppercase tracking-widest">Shop Photo Required</p></div>
                </div>
                <input type="file" id="camInp" accept="image/*" capture="camera" class="hidden" onchange="previewImg(this)">
                
                <div class="flex justify-between items-center mb-6">
                    <div><p class="text-[9px] font-black text-slate-400 uppercase italic tracking-widest">Grand Total</p><p class="text-3xl font-black text-blue-600">Rs <span id="billTotal">0</span></p></div>
                </div>
                <button id="subBtn" onclick="submitOrder()" class="w-full bg-emerald-500 text-white py-5 rounded-[2rem] font-black uppercase italic shadow-lg shadow-emerald-100 flex items-center justify-center gap-3">
                    <i class="fab fa-whatsapp text-xl"></i> Confirm & Send
                </button>
            </div>
        </div>

        <div id="returnTab" class="tab-content space-y-4">
            <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border">
                <h3 class="text-xs font-black uppercase mb-4 text-red-600 italic">Damage/Expiry Return Form</h3>
                <input id="retShop" placeholder="SELECT SHOP" class="w-full p-4 bg-slate-50 rounded-2xl mb-3 font-black text-xs outline-none uppercase">
                <input id="retItem" placeholder="PRODUCT NAME" class="w-full p-4 bg-slate-50 rounded-2xl mb-3 font-black text-xs outline-none uppercase">
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <input id="retQty" type="number" placeholder="QTY" class="p-4 bg-slate-50 rounded-2xl font-black text-xs">
                    <select id="retType" class="p-4 bg-slate-100 rounded-2xl font-black text-[10px] uppercase outline-none">
                        <option>EXPIRY</option>
                        <option>DAMAGE</option>
                        <option>EXCHANGE</option>
                    </select>
                </div>
                <button onclick="submitReturn()" class="w-full bg-red-500 text-white py-4 rounded-[2rem] font-black uppercase text-[10px] shadow-lg">Submit Return Request</button>
            </div>
        </div>

        <div id="recoveryTab" class="tab-content space-y-4">
            <h3 class="text-xs font-black uppercase italic mb-4">Payment Collection</h3>
            <div id="recoveryList" class="space-y-4"></div>
        </div>

        <div id="stockTab" class="tab-content">
            <h3 class="text-xs font-black uppercase italic mb-6">Warehouse Inventory</h3>
            <div id="stockList" class="space-y-3"></div>
        </div>
    </div>

    <nav class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-md border-t p-4 flex justify-around items-center shadow-2xl z-[100]">
        <button onclick="showTab('homeTab', this)" class="nav-item nav-active p-3 px-5 flex flex-col items-center gap-1 text-slate-400 transition-all">
            <i class="fa-solid fa-home"></i><span class="text-[8px] font-black uppercase">Home</span>
        </button>
        <button onclick="showTab('orderTab', this)" class="nav-item p-3 px-5 flex flex-col items-center gap-1 text-slate-400 transition-all">
            <i class="fa-solid fa-cart-plus"></i><span class="text-[8px] font-black uppercase">Order</span>
        </button>
        <button onclick="showTab('recoveryTab', this)" class="nav-item p-3 px-5 flex flex-col items-center gap-1 text-slate-400 transition-all">
            <i class="fa-solid fa-sack-dollar"></i><span class="text-[8px] font-black uppercase">Dues</span>
        </button>
    </nav>
</div>

<script>
// CONFIG
const firebaseConfig = { apiKey: "AIzaSyBP3VrLzUl5AIR2ca1v871cV-cJOMz-SX0", authDomain: "gm-agency-pos.firebaseapp.com", projectId: "gm-agency-pos", storageBucket: "gm-agency-pos.firebasestorage.app", messagingSenderId: "777771332628", appId: "1:777771332628:web:db60e19d9bdcee21f76301" };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const BOSS_WA = "923066442004", IMGBB = "ac9e20cc7634087a31f0cc92096c23f4";

let shops = [], items = [], cart = [], lat = "", lon = "", isNew = false, currentPin = "";

// PIN LOCK LOGIC
function pressPin(n) {
    if(currentPin.length < 4) {
        currentPin += n;
        updatePinDots();
        if(currentPin === "0101") {
            document.getElementById('lockScreen').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
        } else if(currentPin.length === 4) {
            alert("Wrong PIN!"); clearPin();
        }
    }
}
function clearPin() { currentPin = ""; updatePinDots(); }
function updatePinDots() {
    const dots = document.querySelectorAll('#pinDots div');
    dots.forEach((d, i) => d.style.background = i < currentPin.length ? '#3b82f6' : 'transparent');
}

// GPS
if(navigator.geolocation) {
    navigator.geolocation.watchPosition(p => {
        lat = p.coords.latitude; lon = p.coords.longitude;
        document.getElementById('gpsText').innerText = "ACTIVE âœ“";
        document.getElementById('gpsText').className = "text-emerald-500 font-black";
    });
}

// DATA SYNC
db.collection("products").onSnapshot(s => {
    items = s.docs.map(d => ({id: d.id, ...d.data()}));
    let asset = items.reduce((a, i) => a + (Number(i.stock || 0) * Number(i.price || 0)), 0);
    document.getElementById('assetVal').innerText = "Rs " + asset.toLocaleString();
    document.getElementById('zakatVal').innerText = "Rs " + Math.floor(asset*0.025).toLocaleString();
    renderStock();
});
db.collection("customers").onSnapshot(s => { shops = s.docs.map(d => ({id: d.id, ...d.data()})); renderRecovery(); });
db.collection("broadcasts").limit(3).onSnapshot(s => {
    document.getElementById('bcList').innerHTML = s.docs.map(d => `<div class="p-3 bg-blue-50 rounded-2xl text-[10px] font-bold text-blue-700 border-l-4 border-blue-500">${d.data().msg}</div>`).join('');
});

// FUNCTIONS
function showTab(id, el) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    if(el) {
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('nav-active'));
        el.classList.add('nav-active');
    }
}

function toggleNewShop() {
    isNew = !isNew;
    document.getElementById('newShopInputs').classList.toggle('hidden');
    document.getElementById('searchShopBox').classList.toggle('hidden');
    document.getElementById('newShopBtn').innerText = isNew ? "Use Search" : "+ New Customer";
}

function searchShop(q) {
    const res = document.getElementById('shopResults'); if(!q) return res.classList.add('hidden');
    const f = shops.filter(s => s.name.toLowerCase().includes(q.toLowerCase()));
    res.innerHTML = f.map(s => `<div class="p-4 border-b font-black text-[11px] uppercase" onclick="pickShop('${s.name}')">${s.name}</div>`).join('');
    res.classList.remove('hidden');
}
function pickShop(n) { document.getElementById('shopSearch').value = n; document.getElementById('shopResults').classList.add('hidden'); }

function filterProds(q) {
    const res = document.getElementById('pResults'); if(!q) return res.classList.add('hidden');
    const f = items.filter(i => i.name.toLowerCase().includes(q.toLowerCase()));
    res.innerHTML = f.map(i => `<div class="p-4 border-b flex justify-between font-black text-[10px] uppercase" onclick="pickProd('${i.name}',${i.price})"><span>${i.name}</span><span class="text-blue-600">Rs ${i.price}</span></div>`).join('');
    res.classList.remove('hidden');
}
let selP = { name: '', price: 0 };
function pickProd(n, p) { selP = { name: n, price: p }; document.getElementById('pSearch').value = n; document.getElementById('pResults').classList.add('hidden'); }

function addToCart() {
    const q = Number(document.getElementById('pQty').value);
    if(selP.name && q > 0) {
        cart.push({ name: selP.name, price: selP.price, qty: q, sub: selP.price * q });
        renderCart();
        document.getElementById('pSearch').value = "";
    }
}
function renderCart() {
    document.getElementById('cartBox').innerHTML = cart.map((i,x) => `<div class="flex justify-between p-3 bg-slate-50 rounded-2xl border-l-4 border-blue-500 font-black text-[10px] uppercase"><span>${i.name} (x${i.qty})</span><span>Rs ${i.sub}</span></div>`).join('');
    document.getElementById('billTotal').innerText = cart.reduce((s,i) => s + i.sub, 0).toLocaleString();
}

function takePhoto() { document.getElementById('camInp').click(); }
function previewImg(i) {
    if (i.files && i.files[0]) {
        const r = new FileReader();
        r.onload = e => { 
            document.getElementById('prevImg').src = e.target.result;
            document.getElementById('prevImg').classList.remove('hidden');
            document.getElementById('camText').classList.add('hidden');
        };
        r.readAsDataURL(i.files[0]);
    }
}

async function submitOrder() {
    const btn = document.getElementById('subBtn');
    let shopName = isNew ? document.getElementById('nSName').value : document.getElementById('shopSearch').value;
    if(!shopName || cart.length === 0) return alert("Missing Info!");

    btn.disabled = true; btn.innerHTML = "Processing...";
    let imgLink = "NO_IMG", oid = "ALH-"+Date.now().toString().slice(-5);

    try {
        const photo = document.getElementById('camInp').files[0];
        if(photo) {
            let fd = new FormData(); fd.append("image", photo);
            const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB}`, { method: "POST", body: fd });
            const d = await res.json(); if(d.success) imgLink = d.data.url;
        }

        const data = {
            id: oid, customer: shopName, items: cart, grandTotal: cart.reduce((s,i) => s+i.sub, 0),
            status: "PENDING", img: imgLink, gps: `https://www.google.com/maps?q=${lat},${lon}`,
            date: new Date().toLocaleDateString(), timestamp: Date.now()
        };
        await db.collection("sales").doc(oid).set(data);
        if(isNew) await db.collection("customers").add({ name: shopName, phone: document.getElementById('nSPhone').value, balance: 0 });

        window.location.href = `https://api.whatsapp.com/send?phone=${BOSS_WA}&text=ðŸ¢ *ORDER: ${oid}*%0AðŸª *Shop:* ${shopName}%0AðŸ’° *Bill:* Rs ${data.grandTotal}%0AðŸ“¸ *Photo:* ${imgLink}%0AðŸ“ *Location:* ${data.gps}`;
    } catch(e) { btn.disabled = false; }
}

async function markAttendance() {
    await db.collection("attendance").add({ booker: "Waqar", date: new Date().toLocaleDateString(), time: new Date().toLocaleTimeString(), gps: `${lat},${lon}` });
    alert("Hazri Lag Gai!");
}

async function submitReturn() {
    const s = document.getElementById('retShop').value, i = document.getElementById('retItem').value, q = document.getElementById('retQty').value, t = document.getElementById('retType').value;
    if(!s || !i || !q) return alert("Fill All!");
    await db.collection("returns").add({ shop: s, item: i, qty: q, type: t, date: new Date().toLocaleDateString(), status: "PENDING" });
    alert("Wapsi Request Sent!"); location.reload();
}

function renderStock() {
    document.getElementById('stockList').innerHTML = items.map(i => `
        <div class="p-4 bg-white rounded-2xl flex justify-between items-center border-b-2 ${i.stock < 10 ? 'border-red-200 bg-red-50' : 'border-slate-50'} shadow-sm">
            <span class="font-black text-[11px] uppercase text-slate-700">${i.name}</span>
            <span class="font-black text-[10px] ${i.stock < 10 ? 'text-red-600' : 'text-blue-600'}">${i.stock || 0} PCS</span>
        </div>`).join('');
}

function renderRecovery() {
    document.getElementById('recoveryList').innerHTML = shops.map(s => `
        <div class="bg-white p-5 rounded-[2rem] flex justify-between items-center shadow-sm border border-slate-50">
            <div><p class="font-black text-xs uppercase">${s.name}</p><p class="text-[9px] text-rose-500 font-bold italic uppercase">Udhari: Rs ${s.balance || 0}</p></div>
            <div class="flex gap-1"><input id="rec-${s.id}" type="number" placeholder="Rs" class="w-16 p-2 bg-slate-50 rounded-xl text-xs font-bold border"><button onclick="reqRec('${s.id}','${s.name}')" class="bg-blue-600 text-white p-2 px-3 rounded-xl text-[8px] font-black uppercase">Rec</button></div>
        </div>`).join('');
}
async function reqRec(id, name) {
    const a = document.getElementById(`rec-${id}`).value; if(!a) return;
    await db.collection("cash_requests").add({ customerName: name, amount: Number(a), status: "PENDING", date: new Date().toLocaleDateString() });
    alert("Recovery Request Sent!");
}
</script>
</body>
</html>
