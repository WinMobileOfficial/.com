<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GM Booker Pro | Al-Hafiz Traders</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; }
        .tab-content { display: none; }
        .active-tab { display: block; animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .nav-active { color: #3b82f6 !important; border-top: 3px solid #3b82f6; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .search-results { position: absolute; width: 100%; background: white; z-index: 100; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); max-height: 200px; overflow-y: auto; color: #1e293b; }
    </style>
</head>
<body class="pb-24">

<div id="mainApp">
    <div class="p-6 bg-slate-800 text-white rounded-b-[2rem] shadow-2xl border-b border-blue-500/30">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-xl font-extrabold tracking-tighter text-blue-400">AL-HAFIZ TRADERS</h1>
                <div class="flex items-center gap-2 mt-1">
                    <span class="w-2 h-2 bg-emerald-500 rounded-full animate-ping"></span>
                    <p id="gpsStatus" class="text-[10px] font-bold text-emerald-400 uppercase tracking-widest">System Online</p>
                </div>
            </div>
            <div class="text-right bg-slate-900/50 p-3 rounded-2xl border border-white/5">
                <p class="text-[9px] opacity-50 uppercase font-bold tracking-widest">Today's Sale</p>
                <p class="text-xl font-black text-emerald-400 italic">Rs <span id="dayTotal">0</span></p>
            </div>
        </div>
    </div>

    <div class="p-4 max-w-md mx-auto space-y-4">
        
        <div id="orderTab" class="tab-content active-tab space-y-4">
            <div class="bg-white rounded-3xl p-5 shadow-xl border-b-4 border-blue-500">
                <label class="text-[10px] font-bold text-slate-400 uppercase mb-2 block tracking-widest">Select Customer</label>
                <div class="relative">
                    <i class="fas fa-search absolute left-4 top-4 text-slate-400"></i>
                    <input id="shopSearch" oninput="searchLedger(this.value)" placeholder="Search Shop Name..." class="w-full p-4 pl-12 border-2 border-slate-100 rounded-2xl mb-3 font-bold outline-none focus:border-blue-400 transition-all">
                    <div id="ledgerResults" class="search-results hidden"></div>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <div class="p-3 bg-slate-50 rounded-xl border border-slate-100">
                        <p class="text-[8px] text-slate-400 uppercase font-bold">Shop</p>
                        <input id="shopName" readonly class="w-full bg-transparent font-bold text-[11px] outline-none text-slate-700">
                    </div>
                    <div class="p-3 bg-slate-50 rounded-xl border border-slate-100">
                        <p class="text-[8px] text-slate-400 uppercase font-bold">Contact</p>
                        <input id="shopPhone" readonly class="w-full bg-transparent font-bold text-[11px] outline-none text-slate-700">
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-3xl p-5 shadow-xl border-b-4 border-slate-200">
                <label class="text-[10px] font-bold text-slate-400 uppercase mb-2 block tracking-widest">Product Catalog</label>
                <div class="relative mb-3">
                    <input id="pSearch" oninput="filterProducts(this.value)" placeholder="Find Product..." class="w-full p-4 border-2 border-slate-100 rounded-2xl font-bold outline-none focus:border-emerald-400">
                    <div id="searchList" class="search-results hidden"></div>
                </div>
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div class="bg-slate-50 p-3 rounded-2xl border text-center">
                        <span class="text-[8px] block font-bold text-slate-400 uppercase">Rate</span>
                        <input id="pPrice" type="number" readonly value="0" class="w-full bg-transparent text-center font-black text-slate-800">
                    </div>
                    <div class="bg-white p-3 rounded-2xl border-2 border-emerald-500 text-center">
                        <span class="text-[8px] block font-bold text-emerald-600 uppercase">Qty</span>
                        <input id="pQty" type="number" value="1" class="w-full text-center font-black outline-none">
                    </div>
                </div>
                <button onclick="addToCart()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold uppercase tracking-widest text-xs hover:bg-blue-600 transition-all shadow-lg active:scale-95">
                    <i class="fas fa-cart-plus mr-2"></i> Add to Order
                </button>
                <div id="cartItems" class="mt-4 space-y-2"></div>
            </div>

            <div class="bg-slate-800 p-6 rounded-[2.5rem] shadow-2xl border border-white/10">
                <div class="flex justify-between items-center mb-6">
                    <span class="text-white/60 font-bold text-xs uppercase tracking-widest">Total Amount</span>
                    <span class="text-blue-400 font-black text-3xl italic">Rs <span id="billTotal">0</span></span>
                </div>
                <button id="submitBtn" onclick="finalSubmit()" class="w-full bg-emerald-500 text-slate-900 py-5 rounded-3xl font-black uppercase tracking-tighter hover:bg-emerald-400 transition-all flex items-center justify-center gap-3 shadow-[0_10px_20px_rgba(16,185,129,0.3)]">
                    <i class="fab fa-whatsapp text-xl"></i> Confirm Order
                </button>
            </div>
        </div>

        <div id="ledgerTab" class="tab-content">
            <div class="bg-white p-6 rounded-[2.5rem] shadow-xl border-b-8 border-indigo-500">
                <div class="flex justify-between items-center mb-6 border-b pb-4">
                    <h2 class="font-black text-slate-800 uppercase italic">Recovery / Ledger</h2>
                    <i class="fas fa-book-medical text-indigo-500 text-xl"></i>
                </div>
                <input type="text" onkeyup="renderLedger(this.value)" placeholder="Search Shop for Payment..." class="w-full p-4 rounded-2xl bg-slate-100 mb-6 font-bold outline-none border-2 border-transparent focus:border-indigo-400">
                <div id="ledgerScreenList" class="space-y-4 max-h-[50vh] overflow-y-auto pr-2"></div>
            </div>
        </div>

        <div id="stockTab" class="tab-content">
            <div class="bg-white p-6 rounded-[2.5rem] shadow-xl border-b-8 border-blue-500">
                <h2 class="font-black text-center mb-6 text-slate-800 uppercase italic border-b pb-4">Warehouse Stock</h2>
                <div id="stockList" class="space-y-3"></div>
            </div>
        </div>

    </div>

    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 flex justify-around p-3 pb-6 z-[100] shadow-[0_-10px_25px_rgba(0,0,0,0.05)]">
        <button onclick="showTab('orderTab', this)" class="flex flex-col items-center gap-1 text-slate-400 font-bold uppercase text-[9px] px-6 py-2 transition-all nav-active">
            <i class="fas fa-shopping-bag text-xl"></i> Order
        </button>
        <button onclick="showTab('ledgerTab', this)" class="flex flex-col items-center gap-1 text-slate-400 font-bold uppercase text-[9px] px-6 py-2 transition-all">
            <i class="fas fa-wallet text-xl"></i> Ledger
        </button>
        <button onclick="showTab('stockTab', this)" class="flex flex-col items-center gap-1 text-slate-400 font-bold uppercase text-[9px] px-6 py-2 transition-all">
            <i class="fas fa-boxes text-xl"></i> Stock
        </button>
    </nav>
</div>

<script>
// Firebase Initialization
const firebaseConfig = { apiKey: "AIzaSyBP3VrLzUl5AIR2ca1v871cV-cJOMz-SX0", authDomain: "gm-agency-pos.firebaseapp.com", projectId: "gm-agency-pos", storageBucket: "gm-agency-pos.firebasestorage.app", messagingSenderId: "777771332628", appId: "1:777771332628:web:db60e19d9bdcee21f76301" };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let prods = [], ledger = [], cart = [];
const BOSS_WA = "923066442004";
const getToday = () => new Date().toLocaleDateString('en-GB');

// Initial Sync
function init() {
    // Products & Stock Sync
    db.collection("products").onSnapshot(snap => { 
        prods = snap.docs.map(doc => doc.data()); 
        renderStock(); 
    });

    // Ledger Sync
    db.collection("customers").onSnapshot(snap => { 
        ledger = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); 
        renderLedger(); 
    });

    // Today's Sales Counter (STRICT FILTER)
    db.collection("sales").where("date", "==", getToday()).onSnapshot(snap => {
        let t = 0;
        snap.forEach(d => t += Number(d.data().grandTotal || 0));
        document.getElementById('dayTotal').innerText = t.toLocaleString();
    });
}

// PROFESSIONAL LEDGER SYSTEM
function renderLedger(f = "") {
    const list = document.getElementById('ledgerScreenList');
    list.innerHTML = "";
    ledger.filter(c => c.name.toLowerCase().includes(f.toLowerCase())).forEach(c => {
        const uniqueId = `pay-${c.id.replace(/\s+/g, '')}`;
        list.innerHTML += `
            <div class="bg-slate-50 p-5 rounded-3xl border border-slate-100 shadow-sm">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <p class="font-extrabold text-slate-800 uppercase text-xs">${c.name}</p>
                        <p class="text-[9px] text-slate-400 font-bold tracking-widest">${c.id}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-[8px] font-bold text-slate-400 uppercase">Balance</p>
                        <p class="text-rose-600 font-black italic">Rs ${Number(c.balance || 0).toLocaleString()}</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <input id="${uniqueId}" type="number" placeholder="Amt Received" class="flex-1 p-3 bg-white border border-slate-200 rounded-xl text-xs font-bold outline-none focus:border-indigo-400">
                    <button onclick="processPayment('${c.id}', '${c.name}', '${uniqueId}')" class="bg-indigo-600 text-white px-6 py-3 rounded-xl text-[10px] font-black uppercase shadow-lg active:scale-95">Collect</button>
                </div>
            </div>`;
    });
}

async function processPayment(id, name, inputId) {
    const amt = Number(document.getElementById(inputId).value);
    if(!amt || amt <= 0) return alert("âŒ Please enter a valid amount!");

    if(confirm(`Confirm Rs ${amt} received from ${name}?`)) {
        try {
            const ref = db.collection("customers").doc(id);
            const doc = await ref.get();
            const newBalance = (Number(doc.data().balance) || 0) - amt;
            
            await ref.update({ balance: newBalance });
            await db.collection("transactions").add({
                customer: name, phone: id, amount: amt, date: getToday(), timestamp: Date.now(), type: "RECOVERY"
            });

            alert("âœ… Payment processed and balance updated!");
            document.getElementById(inputId).value = "";
        } catch(e) { alert("System Error!"); }
    }
}

// ORDER & CART LOGIC
function addToCart() {
    let n = document.getElementById('pSearch').value, p = Number(document.getElementById('pPrice').value), q = Number(document.getElementById('pQty').value);
    if(!n || q <= 0) return alert("Select product and quantity!");
    
    cart.push({ name: n, price: p, qty: q, subtotal: p*q });
    renderCart();
    document.getElementById('pSearch').value = ""; document.getElementById('pPrice').value = "0";
}

function renderCart() {
    const list = document.getElementById('cartItems');
    list.innerHTML = cart.map((i, idx) => `
        <div class="flex justify-between items-center p-4 bg-slate-50 rounded-2xl border-l-4 border-blue-500 font-bold text-[10px] italic">
            <span>${i.name} (x${i.qty})</span>
            <div class="flex items-center gap-4">
                <span class="text-blue-600">Rs ${i.subtotal}</span>
                <i onclick="cart.splice(${idx},1); renderCart()" class="fas fa-trash text-red-400 text-sm active:scale-125 transition-all"></i>
            </div>
        </div>`).join('');
    document.getElementById('billTotal').innerText = cart.reduce((s, i) => s + i.subtotal, 0).toLocaleString();
}

async function finalSubmit() {
    const shop = document.getElementById('shopName').value, phone = document.getElementById('shopPhone').value, btn = document.getElementById('submitBtn');
    if(!shop || cart.length === 0) return alert("âŒ Cart or Shop empty!");

    btn.disabled = true; btn.innerHTML = "Processing...";
    let orderId = "ALH-" + Date.now().toString().slice(-5), total = cart.reduce((s, i) => s + i.subtotal, 0);

    try {
        await db.collection("sales").doc(orderId).set({
            id: orderId, customer: shop, mob: phone, date: getToday(), items: [...cart], grandTotal: total, timestamp: Date.now()
        });

        let itemsMsg = cart.map(i => `â€¢ ${i.name} (x${i.qty}) = ${i.subtotal}`).join('%0A');
        let waMsg = `ðŸ¢ *AL-HAFIZ TRADERS - INVOICE*%0Aâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”%0AðŸ†” *Order ID:* ${orderId}%0AðŸª *Shop:* ${shop}%0AðŸ’° *Amount:* Rs ${total.toLocaleString()}%0AðŸ“… *Date:* ${getToday()}%0Aâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”%0AðŸ›’ *ITEMS:*%0A${itemsMsg}%0Aâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”%0A_Generated via GM Booker Pro_`;

        window.location.href = `https://api.whatsapp.com/send?phone=${BOSS_WA}&text=${waMsg}`;
        setTimeout(() => location.reload(), 2000);
    } catch(e) { btn.disabled = false; alert("Error!"); }
}

// NAVIGATION & SEARCH
function showTab(id, btn) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active-tab'));
    document.getElementById(id).classList.add('active-tab');
    document.querySelectorAll('nav button').forEach(b => b.classList.remove('nav-active'));
    btn.classList.add('nav-active');
}

function searchLedger(q) {
    const res = document.getElementById('ledgerResults');
    if(!q) { res.classList.add('hidden'); return; }
    const matches = ledger.filter(c => c.name.toLowerCase().includes(q.toLowerCase()));
    res.innerHTML = matches.map(c => `<div class="p-4 border-b font-bold text-xs hover:bg-slate-50" onclick="selectLedger('${c.name}', '${c.id}')">${c.name}</div>`).join('');
    res.classList.remove('hidden');
}

function selectLedger(n, p) {
    document.getElementById('shopName').value = n;
    document.getElementById('shopPhone').value = p;
    document.getElementById('shopSearch').value = n;
    document.getElementById('ledgerResults').classList.add('hidden');
}

function filterProducts(q) {
    const list = document.getElementById('searchList');
    if(!q) { list.classList.add('hidden'); return; }
    const filtered = prods.filter(p => p.name.toLowerCase().includes(q.toLowerCase()));
    list.innerHTML = filtered.map(p => `<div class="p-4 border-b font-bold text-xs flex justify-between" onclick="selectProduct('${p.name}', ${p.price})"><span>${p.name}</span><span class="text-blue-500">Rs ${p.price}</span></div>`).join('');
    list.classList.remove('hidden');
}

function selectProduct(n, p) {
    document.getElementById('pSearch').value = n;
    document.getElementById('pPrice').value = p;
    document.getElementById('searchList').classList.add('hidden');
}

function renderStock() {
    document.getElementById('stockList').innerHTML = prods.map(p => `
        <div class="flex justify-between p-4 bg-slate-50 rounded-2xl border border-slate-100 font-bold text-xs italic">
            <span class="text-slate-700">${p.name}</span>
            <span class="text-emerald-600 bg-emerald-50 px-3 py-1 rounded-lg">Stock: ${p.stock}</span>
        </div>`).join('');
}

init();
</script>
</body>
</html>
