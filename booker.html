<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GM Booker | Sales Tracker</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; font-style: italic; }
        .tab-content { display: none; }
        .active-tab { display: block; }
        .nav-active { color: #2563eb !important; transform: scale(1.1); }
    </style>
</head>
<body class="bg-slate-100 pb-24">

<div id="lockScreen" class="fixed inset-0 bg-[#0f172a] z-[9999] flex flex-col items-center justify-center text-white p-6">
    <div class="bg-slate-800 p-8 rounded-[3rem] shadow-2xl text-center border-2 border-slate-700 w-full max-w-xs">
        <h1 class="text-xl font-black mb-6 text-blue-400 italic uppercase">GM BOOKER LOGIN</h1>
        <input id="bookerPin" type="password" placeholder="PIN" class="w-full p-4 rounded-2xl text-black text-center text-3xl font-black mb-4 outline-none border-4 border-blue-500">
        <button onclick="checkPin()" class="w-full bg-blue-600 py-4 rounded-2xl font-black uppercase italic">Unlock</button>
    </div>
</div>

<div id="mainApp" class="hidden">
    <div class="bg-[#0f172a] p-6 text-white shadow-2xl rounded-b-[2.5rem] border-b-4 border-blue-500">
        <div class="flex justify-between items-center">
            <div class="text-left">
                <h1 class="text-lg font-black italic uppercase">GM AGENCY</h1>
                <p id="gpsStatus" class="text-[8px] font-black text-rose-400 uppercase italic">GPS: Waiting...</p>
            </div>
            <div class="text-right bg-blue-600/20 p-3 rounded-2xl border border-blue-500/30">
                <p class="text-[8px] font-black uppercase opacity-70">Today's Booking</p>
                <p class="text-xl font-black text-blue-400 italic">Rs <span id="dayTotalBooked">0</span></p>
            </div>
        </div>
    </div>

    <div class="p-4 max-w-md mx-auto">
        <div id="orderTab" class="tab-content active-tab">
            <div class="bg-white p-6 rounded-[2.5rem] shadow-xl border-2">
                <input id="shopName" placeholder="SHOP NAME" class="w-full p-4 border-2 rounded-2xl mb-3 font-black uppercase outline-none bg-slate-50">
                <div class="relative mb-3">
                    <input id="pSearch" oninput="filterProducts(this.value)" placeholder="SEARCH PRODUCT" class="w-full p-4 border-2 rounded-2xl font-black uppercase outline-none italic bg-blue-50 border-blue-200">
                    <div id="searchList" class="hidden absolute w-full bg-white border-2 rounded-2xl shadow-2xl z-50 max-h-60 overflow-y-auto"></div>
                </div>
                <div class="grid grid-cols-2 gap-2 mb-4">
                    <input id="pPrice" type="number" readonly placeholder="PRICE" class="p-4 border-2 rounded-2xl font-black bg-slate-100 text-center">
                    <input id="pQty" type="number" value="1" class="p-4 border-2 border-blue-200 rounded-2xl font-black text-center">
                </div>
                <button onclick="addToCart()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-black uppercase italic shadow-lg">Add to List</button>
                
                <div id="cartItems" class="mt-4 space-y-2 border-t pt-4"></div>
                
                <div class="mt-4 p-4 bg-slate-900 rounded-2xl text-white font-black flex justify-between uppercase text-sm italic">
                    <span class="text-blue-400">Bill Total:</span><span>Rs <span id="orderTotal">0</span></span>
                </div>
                <button onclick="submitOrder()" class="w-full bg-emerald-600 text-white py-5 rounded-[2rem] font-black uppercase italic text-lg mt-6 shadow-xl">Confirm Order</button>
            </div>
        </div>

        <div id="stockTab" class="tab-content">
            <div class="bg-white p-6 rounded-[2.5rem] shadow-xl border-2">
                <h2 class="font-black text-slate-800 uppercase italic mb-4 text-center border-b pb-2">Stock List</h2>
                <div id="stockList" class="space-y-3"></div>
            </div>
        </div>

        <div id="visitTab" class="tab-content">
            <div class="bg-white p-8 rounded-[2.5rem] shadow-xl border-2 text-center">
                <h3 class="font-black text-slate-800 uppercase italic mb-4 italic uppercase">GPS Verified Photo</h3>
                <input type="file" id="shopPhoto" accept="image/*" capture="camera" class="hidden" onchange="previewPhoto(this)">
                <button onclick="document.getElementById('shopPhoto').click()" class="w-full bg-slate-800 text-white py-5 rounded-2xl font-black uppercase italic mb-4">
                    <i class="fas fa-camera mr-2"></i> Open Camera
                </button>
                <div id="previewContainer" class="hidden">
                    <img id="photoPreview" class="w-full h-64 object-cover rounded-[2rem] border-4 mb-4">
                    <button onclick="sendVisitToWhatsApp()" class="w-full bg-green-500 text-white py-4 rounded-2xl font-black uppercase italic shadow-lg">
                        <i class="fab fa-whatsapp mr-2"></i> Send To Boss
                    </button>
                </div>
            </div>
        </div>
    </div>

    <nav class="fixed bottom-4 left-4 right-4 bg-white/95 shadow-2xl rounded-[2rem] border-2 flex justify-around p-3 z-[100]">
        <button onclick="showTab('orderTab', this)" class="flex flex-col items-center font-black uppercase italic text-[9px] nav-active transition-all"><i class="fas fa-edit text-xl mb-1"></i> Order</button>
        <button onclick="showTab('stockTab', this)" class="flex flex-col items-center text-slate-400 font-black uppercase italic text-[9px] transition-all"><i class="fas fa-boxes text-xl mb-1"></i> Stock</button>
        <button onclick="showTab('visitTab', this)" class="flex flex-col items-center text-slate-400 font-black uppercase italic text-[9px] transition-all"><i class="fas fa-map-marker-alt text-xl mb-1"></i> Visit</button>
    </nav>
</div>

<script>
const firebaseConfig = { apiKey: "AIzaSyBP3VrLzUl5AIR2ca1v871cV-cJOMz-SX0", authDomain: "gm-agency-pos.firebaseapp.com", projectId: "gm-agency-pos", storageBucket: "gm-agency-pos.firebasestorage.app", messagingSenderId: "777771332628", appId: "1:777771332628:web:db60e19d9bdcee21f76301" };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const BOSS_WA = "923066442004";
let userLat = "", userLong = "";
let prods = [], cart = [], allSales = [];

function checkPin() {
    if(document.getElementById('bookerPin').value === "0001") {
        document.getElementById('lockScreen').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        getLocation();
        init();
    }
}

function getLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
            userLat = pos.coords.latitude; userLong = pos.coords.longitude;
            document.getElementById('gpsStatus').innerText = "GPS: Active ‚úì";
            document.getElementById('gpsStatus').classList.replace('text-rose-400', 'text-emerald-400');
        });
    }
}

function init() {
    db.collection("products").onSnapshot(snap => { prods = snap.docs.map(doc => doc.data()); renderStock(); });
    // This part tracks today's booking
    db.collection("sales").where("date", "==", new Date().toLocaleDateString()).onSnapshot(snap => {
        let total = 0;
        snap.forEach(doc => {
            let d = doc.data();
            if(d.customer.includes("(ORDER BOOKER)")) total += Number(d.grandTotal);
        });
        document.getElementById('dayTotalBooked').innerText = total;
    });
}

function showTab(id, btn) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active-tab'));
    document.getElementById(id).classList.add('active-tab');
    document.querySelectorAll('nav button').forEach(b => b.classList.remove('nav-active', 'text-blue-600'));
    btn.classList.add('nav-active');
}

function filterProducts(q) {
    const list = document.getElementById('searchList');
    if(!q) { list.classList.add('hidden'); return; }
    const filtered = prods.filter(p => p.name.toLowerCase().includes(q.toLowerCase()));
    list.innerHTML = filtered.map(p => `<div class="p-4 border-b flex justify-between uppercase font-black text-xs italic" onclick="selectProduct('${p.name}', ${p.price})"><span>${p.name}</span><span class="text-blue-600">Rs ${p.price}</span></div>`).join('');
    list.classList.remove('hidden');
}

function selectProduct(n, p) {
    document.getElementById('pSearch').value = n;
    document.getElementById('pPrice').value = p;
    document.getElementById('searchList').classList.add('hidden');
}

function addToCart() {
    let n = document.getElementById('pSearch').value, p = parseFloat(document.getElementById('pPrice').value), q = parseInt(document.getElementById('pQty').value);
    if(n && q > 0) {
        cart.push({ name: n, price: p, qty: q, subtotal: p*q });
        renderCart();
        document.getElementById('pSearch').value = "";
    }
}

function renderCart() {
    document.getElementById('cartItems').innerHTML = cart.map((i, idx) => `<div class="flex justify-between p-3 bg-slate-50 rounded-xl border text-[10px] font-black uppercase italic"><span>${i.name} (x${i.qty})</span><span>Rs ${i.subtotal} <i onclick="cart.splice(${idx},1); renderCart()" class="fas fa-times text-red-500 ml-2"></i></span></div>`).join('');
    document.getElementById('orderTotal').innerText = cart.reduce((s, i) => s + i.subtotal, 0);
}

async function submitOrder() {
    const shop = document.getElementById('shopName').value.trim();
    if(!shop || !cart.length) return alert("Shop name and items required!");
    
    let orderId = "BOOK-" + Date.now();
    await db.collection("sales").doc(orderId).set({
        id: orderId,
        customer: shop.toUpperCase() + " (ORDER BOOKER)",
        date: new Date().toLocaleDateString(),
        timestamp: Date.now(),
        items: [...cart],
        grandTotal: cart.reduce((s, i) => s + i.subtotal, 0),
        status: "PENDING",
        gps: userLat ? `https://www.google.com/maps?q=${userLat},${userLong}` : "No GPS"
    });
    alert("ORDER BOOKED SUCCESSFULLY!");
    cart = []; renderCart(); document.getElementById('shopName').value = "";
}

function renderStock() {
    document.getElementById('stockList').innerHTML = prods.map(p => `<div class="flex justify-between p-4 bg-slate-50 rounded-xl border italic uppercase font-black text-xs"><span>${p.name}</span><span class="${p.stock < 10 ? 'text-red-600' : 'text-emerald-600'}">STK: ${p.stock}</span></div>`).join('');
}

function previewPhoto(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = e => {
            document.getElementById('photoPreview').src = e.target.result;
            document.getElementById('previewContainer').classList.remove('hidden');
        };
        reader.readAsDataURL(input.files[0]);
    }
}

function sendVisitToWhatsApp() {
    const shop = document.getElementById('shopName').value || "Unnamed Shop";
    const loc = userLat ? `https://www.google.com/maps?q=${userLat},${userLong}` : "GPS NOT ENABLED";
    const msg = `üìç *GM BOOKER VISIT*\nüè™ *Shop:* ${shop.toUpperCase()}\nüó∫Ô∏è *Location:* ${loc}\n‚è∞ *Time:* ${new Date().toLocaleTimeString()}`;
    window.open(`https://wa.me/${BOSS_WA}?text=${encodeURIComponent(msg)}`);
}
</script>
</body>
              </html>
              
